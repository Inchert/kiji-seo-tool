<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCI教育センター SEOキーワード分析ツール v4</title>
    <script>
        // 認証チェック - 未認証の場合はログインページへリダイレクト
        (function() {
            const isAuthenticated = sessionStorage.getItem('authenticated') === 'true';
            const authTime = parseInt(sessionStorage.getItem('authTime') || '0');
            const now = Date.now();
            const isValid = isAuthenticated && (now - authTime < 24 * 60 * 60 * 1000);
            if (!isValid) {
                sessionStorage.removeItem('authenticated');
                sessionStorage.removeItem('authTime');
                window.location.href = 'index.html';
            }
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        * { font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif; }
        .material-symbols-outlined { font-size: 20px; vertical-align: middle; }
        .icon-sm { font-size: 16px; }
        .icon-lg { font-size: 24px; }
        .icon-xl { font-size: 32px; }
        .step-card { transition: all 0.3s; border: 2px solid transparent; }
        .step-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .step-active { border-color: #6366f1; background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); }
        .step-done { border-color: #94a3b8; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); }
        .priority-badge-high { background: linear-gradient(135deg, #4338ca, #3730a3); font-weight: 600; }
        .priority-badge-mid { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .priority-badge-low { background: linear-gradient(135deg, #94a3b8, #64748b); opacity: 0.85; }
        .cluster-card { transition: all 0.2s; cursor: pointer; }
        .cluster-card:hover { transform: scale(1.02); }
        .cluster-card.selected { ring: 3px; ring-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.3); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #4f46e5); transition: all 0.2s; }
        .btn-primary:hover { background: linear-gradient(135deg, #4f46e5, #4338ca); transform: translateY(-1px); }
        .btn-success { background: linear-gradient(135deg, #4f46e5, #4338ca); cursor: pointer; position: relative; z-index: 10; }
        .btn-success:hover { background: linear-gradient(135deg, #4338ca, #3730a3); }
        .glass-card { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        .progress-ring { transition: stroke-dashoffset 0.5s ease; }
        textarea:focus, input:focus, select:focus { outline: none; ring: 2px; ring-color: #a5b4fc; }
        .tooltip { position: relative; }
        .tooltip:hover::after { content: attr(data-tip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; z-index: 50; }
        /* v4 新機能: ドラッグ＆ドロップ */
        .draggable-kw { cursor: grab; transition: all 0.2s; user-select: none; }
        .draggable-kw:active { cursor: grabbing; }
        .draggable-kw.dragging { opacity: 0.5; transform: scale(0.95); }
        .cluster-drop-zone { min-height: 50px; border: 2px dashed transparent; transition: all 0.2s; }
        .cluster-drop-zone.drag-over { border-color: #818cf8; background: rgba(99,102,241,0.1); }
        /* v4 新機能: ヒートマップ */
        .heatmap-cell { transition: all 0.2s; }
        .heatmap-high { background: #4f46e5; color: white; }
        .heatmap-mid { background: #a5b4fc; color: #1e293b; }
        .heatmap-low { background: #cbd5e1; color: #334155; }
        .heatmap-none { background: #f1f5f9; color: #94a3b8; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-indigo-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-6xl">

        <!-- ヘッダー -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2"><span class="text-indigo-600">KCI教育センター</span> SEOキーワード分析ツール <span class="text-sm bg-indigo-500 text-white px-2 py-1 rounded-full ml-2">v4</span></h1>
            <p class="text-gray-600">キーワード分析から記事構成・競合対策まで、SEO記事作成をワンストップで支援</p>
            <p class="text-xs text-gray-400 mt-1">kensetsu-mikata.jp 専用 | 競合対策（SAT対策）・Excel出力・クラスター編集・ヒートマップ・データ保存対応</p>
        </header>

        <!-- サイト情報設定 -->
        <div class="mb-6">
            <button onclick="toggleSiteSettings()" class="flex items-center gap-2 text-xs text-gray-500 hover:text-indigo-600 mx-auto bg-gray-100 hover:bg-indigo-50 rounded-full px-3 py-1 transition-all">
                <span class="material-symbols-outlined" style="font-size:14px;">tune</span>
                サイト設定
            </button>
            <div id="site-settings-panel" class="hidden mt-3 bg-white border border-gray-200 rounded-xl shadow-sm max-w-4xl mx-auto text-sm">
                <div class="p-3 grid grid-cols-2 md:grid-cols-4 gap-2">
                    <input type="text" id="site-name" value="KCI教育センター" class="border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="サイト名">
                    <input type="text" id="site-url" value="https://kensetsu-mikata.jp" class="border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="トップURL">
                    <input type="text" id="site-application-url" value="https://kensetsu-mikata.jp/application/" class="border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="申込URL">
                    <input type="text" id="site-course-url" value="https://kensetsu-mikata.jp/course/" class="border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="講座URL">
                </div>
                <div class="px-3 pb-2">
                    <input type="text" id="site-features" value="オンライン対応, eラーニング, 最短1日修了証, 全国対応" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="強み（カンマ区切り）">
                </div>
                <details class="border-t">
                    <summary class="px-3 py-2 bg-gray-50 cursor-pointer text-xs text-gray-500 hover:bg-gray-100">詳細設定</summary>
                    <div class="p-3 grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                        <input type="text" id="site-phone" value="0120-919-749" class="border rounded px-2 py-1" placeholder="電話番号">
                        <input type="text" id="site-company-name" value="株式会社manebi" class="border rounded px-2 py-1" placeholder="運営会社">
                        <input type="text" id="site-business-hours" value="平日 8:00-17:00" class="border rounded px-2 py-1" placeholder="営業時間">
                        <input type="text" id="site-tagline" value="建設業向け安全教育" class="border rounded px-2 py-1" placeholder="キャッチコピー">
                        <input type="text" id="site-elearning-url" class="border rounded px-2 py-1" placeholder="eラーニングURL">
                        <input type="number" id="site-course-count" value="29" class="border rounded px-2 py-1" placeholder="講座数">
                        <input type="number" id="site-company-count" value="1000" class="border rounded px-2 py-1" placeholder="導入企業数">
                        <input type="number" id="site-user-count" value="10000" class="border rounded px-2 py-1" placeholder="受講者数">
                    </div>
                </details>
                <div class="px-3 py-2 bg-gray-50 border-t flex justify-end">
                    <button onclick="saveSiteSettings()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-xs">保存</button>
                </div>
            </div>
        </div>

        <!-- ステップインジケーター -->
        <div class="flex justify-center gap-2 mb-8 flex-wrap">
            <div id="step-indicator-1" class="flex items-center gap-2 px-4 py-2 rounded-full bg-indigo-600 text-white text-sm font-medium">
                <span class="w-6 h-6 rounded-full bg-white text-indigo-600 flex items-center justify-center text-xs font-bold">1</span>
                データ入力
            </div>
            <div class="flex items-center text-gray-300">→</div>
            <div id="step-indicator-2" class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-200 text-gray-500 text-sm font-medium">
                <span class="w-6 h-6 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-xs font-bold">2</span>
                分析結果
            </div>
            <div class="flex items-center text-gray-300">→</div>
            <div id="step-indicator-3" class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-200 text-gray-500 text-sm font-medium">
                <span class="w-6 h-6 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-xs font-bold">3</span>
                記事設計
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div id="main-content">

            <!-- STEP 1: データ入力 -->
            <div id="step-1" class="fade-in">
                <div class="glass-card rounded-2xl shadow-xl p-8 mb-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold">1</div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">キーワードデータを入力</h2>
                            <p class="text-sm text-gray-500">ラッコキーワード → キーワードプランナー → CSV取り込み</p>
                        </div>
                    </div>

                    <!-- ビッグキーワード候補（STEP 0） -->
                    <div class="bg-gradient-to-r from-indigo-50 to-slate-50 border-2 border-indigo-300 rounded-xl p-5 mb-6">
                        <h3 class="font-bold text-indigo-800 mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined icon-lg">target</span>
                            STEP 0：検索すべきビッグキーワードを確認
                        </h3>
                        <p class="text-xs text-slate-700 mb-4">教育テーマを選ぶと、ラッコキーワードで検索すべきキーワードバリエーションが表示されます。全てのバリエーションで検索すると、関連キーワードを漏れなく取得できます。</p>

                        <!-- テーマ選択 -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-indigo-800 mb-2">教育テーマを選択</label>
                            <select id="big-keyword-theme" onchange="showBigKeywordVariations()" class="w-full p-3 border-2 border-indigo-200 rounded-lg bg-white text-sm">
                                <option value="">-- テーマを選んでください --</option>
                                <optgroup label="優先度：高（検索ボリューム大）">
                                    <option value="職長">職長・安全衛生責任者教育</option>
                                    <option value="能力向上">能力向上教育（職長・安責の再教育）</option>
                                    <option value="フルハーネス">フルハーネス型墜落制止用器具特別教育</option>
                                    <option value="足場">足場の組立て等特別教育</option>
                                </optgroup>
                                <optgroup label="優先度：中">
                                    <option value="酸欠">酸素欠乏・硫化水素危険作業特別教育</option>
                                    <option value="低圧電気">低圧電気取扱特別教育</option>
                                    <option value="粉じん">粉じん作業特別教育</option>
                                    <option value="石綿">石綿使用建築物等解体等業務特別教育</option>
                                    <option value="有機溶剤">有機溶剤取扱業務特別教育</option>
                                    <option value="高所作業車">高所作業車運転特別教育（10m未満）</option>
                                    <option value="クレーン">クレーン取扱い業務特別教育</option>
                                    <option value="移動式クレーン">移動式クレーン運転特別教育（1トン未満）</option>
                                    <option value="アーク溶接">アーク溶接等作業特別教育</option>
                                    <option value="小型車両系">小型車両系建設機械運転特別教育</option>
                                    <option value="ショベルローダー">ショベルローダー等運転特別教育（1トン未満）</option>
                                    <option value="玉掛け">玉掛け業務特別教育</option>
                                </optgroup>
                                <optgroup label="優先度：低">
                                    <option value="丸のこ">丸のこ等取扱い作業者安全衛生教育</option>
                                    <option value="研削砥石">研削といし取替え・試運転特別教育</option>
                                    <option value="刈払機">刈払機取扱作業者安全衛生教育</option>
                                    <option value="振動工具">振動工具取扱作業者安全衛生教育</option>
                                    <option value="熱中症">熱中症予防教育</option>
                                    <option value="ロープ高所">ロープ高所作業特別教育（ブランコ作業）</option>
                                    <option value="巻上げ機">巻上げ機運転特別教育</option>
                                    <option value="テールゲート">テールゲートリフター操作特別教育</option>
                                    <option value="不整地運搬車">不整地運搬車運転特別教育（1トン未満）</option>
                                    <option value="ローラー">ローラー運転特別教育</option>
                                    <option value="除染">除染等業務特別教育</option>
                                </optgroup>
                            </select>
                        </div>

                        <!-- キーワードバリエーション表示エリア -->
                        <div id="big-keyword-variations" class="hidden">
                            <div class="bg-white rounded-lg p-4 border border-indigo-200">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 id="big-keyword-theme-name" class="font-bold text-gray-800"></h4>
                                    <span id="big-keyword-total-volume" class="text-xs bg-slate-100 text-indigo-800 px-2 py-1 rounded-full"></span>
                                </div>
                                <p class="text-xs text-gray-500 mb-3">以下のキーワードを全てラッコキーワードで検索してください：</p>
                                <div id="big-keyword-list" class="space-y-2"></div>
                                <div class="mt-4 pt-4 border-t border-gray-200 flex gap-2">
                                    <button type="button" onclick="copyBigKeywords()" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                        全キーワードをコピー
                                    </button>
                                    <a href="https://related-keywords.com/" target="_blank" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold text-center">
                                        ラッコキーワードを開く
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CSVファイル選択エリア -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">キーワードプランナーCSVファイル</label>
                        <div id="csv-dropzone" class="w-full h-40 border-2 border-dashed border-indigo-300 rounded-xl flex flex-col items-center justify-center bg-indigo-50 hover:bg-indigo-100 cursor-pointer transition-colors">
                            <svg class="w-12 h-12 text-indigo-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="text-indigo-700 font-medium">CSVファイルをドロップ、またはクリックして選択</p>
                            <p class="text-indigo-600 text-xs mt-1">キーワードプランナーからダウンロードした「過去のプラン指標.csv」</p>
                            <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                        </div>
                        <div id="csv-file-info" class="hidden mt-4 p-4 bg-indigo-100 rounded-xl">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    <div>
                                        <p id="csv-filename" class="font-medium text-indigo-800">ファイル名</p>
                                        <p id="csv-rowcount" class="text-sm text-indigo-600">0行</p>
                                    </div>
                                </div>
                                <button type="button" onclick="clearCSVFile()" class="text-slate-500 hover:text-slate-700">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- または簡易モード -->
                    <div class="border-t border-gray-200 pt-6 mt-6">
                        <details class="group">
                            <summary class="cursor-pointer text-sm text-gray-500 hover:text-gray-700 flex items-center gap-2">
                                <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                CSVがない場合（推定ボリュームで分析）
                            </summary>
                            <div class="mt-4">
                                <textarea id="keyword-input" class="w-full h-48 p-4 border-2 border-gray-200 rounded-xl text-sm focus:border-indigo-500 resize-none" placeholder="ラッコキーワードからコピーしたキーワードを貼り付け（1行に1キーワード）

例：
職長教育
職長教育 オンライン
職長教育 費用
..."></textarea>
                                <p class="text-xs text-gray-500 mt-2">※ボリュームは推定値が自動で割り当てられます（精度は低め）</p>
                            </div>
                        </details>
                    </div>

                    <!-- 地域キーワード展開 -->
                    <div class="border-t border-gray-200 pt-6 mt-6">
                        <details class="group" id="region-keyword-section">
                            <summary class="cursor-pointer text-sm font-semibold text-indigo-600 hover:text-indigo-800 flex items-center gap-2">
                                <span class="material-symbols-outlined icon-sm transition-transform group-open:rotate-90">chevron_right</span>
                                <span class="material-symbols-outlined icon-sm">location_on</span>
                                地域キーワードを一括展開
                            </summary>
                            <div class="mt-4 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl p-5">
                                <p class="text-xs text-amber-800 mb-4">
                                    <span class="material-symbols-outlined icon-sm align-middle">info</span>
                                    ベースキーワード×地域で一括展開し、ローカルSEO用のキーワードを生成します。
                                </p>

                                <!-- ベースキーワード入力 -->
                                <div class="mb-4">
                                    <label class="block text-sm font-semibold text-amber-800 mb-2">ベースキーワード</label>
                                    <input type="text" id="region-base-keyword" class="w-full p-3 border-2 border-amber-200 rounded-lg bg-white text-sm" placeholder="例：フォークリフト免許">
                                    <p class="text-xs text-amber-600 mt-1">※複数ある場合は改行で区切ってください</p>
                                </div>

                                <!-- エリア選択 -->
                                <div class="mb-4">
                                    <label class="block text-sm font-semibold text-amber-800 mb-2">展開する地域を選択</label>

                                    <!-- エリア一括選択 -->
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        <button type="button" onclick="selectRegionArea('all')" class="px-3 py-1 text-xs bg-amber-500 text-white rounded-full hover:bg-amber-600">全国</button>
                                        <button type="button" onclick="selectRegionArea('hokkaido-tohoku')" class="px-3 py-1 text-xs bg-amber-100 text-amber-800 rounded-full hover:bg-amber-200">北海道・東北</button>
                                        <button type="button" onclick="selectRegionArea('kanto')" class="px-3 py-1 text-xs bg-amber-100 text-amber-800 rounded-full hover:bg-amber-200">関東</button>
                                        <button type="button" onclick="selectRegionArea('chubu')" class="px-3 py-1 text-xs bg-amber-100 text-amber-800 rounded-full hover:bg-amber-200">中部</button>
                                        <button type="button" onclick="selectRegionArea('kinki')" class="px-3 py-1 text-xs bg-amber-100 text-amber-800 rounded-full hover:bg-amber-200">近畿</button>
                                        <button type="button" onclick="selectRegionArea('chugoku-shikoku')" class="px-3 py-1 text-xs bg-amber-100 text-amber-800 rounded-full hover:bg-amber-200">中国・四国</button>
                                        <button type="button" onclick="selectRegionArea('kyushu')" class="px-3 py-1 text-xs bg-amber-100 text-amber-800 rounded-full hover:bg-amber-200">九州・沖縄</button>
                                        <button type="button" onclick="selectRegionArea('none')" class="px-3 py-1 text-xs bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300">クリア</button>
                                    </div>

                                    <!-- 都道府県チェックボックス -->
                                    <div class="bg-white rounded-lg p-3 border border-amber-200 max-h-48 overflow-y-auto">
                                        <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-1 text-xs" id="prefecture-checkboxes">
                                            <!-- 北海道・東北 -->
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="hokkaido-tohoku"><input type="checkbox" class="region-pref" value="北海道"> 北海道</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="hokkaido-tohoku"><input type="checkbox" class="region-pref" value="青森"> 青森</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="hokkaido-tohoku"><input type="checkbox" class="region-pref" value="岩手"> 岩手</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="hokkaido-tohoku"><input type="checkbox" class="region-pref" value="宮城"> 宮城</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="hokkaido-tohoku"><input type="checkbox" class="region-pref" value="秋田"> 秋田</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="hokkaido-tohoku"><input type="checkbox" class="region-pref" value="山形"> 山形</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="hokkaido-tohoku"><input type="checkbox" class="region-pref" value="福島"> 福島</label>
                                            <!-- 関東 -->
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kanto"><input type="checkbox" class="region-pref" value="茨城"> 茨城</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kanto"><input type="checkbox" class="region-pref" value="栃木"> 栃木</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kanto"><input type="checkbox" class="region-pref" value="群馬"> 群馬</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kanto"><input type="checkbox" class="region-pref" value="埼玉"> 埼玉</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kanto"><input type="checkbox" class="region-pref" value="千葉"> 千葉</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kanto"><input type="checkbox" class="region-pref" value="東京"> 東京</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kanto"><input type="checkbox" class="region-pref" value="神奈川"> 神奈川</label>
                                            <!-- 中部 -->
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chubu"><input type="checkbox" class="region-pref" value="新潟"> 新潟</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chubu"><input type="checkbox" class="region-pref" value="富山"> 富山</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chubu"><input type="checkbox" class="region-pref" value="石川"> 石川</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chubu"><input type="checkbox" class="region-pref" value="福井"> 福井</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chubu"><input type="checkbox" class="region-pref" value="山梨"> 山梨</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chubu"><input type="checkbox" class="region-pref" value="長野"> 長野</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chubu"><input type="checkbox" class="region-pref" value="岐阜"> 岐阜</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chubu"><input type="checkbox" class="region-pref" value="静岡"> 静岡</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chubu"><input type="checkbox" class="region-pref" value="愛知"> 愛知</label>
                                            <!-- 近畿 -->
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kinki"><input type="checkbox" class="region-pref" value="三重"> 三重</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kinki"><input type="checkbox" class="region-pref" value="滋賀"> 滋賀</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kinki"><input type="checkbox" class="region-pref" value="京都"> 京都</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kinki"><input type="checkbox" class="region-pref" value="大阪"> 大阪</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kinki"><input type="checkbox" class="region-pref" value="兵庫"> 兵庫</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kinki"><input type="checkbox" class="region-pref" value="奈良"> 奈良</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kinki"><input type="checkbox" class="region-pref" value="和歌山"> 和歌山</label>
                                            <!-- 中国・四国 -->
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chugoku-shikoku"><input type="checkbox" class="region-pref" value="鳥取"> 鳥取</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chugoku-shikoku"><input type="checkbox" class="region-pref" value="島根"> 島根</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chugoku-shikoku"><input type="checkbox" class="region-pref" value="岡山"> 岡山</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chugoku-shikoku"><input type="checkbox" class="region-pref" value="広島"> 広島</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chugoku-shikoku"><input type="checkbox" class="region-pref" value="山口"> 山口</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chugoku-shikoku"><input type="checkbox" class="region-pref" value="徳島"> 徳島</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chugoku-shikoku"><input type="checkbox" class="region-pref" value="香川"> 香川</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chugoku-shikoku"><input type="checkbox" class="region-pref" value="愛媛"> 愛媛</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="chugoku-shikoku"><input type="checkbox" class="region-pref" value="高知"> 高知</label>
                                            <!-- 九州・沖縄 -->
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kyushu"><input type="checkbox" class="region-pref" value="福岡"> 福岡</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kyushu"><input type="checkbox" class="region-pref" value="佐賀"> 佐賀</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kyushu"><input type="checkbox" class="region-pref" value="長崎"> 長崎</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kyushu"><input type="checkbox" class="region-pref" value="熊本"> 熊本</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kyushu"><input type="checkbox" class="region-pref" value="大分"> 大分</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kyushu"><input type="checkbox" class="region-pref" value="宮崎"> 宮崎</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kyushu"><input type="checkbox" class="region-pref" value="鹿児島"> 鹿児島</label>
                                            <label class="flex items-center gap-1 p-1 hover:bg-amber-50 rounded cursor-pointer" data-area="kyushu"><input type="checkbox" class="region-pref" value="沖縄"> 沖縄</label>
                                        </div>
                                    </div>
                                    <p class="text-xs text-amber-600 mt-2" id="region-selected-count">選択中: 0都道府県</p>
                                </div>

                                <!-- 展開オプション -->
                                <div class="mb-4">
                                    <label class="block text-sm font-semibold text-amber-800 mb-2">展開パターン</label>
                                    <div class="flex flex-wrap gap-3">
                                        <label class="flex items-center gap-2 text-sm text-amber-800 cursor-pointer">
                                            <input type="checkbox" id="region-pattern-1" checked class="rounded border-amber-300 text-amber-600">
                                            <code class="bg-white px-1 rounded text-xs">{キーワード} {地域}</code>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm text-amber-800 cursor-pointer">
                                            <input type="checkbox" id="region-pattern-2" class="rounded border-amber-300 text-amber-600">
                                            <code class="bg-white px-1 rounded text-xs">{地域} {キーワード}</code>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm text-amber-800 cursor-pointer">
                                            <input type="checkbox" id="region-pattern-3" class="rounded border-amber-300 text-amber-600">
                                            <code class="bg-white px-1 rounded text-xs">{キーワード} {地域}で</code>
                                        </label>
                                    </div>
                                </div>

                                <!-- 生成ボタンと結果 -->
                                <div class="flex gap-2">
                                    <button type="button" onclick="expandRegionKeywords()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center justify-center gap-2">
                                        <span class="material-symbols-outlined icon-sm">auto_awesome</span>
                                        キーワードを展開
                                    </button>
                                    <button type="button" onclick="copyExpandedKeywords()" id="copy-expanded-btn" class="hidden bg-amber-100 hover:bg-amber-200 text-amber-800 px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2">
                                        <span class="material-symbols-outlined icon-sm">content_copy</span>
                                        コピー
                                    </button>
                                </div>

                                <!-- 展開結果 -->
                                <div id="expanded-keywords-result" class="hidden mt-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-semibold text-amber-800">展開結果</span>
                                        <span id="expanded-keywords-count" class="text-xs bg-amber-200 text-amber-800 px-2 py-1 rounded-full"></span>
                                    </div>
                                    <textarea id="expanded-keywords-textarea" class="w-full h-32 p-3 border-2 border-amber-200 rounded-lg bg-white text-sm resize-none" readonly></textarea>
                                    <p class="text-xs text-amber-600 mt-2">
                                        <span class="material-symbols-outlined icon-sm align-middle">lightbulb</span>
                                        このキーワードをキーワードプランナーに貼り付けて検索ボリュームを取得し、CSVでダウンロードしてください
                                    </p>
                                </div>
                            </div>
                        </details>
                    </div>

                    <!-- 分析ボタン -->
                    <div class="flex flex-col sm:flex-row gap-4 justify-between items-center mt-6">
                        <button type="button" onclick="loadSampleData()" class="text-sm text-gray-500 hover:text-indigo-600 underline cursor-pointer">サンプルデータで試す</button>
                        <button type="button" onclick="startAnalysis()" class="btn-primary text-white px-8 py-3 rounded-xl font-semibold shadow-lg flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            分析開始
                        </button>
                    </div>
                </div>
            </div>

            <!-- STEP 2: 分析結果 -->
            <div id="step-2" class="hidden fade-in">
                <div class="glass-card rounded-2xl shadow-xl p-8 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-600 text-white flex items-center justify-center font-bold">2</div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">分析結果</h2>
                                <p class="text-sm text-gray-500">キーワードが自動でグループ分けされました</p>
                            </div>
                        </div>
                        <button type="button" onclick="goToStep(1)" class="text-sm text-gray-500 hover:text-indigo-600 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            戻る
                        </button>
                    </div>

                    <!-- サマリー -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-indigo-600 to-indigo-700 rounded-xl p-4 text-white text-center shadow-lg">
                            <div class="text-3xl font-bold" id="summary-keywords">0</div>
                            <div class="text-sm opacity-90">キーワード数</div>
                        </div>
                        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl p-4 text-white text-center shadow-md">
                            <div class="text-3xl font-bold" id="summary-clusters">0</div>
                            <div class="text-sm opacity-90">グループ数</div>
                        </div>
                        <div class="bg-gradient-to-br from-indigo-400 to-indigo-500 rounded-xl p-4 text-white text-center shadow-md">
                            <div class="text-3xl font-bold" id="summary-articles">0</div>
                            <div class="text-sm opacity-90">推奨記事数</div>
                        </div>
                        <div class="bg-gradient-to-br from-slate-500 to-slate-600 rounded-xl p-4 text-white text-center shadow-md">
                            <div class="text-3xl font-bold" id="summary-priority">0</div>
                            <div class="text-sm opacity-90">高優先グループ</div>
                        </div>
                    </div>

                    <!-- 競合対策サマリー（SAT対策） -->
                    <div class="bg-gradient-to-r from-slate-50 to-indigo-50 border border-indigo-200 rounded-xl p-5 mb-8 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-indigo-800 flex items-center gap-2">
                                <span class="material-symbols-outlined text-indigo-600">strategy</span>
                                競合対策サマリー
                                <span class="text-xs bg-amber-500 text-white px-2 py-0.5 rounded-full font-normal">SAT対策</span>
                            </h3>
                            <button onclick="document.getElementById('layer-info').classList.toggle('hidden')" class="text-xs text-indigo-500 hover:text-indigo-700 flex items-center gap-1 bg-white px-2 py-1 rounded-lg border border-indigo-200 hover:bg-indigo-50 transition">
                                <span class="material-symbols-outlined" style="font-size:14px;">help</span>
                                3層戦略とは
                            </button>
                        </div>
                        <div id="strategy-summary">
                            <!-- 動的に生成 -->
                        </div>
                        <!-- 3層戦略の説明（トグル表示） -->
                        <div id="layer-info" class="hidden mt-4 pt-4 border-t border-indigo-200">
                            <div class="grid md:grid-cols-3 gap-3">
                                <div class="bg-white rounded-xl p-3 border-2 border-gray-200 shadow-sm">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="w-7 h-7 rounded-lg bg-gray-100 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-gray-600" style="font-size:18px;">menu_book</span>
                                        </span>
                                        <span class="font-bold text-gray-700">A層：制度解説系</span>
                                    </div>
                                    <p class="text-xs text-gray-500 leading-relaxed">「〜とは」「義務」など基礎情報。競合と同等の土台作り。SEOの基盤となる記事。</p>
                                </div>
                                <div class="bg-white rounded-xl p-3 border-2 border-blue-200 shadow-sm">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="w-7 h-7 rounded-lg bg-blue-100 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-600" style="font-size:18px;">factory</span>
                                        </span>
                                        <span class="font-bold text-blue-700">B層：業種特化系</span>
                                    </div>
                                    <p class="text-xs text-gray-500 leading-relaxed">「建設業の〜」など業種別コンテンツ。SATにない切り口で差別化を図る。</p>
                                </div>
                                <div class="bg-white rounded-xl p-3 border-2 border-green-200 shadow-sm">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="w-7 h-7 rounded-lg bg-green-100 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-green-600" style="font-size:18px;">record_voice_over</span>
                                        </span>
                                        <span class="font-bold text-green-700">C層：体験・事例系</span>
                                    </div>
                                    <p class="text-xs text-gray-500 leading-relaxed">受講者の声、失敗談など一次情報。AIでは書けない最大の差別化ポイント。</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- グループ一覧 -->
                    <h3 class="font-bold text-gray-700 mb-4">グループ一覧 <span class="text-sm font-normal text-gray-500">（クリックで記事設計へ）</span></h3>
                    <div id="cluster-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <!-- 動的に生成 -->
                    </div>

                    <!-- 優先度TOP20 -->
                    <h3 class="font-bold text-gray-700 mb-4">優先度TOP20キーワード</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-3 text-left rounded-tl-lg">順位</th>
                                    <th class="p-3 text-left">キーワード</th>
                                    <th class="p-3 text-center">推定Vol</th>
                                    <th class="p-3 text-center">層</th>
                                    <th class="p-3 text-center">対策</th>
                                    <th class="p-3 text-center">検索意図</th>
                                    <th class="p-3 text-center">CV期待</th>
                                    <th class="p-3 text-center rounded-tr-lg">一次情報</th>
                                </tr>
                            </thead>
                            <tbody id="priority-table">
                                <!-- 動的に生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- エクスポートボタン（v4拡張） -->
                <div class="flex flex-wrap justify-center gap-3 mb-6">
                    <button type="button" onclick="openExportModal()" class="bg-slate-600 hover:bg-slate-700 text-white px-6 py-2 rounded-lg text-sm flex items-center gap-2 font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        エクスポート
                    </button>
                    <button type="button" onclick="openImportModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm flex items-center gap-2 font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        インポート
                    </button>
                    <button type="button" onclick="exportCSV()" class="bg-white border border-gray-300 px-6 py-2 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        CSV出力
                    </button>
                    <button type="button" onclick="saveData()" class="bg-white border border-gray-300 px-6 py-2 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        保存
                    </button>
                    <button type="button" onclick="openClusterEditModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm flex items-center gap-2 font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        クラスター編集
                    </button>
                </div>
            </div>

            <!-- STEP 3: 記事設計（競合分析タブ含む） -->
            <div id="step-3" class="hidden fade-in">
                <div class="glass-card rounded-2xl shadow-xl p-8 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold">3</div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">記事設計</h2>
                                <p class="text-sm text-gray-500" id="selected-cluster-name">グループを選択してください</p>
                            </div>
                        </div>
                        <button type="button" onclick="goToStep(2)" class="text-sm text-gray-500 hover:text-indigo-600 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            結果に戻る
                        </button>
                    </div>

                    <!-- 構成作成 -->
                    <div id="article-main-tab-design">

                    <!-- 記事タイプ選択 -->
                    <div class="mb-6">
                        <label class="block font-semibold text-gray-700 mb-3">記事タイプを選択</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            <label class="cursor-pointer">
                                <input type="radio" name="article-type" value="pillar" checked class="hidden peer">
                                <div class="p-3 border-2 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 hover:bg-gray-50 h-full">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-sm text-indigo-700"><span class="material-symbols-outlined icon-sm">menu_book</span> ピラー記事</div>
                                        <span class="text-[10px] px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-medium">Know</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">総合ガイド・完全解説</div>
                                    <div class="text-xs text-indigo-600 mt-2 font-medium">効果: SEO基盤構築、内部リンクのハブ</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="article-type" value="howto" class="hidden peer">
                                <div class="p-3 border-2 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 hover:bg-gray-50 h-full">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-sm text-indigo-700"><span class="material-symbols-outlined icon-sm">list_alt</span> ハウツー</div>
                                        <span class="text-[10px] px-1.5 py-0.5 bg-green-100 text-green-700 rounded font-medium">Do</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">手順解説・申込み方法</div>
                                    <div class="text-xs text-indigo-600 mt-2 font-medium">効果: 申込導線に直結、CV率高</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="article-type" value="comparison" class="hidden peer">
                                <div class="p-3 border-2 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 hover:bg-gray-50 h-full">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-sm text-indigo-700"><span class="material-symbols-outlined icon-sm">trophy</span> 選び方ガイド</div>
                                        <span class="text-[10px] px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded font-medium">Buy</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">講座紹介・自社推し</div>
                                    <div class="text-xs text-indigo-600 mt-2 font-medium">効果: 比較検討層を獲得、差別化</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="article-type" value="faq" class="hidden peer">
                                <div class="p-3 border-2 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 hover:bg-gray-50 h-full">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-sm text-indigo-700"><span class="material-symbols-outlined icon-sm">help</span> FAQ形式</div>
                                        <span class="text-[10px] px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-medium">Know</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">Q&A・よくある質問</div>
                                    <div class="text-xs text-indigo-600 mt-2 font-medium">効果: 強調スニペット獲得、音声検索対応</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="article-type" value="case" class="hidden peer">
                                <div class="p-3 border-2 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 hover:bg-gray-50 h-full">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-sm text-indigo-700"><span class="material-symbols-outlined icon-sm">work</span> 事例・体験談</div>
                                        <span class="text-[10px] px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded font-medium">Buy</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">受講者の声・活用事例</div>
                                    <div class="text-xs text-indigo-600 mt-2 font-medium">効果: 信頼性UP、E-E-A-T強化</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="article-type" value="glossary" class="hidden peer">
                                <div class="p-3 border-2 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 hover:bg-gray-50 h-full">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-sm text-indigo-700"><span class="material-symbols-outlined icon-sm">dictionary</span> 用語解説</div>
                                        <span class="text-[10px] px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-medium">Know</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">〇〇とは・基礎知識</div>
                                    <div class="text-xs text-indigo-600 mt-2 font-medium">効果: 検索流入増、初心者獲得</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="article-type" value="checklist" class="hidden peer">
                                <div class="p-3 border-2 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 hover:bg-gray-50 h-full">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-sm text-indigo-700"><span class="material-symbols-outlined icon-sm">checklist</span> チェックリスト</div>
                                        <span class="text-[10px] px-1.5 py-0.5 bg-green-100 text-green-700 rounded font-medium">Do</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">準備・持ち物・確認事項</div>
                                    <div class="text-xs text-indigo-600 mt-2 font-medium">効果: 実用性高、ブックマーク獲得</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="article-type" value="news" class="hidden peer">
                                <div class="p-3 border-2 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 hover:bg-gray-50 h-full">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-sm text-indigo-700"><span class="material-symbols-outlined icon-sm">newspaper</span> 法改正・ニュース</div>
                                        <span class="text-[10px] px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-medium">Know</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">最新情報・制度変更</div>
                                    <div class="text-xs text-indigo-600 mt-2 font-medium">効果: 専門性アピール、リピーター獲得</div>
                                </div>
                            </label>
                        </div>
                        <!-- 記事タイプ効果サマリー -->
                        <div class="mt-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-xs text-indigo-800">
                            <div class="mb-2">
                                <strong><span class="material-symbols-outlined icon-sm">search</span> クエリタイプ：</strong>
                                <span class="inline-flex items-center gap-1 ml-1"><span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px] font-medium">Know</span>情報を知りたい</span>
                                <span class="inline-flex items-center gap-1 ml-2"><span class="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-[10px] font-medium">Do</span>行動したい</span>
                                <span class="inline-flex items-center gap-1 ml-2"><span class="px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded text-[10px] font-medium">Buy</span>比較・購入検討</span>
                            </div>
                            <strong><span class="material-symbols-outlined icon-sm">lightbulb</span> 選び方のコツ：</strong>
                            CV重視なら<span class="px-1 bg-green-100 text-green-700 rounded">Do</span><span class="px-1 bg-orange-100 text-orange-700 rounded">Buy</span>、SEO基盤なら<span class="px-1 bg-blue-100 text-blue-700 rounded">Know</span>がおすすめ
                        </div>
                    </div>

                    <!-- 競合分析（任意） -->
                    <div class="mb-6">
                        <div class="border border-gray-200 rounded-xl overflow-hidden">
                            <button type="button" onclick="toggleCompetitorSection()" class="w-full p-4 bg-gray-50 hover:bg-gray-100 flex items-center justify-between text-left">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-gray-600">compare_arrows</span>
                                    <span class="font-semibold text-gray-700">競合分析（任意）</span>
                                    <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded">SEOツールから分析</span>
                                </div>
                                <span id="competitor-toggle-icon" class="material-symbols-outlined text-gray-400">expand_more</span>
                            </button>
                            <div id="competitor-section" class="hidden p-4 border-t border-gray-200">
                                <!-- 分析モード切り替えタブ -->
                                <div class="flex border-b border-gray-200 mb-4">
                                    <button type="button" onclick="switchCompetitorMode('site')" id="comp-mode-site" class="px-4 py-2 text-sm font-medium border-b-2 border-indigo-500 text-indigo-600 -mb-px">
                                        <span class="material-symbols-outlined icon-sm">domain</span> 競合サイト分析
                                    </button>
                                    <button type="button" onclick="switchCompetitorMode('serp')" id="comp-mode-serp" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 -mb-px">
                                        <span class="material-symbols-outlined icon-sm">format_list_numbered</span> 検索上位20位分析
                                    </button>
                                </div>

                                <!-- 競合サイト分析モード -->
                                <div id="comp-site-mode" class="mb-4">
                                    <p class="text-sm text-gray-600 mb-3">SEOツールからエクスポートしたCSVファイルをアップロードして競合分析を行います。</p>

                                    <!-- ファイルアップロードエリア -->
                                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                                        <!-- Semrush用 -->
                                        <div class="border-2 border-dashed border-orange-300 rounded-xl p-4 bg-orange-50">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-orange-600 font-bold">Semrush</span>
                                                    <a href="https://www.semrush.com/" target="_blank" class="text-xs text-orange-500 hover:underline flex items-center gap-1">
                                                        <span class="material-symbols-outlined icon-sm">open_in_new</span>
                                                    </a>
                                                </div>
                                                <button onclick="document.getElementById('semrush-help').classList.toggle('hidden')" class="text-xs text-orange-500 hover:text-orange-700 flex items-center gap-1">
                                                    <span class="material-symbols-outlined icon-sm">help</span> 取得方法
                                                </button>
                                            </div>
                                            <div id="semrush-help" class="hidden mb-3 p-2 bg-orange-100 rounded text-xs text-orange-800">
                                                <p class="font-bold mb-1">CSVの取得手順：</p>
                                                <ol class="list-decimal list-inside space-y-1">
                                                    <li>Semrushにログイン</li>
                                                    <li>左メニュー「Organic Research」をクリック</li>
                                                    <li>競合サイトのURLを入力して検索</li>
                                                    <li>「Pages」タブを選択</li>
                                                    <li>右上の「Export」→「CSV」をクリック</li>
                                                </ol>
                                                <p class="mt-2 text-orange-600">※ URLとTitle列が含まれるCSVを出力</p>
                                            </div>
                                            <div id="semrush-dropzone" class="cursor-pointer hover:bg-orange-100 rounded-lg p-3 text-center transition-colors">
                                                <span class="material-symbols-outlined text-orange-400 text-3xl">upload_file</span>
                                                <p class="text-sm text-orange-700 mt-1">CSVをドロップまたはクリック</p>
                                                <input type="file" id="semrush-file-input" accept=".csv" class="hidden">
                                            </div>
                                            <div id="semrush-file-status" class="hidden mt-2 text-xs text-orange-700"></div>
                                        </div>

                                        <!-- Ahrefs用 -->
                                        <div class="border-2 border-dashed border-blue-300 rounded-xl p-4 bg-blue-50">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-blue-600 font-bold">Ahrefs</span>
                                                    <a href="https://ahrefs.com/" target="_blank" class="text-xs text-blue-500 hover:underline flex items-center gap-1">
                                                        <span class="material-symbols-outlined icon-sm">open_in_new</span>
                                                    </a>
                                                </div>
                                                <button onclick="document.getElementById('ahrefs-help').classList.toggle('hidden')" class="text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1">
                                                    <span class="material-symbols-outlined icon-sm">help</span> 取得方法
                                                </button>
                                            </div>
                                            <div id="ahrefs-help" class="hidden mb-3 p-2 bg-blue-100 rounded text-xs text-blue-800">
                                                <p class="font-bold mb-1">CSVの取得手順：</p>
                                                <ol class="list-decimal list-inside space-y-1">
                                                    <li>Ahrefsにログイン</li>
                                                    <li>「Site Explorer」で競合サイトURLを入力</li>
                                                    <li>左メニュー「Top pages」をクリック</li>
                                                    <li>フィルタでターゲットKWを含むページに絞る</li>
                                                    <li>右上「Export」→「CSV」をクリック</li>
                                                </ol>
                                                <p class="mt-2 text-blue-600">※ URLとTitle列が含まれるCSVを出力</p>
                                            </div>
                                            <div id="ahrefs-dropzone" class="cursor-pointer hover:bg-blue-100 rounded-lg p-3 text-center transition-colors">
                                                <span class="material-symbols-outlined text-blue-400 text-3xl">upload_file</span>
                                                <p class="text-sm text-blue-700 mt-1">CSVをドロップまたはクリック</p>
                                                <input type="file" id="ahrefs-file-input" accept=".csv" class="hidden">
                                            </div>
                                            <div id="ahrefs-file-status" class="hidden mt-2 text-xs text-blue-700"></div>
                                        </div>
                                    </div>

                                    <!-- 読み込まれた競合データプレビュー -->
                                    <div id="competitor-data-preview" class="hidden mb-4 p-3 bg-gray-50 rounded-lg">
                                        <h4 class="font-semibold text-gray-700 text-sm mb-2">読み込まれたデータ</h4>
                                        <div id="competitor-preview-content" class="text-sm text-gray-600"></div>
                                    </div>

                                    <!-- 手動入力オプション（折りたたみ） -->
                                    <details class="mb-4">
                                        <summary class="text-sm text-gray-500 cursor-pointer hover:text-gray-700">手動で入力する場合はこちら</summary>
                                        <div class="mt-3 grid md:grid-cols-3 gap-4">
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-600 mb-2">競合サイト1</label>
                                                <input type="text" id="comp-1-title" class="w-full px-3 py-2 border rounded-lg text-sm mb-2" placeholder="サイト名">
                                                <textarea id="comp-1-headings" class="w-full h-24 px-3 py-2 border rounded-lg text-sm" placeholder="見出しを1行ずつ入力..."></textarea>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-600 mb-2">競合サイト2</label>
                                                <input type="text" id="comp-2-title" class="w-full px-3 py-2 border rounded-lg text-sm mb-2" placeholder="サイト名">
                                                <textarea id="comp-2-headings" class="w-full h-24 px-3 py-2 border rounded-lg text-sm" placeholder="見出しを1行ずつ入力..."></textarea>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-600 mb-2">競合サイト3</label>
                                                <input type="text" id="comp-3-title" class="w-full px-3 py-2 border rounded-lg text-sm mb-2" placeholder="サイト名">
                                                <textarea id="comp-3-headings" class="w-full h-24 px-3 py-2 border rounded-lg text-sm" placeholder="見出しを1行ずつ入力..."></textarea>
                                            </div>
                                        </div>
                                    </details>
                                </div>

                                <!-- 検索上位20位分析モード -->
                                <div id="comp-serp-mode" class="hidden mb-4">
                                    <p class="text-sm text-gray-600 mb-3">
                                        <span class="material-symbols-outlined icon-sm text-indigo-500">info</span>
                                        ターゲットキーワードの検索上位20位のページを分析して、上位表示に必要な要素を抽出します。
                                    </p>

                                    <!-- SERP取得方法の選択 -->
                                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                                        <!-- Semrush SERP -->
                                        <div class="border-2 border-dashed border-purple-300 rounded-xl p-4 bg-purple-50">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-purple-600 font-bold">Semrush SERP</span>
                                                </div>
                                                <button onclick="document.getElementById('semrush-serp-help').classList.toggle('hidden')" class="text-xs text-purple-500 hover:text-purple-700 flex items-center gap-1">
                                                    <span class="material-symbols-outlined icon-sm">help</span> 取得方法
                                                </button>
                                            </div>
                                            <div id="semrush-serp-help" class="hidden mb-3 p-2 bg-purple-100 rounded text-xs text-purple-800">
                                                <p class="font-bold mb-1">【Semrush】検索上位20位の取得手順：</p>
                                                <ol class="list-decimal list-inside space-y-1">
                                                    <li><strong>Semrush</strong>にログイン（<a href="https://www.semrush.com/" target="_blank" class="underline">semrush.com</a>）</li>
                                                    <li>左メニュー「<strong>Keyword Overview</strong>」をクリック</li>
                                                    <li>検索ボックスに<strong>ターゲットキーワード</strong>を入力して検索</li>
                                                    <li>下にスクロールして「<strong>SERP Analysis</strong>」セクションを見つける</li>
                                                    <li>「<strong>View all XX results in SERP</strong>」をクリック</li>
                                                    <li>右上の「<strong>Export</strong>」ボタン→「<strong>CSV</strong>」を選択</li>
                                                </ol>
                                                <div class="mt-2 p-2 bg-purple-200 rounded">
                                                    <p class="font-bold">CSVに含まれる主な列：</p>
                                                    <p>Position（順位）, URL, Title, Domain</p>
                                                </div>
                                                <p class="mt-2 text-purple-700">💡 無料アカウントでも1日10回まで検索可能</p>
                                            </div>
                                            <div id="semrush-serp-dropzone" class="cursor-pointer hover:bg-purple-100 rounded-lg p-3 text-center transition-colors">
                                                <span class="material-symbols-outlined text-purple-400 text-3xl">upload_file</span>
                                                <p class="text-sm text-purple-700 mt-1">SERP CSVをドロップ</p>
                                                <input type="file" id="semrush-serp-file-input" accept=".csv" class="hidden">
                                            </div>
                                            <div id="semrush-serp-file-status" class="hidden mt-2 text-xs text-purple-700"></div>
                                        </div>

                                        <!-- Ahrefs SERP -->
                                        <div class="border-2 border-dashed border-teal-300 rounded-xl p-4 bg-teal-50">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-teal-600 font-bold">Ahrefs SERP</span>
                                                </div>
                                                <button onclick="document.getElementById('ahrefs-serp-help').classList.toggle('hidden')" class="text-xs text-teal-500 hover:text-teal-700 flex items-center gap-1">
                                                    <span class="material-symbols-outlined icon-sm">help</span> 取得方法
                                                </button>
                                            </div>
                                            <div id="ahrefs-serp-help" class="hidden mb-3 p-2 bg-teal-100 rounded text-xs text-teal-800">
                                                <p class="font-bold mb-1">【Ahrefs】検索上位20位の取得手順：</p>
                                                <ol class="list-decimal list-inside space-y-1">
                                                    <li><strong>Ahrefs</strong>にログイン（<a href="https://ahrefs.com/" target="_blank" class="underline">ahrefs.com</a>）</li>
                                                    <li>上部メニュー「<strong>Keywords Explorer</strong>」をクリック</li>
                                                    <li>検索ボックスに<strong>ターゲットキーワード</strong>を入力</li>
                                                    <li>国を「<strong>Japan</strong>」に設定して検索</li>
                                                    <li>「<strong>SERP overview</strong>」タブをクリック</li>
                                                    <li>検索結果一覧が表示される（1位〜20位以上）</li>
                                                    <li>右上の「<strong>Export</strong>」→「<strong>CSV</strong>」を選択</li>
                                                </ol>
                                                <div class="mt-2 p-2 bg-teal-200 rounded">
                                                    <p class="font-bold">CSVに含まれる主な列：</p>
                                                    <p>#（順位）, URL, Title, Traffic, Keywords</p>
                                                </div>
                                                <p class="mt-2 text-teal-700">💡 Ahrefs Webmaster Toolsは無料で利用可能</p>
                                            </div>
                                            <div id="ahrefs-serp-dropzone" class="cursor-pointer hover:bg-teal-100 rounded-lg p-3 text-center transition-colors">
                                                <span class="material-symbols-outlined text-teal-400 text-3xl">upload_file</span>
                                                <p class="text-sm text-teal-700 mt-1">SERP CSVをドロップ</p>
                                                <input type="file" id="ahrefs-serp-file-input" accept=".csv" class="hidden">
                                            </div>
                                            <div id="ahrefs-serp-file-status" class="hidden mt-2 text-xs text-teal-700"></div>
                                        </div>
                                    </div>

                                    <!-- 手動URL入力 -->
                                    <details class="mb-4">
                                        <summary class="text-sm text-gray-500 cursor-pointer hover:text-gray-700">
                                            <span class="material-symbols-outlined icon-sm">edit</span> 手動でURL入力（SEOツールがない場合）
                                        </summary>
                                        <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                                            <!-- 手動取得方法のヘルプ -->
                                            <div class="mb-3 p-2 bg-amber-50 border border-amber-200 rounded text-xs text-amber-800">
                                                <p class="font-bold mb-2">【無料】Google検索からURLを取得する方法：</p>
                                                <ol class="list-decimal list-inside space-y-1">
                                                    <li><a href="https://www.google.co.jp/" target="_blank" class="underline">Google</a>で<strong>ターゲットキーワード</strong>を検索</li>
                                                    <li>検索結果ページを下にスクロール</li>
                                                    <li>各結果の<strong>URL</strong>を右クリック→「リンクのアドレスをコピー」</li>
                                                    <li>1位〜20位まで順番にコピーして下のテキストエリアに貼り付け</li>
                                                </ol>
                                                <div class="mt-2 p-2 bg-amber-100 rounded">
                                                    <p class="font-bold">より簡単な方法（Chrome拡張機能）：</p>
                                                    <ul class="list-disc list-inside mt-1">
                                                        <li><strong>SEO SERP Workbench</strong> - 検索結果のURLを一括コピー</li>
                                                        <li><strong>SEOquake</strong> - SERP分析＆エクスポート機能</li>
                                                        <li><strong>Keywords Everywhere</strong> - 検索ボリュームも同時に確認</li>
                                                    </ul>
                                                </div>
                                                <p class="mt-2 text-amber-700">⚠️ 広告（スポンサー）は除いて、オーガニック検索結果のみコピー</p>
                                            </div>

                                            <label class="block text-sm font-semibold text-gray-600 mb-2">
                                                検索上位URLを1行ずつ入力（最大20件）
                                            </label>
                                            <textarea id="serp-urls-manual" class="w-full h-40 px-3 py-2 border rounded-lg text-sm font-mono" placeholder="https://example.com/page1
https://example.com/page2
https://example.com/page3
...（1行に1URLずつ貼り付け）"></textarea>
                                            <div class="flex justify-between items-center mt-2">
                                                <p class="text-xs text-gray-500">
                                                    <span class="material-symbols-outlined icon-sm">info</span>
                                                    URLのみ入力。タイトルは自動取得されません（分析には影響なし）
                                                </p>
                                                <button type="button" onclick="updateSerpPreview()" class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded">
                                                    プレビュー更新
                                                </button>
                                            </div>
                                        </div>
                                    </details>

                                    <!-- SERP分析プレビュー -->
                                    <div id="serp-data-preview" class="hidden mb-4 p-3 bg-indigo-50 rounded-lg">
                                        <h4 class="font-semibold text-indigo-700 text-sm mb-2">
                                            <span class="material-symbols-outlined icon-sm">format_list_numbered</span>
                                            読み込まれた検索順位データ
                                        </h4>
                                        <div id="serp-preview-content" class="text-sm text-indigo-600 max-h-48 overflow-y-auto"></div>
                                    </div>
                                </div>

                                <button type="button" onclick="analyzeCompetitorHeadings()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm">
                                    <span class="material-symbols-outlined icon-sm">analytics</span> 分析実行
                                </button>

                                <!-- 競合分析結果 -->
                                <div id="competitor-analysis-result" class="hidden mt-4 pt-4 border-t border-gray-200">
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div class="bg-indigo-50 rounded-lg p-3">
                                            <h4 class="font-bold text-indigo-800 text-sm mb-2">必須見出し</h4>
                                            <div id="must-have-headings" class="space-y-1 text-sm"></div>
                                        </div>
                                        <div class="bg-amber-50 rounded-lg p-3">
                                            <h4 class="font-bold text-amber-800 text-sm mb-2">差別化ポイント</h4>
                                            <div id="diff-headings" class="space-y-1 text-sm"></div>
                                        </div>
                                    </div>
                                    <div class="mt-3 bg-green-50 rounded-lg p-3">
                                        <h4 class="font-bold text-green-800 text-sm mb-2">KCI独自の強み提案</h4>
                                        <div id="kci-unique-headings" class="space-y-1 text-sm"></div>
                                    </div>
                                    <div class="mt-3 bg-slate-50 rounded-lg p-3">
                                        <h4 class="font-bold text-slate-800 text-sm mb-2">推奨見出し構成</h4>
                                        <div id="recommended-structure" class="space-y-1 text-sm"></div>
                                    </div>
                                    <div class="mt-3 bg-white rounded-lg p-3 border">
                                        <h4 class="font-bold text-gray-800 text-sm mb-2">比較表</h4>
                                        <div id="comparison-table" class="text-sm overflow-x-auto"></div>
                                    </div>
                                    <div class="mt-3 text-xs text-gray-500">
                                        <span class="material-symbols-outlined icon-sm">info</span>
                                        分析結果は「記事構成を生成」に自動反映されます
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <a href="javascript:void(0)" id="generate-article-btn" onclick="generateArticleDesign(); return false;" class="btn-success text-white px-6 py-3 rounded-xl font-semibold w-full block text-center cursor-pointer" style="display: block;">
                            記事構成を生成
                        </a>
                    </div>

                    <!-- 生成結果 -->
                    <div id="article-design-result" class="hidden">
                        <!-- 地域キーワード検出バナー -->
                        <div id="regional-keyword-banner" class="hidden mb-4 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-300 rounded-xl p-4">
                            <div class="flex items-start gap-3">
                                <span class="material-symbols-outlined text-amber-600 text-2xl">location_on</span>
                                <div class="flex-1">
                                    <h4 class="font-bold text-amber-800 mb-1">
                                        <span id="regional-keyword-name"></span>向け地域特化記事
                                    </h4>
                                    <p class="text-sm text-amber-700 mb-2">この記事は地域キーワードをターゲットにしています。重複コンテンツを避けるため、以下の独自情報を含めてください：</p>
                                    <ul class="text-xs text-amber-700 space-y-1 list-disc list-inside">
                                        <li>地域での受講場所・アクセス情報</li>
                                        <li>周辺の教習所比較（3〜5箇所）</li>
                                        <li>地域特有の需要・主要産業との関連</li>
                                        <li>地域からの受講者の声・体験談</li>
                                    </ul>
                                    <!-- 重複コンテンツ警告エリア -->
                                    <div id="duplicate-content-warning" class="hidden"></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- 左カラム：構成案 -->
                            <div>
                                <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-indigo-600">description</span>
                                    記事構成案
                                </h3>

                                <!-- 構成表示切替タブ -->
                                <div class="flex gap-2 mb-3">
                                    <button type="button" onclick="showOutlineTab('basic')" class="outline-tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-600" data-tab="basic">
                                        <span class="material-symbols-outlined icon-sm">description</span> 基本構成
                                    </button>
                                    <button type="button" onclick="showOutlineTab('integrated')" class="outline-tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-indigo-100 text-indigo-700" data-tab="integrated">
                                        <span class="material-symbols-outlined icon-sm">auto_awesome</span> SEO統合版
                                    </button>
                                </div>

                                <!-- 基本構成 -->
                                <div id="article-outline-basic" class="outline-tab-content hidden">
                                    <div id="article-outline" class="bg-gray-50 rounded-xl p-4 text-sm whitespace-pre-wrap font-mono"></div>
                                </div>

                                <!-- SEO統合版 -->
                                <div id="article-outline-integrated-container" class="outline-tab-content">
                                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 mb-3 text-sm text-indigo-800">
                                        <span class="material-symbols-outlined icon-sm">info</span>
                                        <strong>SEO統合版</strong>：CTA・内部リンク・E-E-A-T要素が記事構成に直接組み込まれています。
                                    </div>
                                    <div id="article-outline-integrated" class="bg-white rounded-xl p-4 text-sm border border-gray-200 overflow-auto max-h-[600px]"></div>
                                </div>
                            </div>

                            <!-- 右カラム：タイトル・メタ -->
                            <div class="space-y-4">
                                <div>
                                    <h3 class="font-bold text-gray-700 mb-3">SEOタイトル案</h3>
                                    <div id="title-suggestions" class="space-y-2"></div>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-700 mb-3">メタディスクリプション</h3>
                                    <div id="meta-description" class="bg-gray-50 rounded-xl p-4 text-sm"></div>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-700 mb-3">参照すべき一次情報</h3>
                                    <div id="primary-sources" class="space-y-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- プロ向けSEO戦略セクション -->
                        <div class="mt-8 border-t pt-8">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                                プロ向けSEO戦略
                            </h3>

                            <!-- タブナビゲーション -->
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button type="button" onclick="showProTab('eeat')" class="pro-tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-indigo-100 text-indigo-700" data-tab="eeat">E-E-A-T</button>
                                <button type="button" onclick="showProTab('cta')" class="pro-tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-600" data-tab="cta">CTA設計</button>
                                <button type="button" onclick="showProTab('links')" class="pro-tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-600" data-tab="links">内部リンク</button>
                                <button type="button" onclick="showProTab('schema')" class="pro-tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-600" data-tab="schema">構造化データ</button>
                                <button type="button" onclick="showProTab('diff')" class="pro-tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-600" data-tab="diff">AI差別化</button>
                            </div>

                            <!-- タブコンテンツ -->
                            <div id="pro-tab-eeat" class="pro-tab-content bg-indigo-50 rounded-xl p-4">
                                <pre id="pro-tips-eeat" class="text-sm whitespace-pre-wrap font-mono text-indigo-900"></pre>
                            </div>
                            <div id="pro-tab-cta" class="pro-tab-content hidden bg-indigo-50 rounded-xl p-4">
                                <pre id="pro-tips-cta" class="text-sm whitespace-pre-wrap font-mono text-indigo-900"></pre>
                            </div>
                            <div id="pro-tab-links" class="pro-tab-content hidden bg-indigo-50 rounded-xl p-4">
                                <pre id="pro-tips-links" class="text-sm whitespace-pre-wrap font-mono text-indigo-900"></pre>
                            </div>
                            <div id="pro-tab-schema" class="pro-tab-content hidden bg-slate-50 rounded-xl p-4">
                                <pre id="pro-tips-schema" class="text-sm whitespace-pre-wrap font-mono text-slate-900"></pre>
                            </div>
                            <div id="pro-tab-diff" class="pro-tab-content hidden bg-slate-50 rounded-xl p-4">
                                <pre id="pro-tips-diff" class="text-sm whitespace-pre-wrap font-mono text-slate-900"></pre>
                            </div>
                        </div>

                        <!-- 関連記事アイデア追加セクション -->
                        <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-xl">
                            <h4 class="font-bold text-amber-800 mb-3 flex items-center gap-2">
                                <span class="material-symbols-outlined">lightbulb</span>
                                派生記事のアイデアをメモ
                            </h4>
                            <p class="text-sm text-amber-700 mb-3">この記事から派生する関連記事のアイデアがあれば保存しておきましょう</p>
                            <div class="flex gap-2">
                                <input type="text" id="related-idea-input" class="flex-1 border border-amber-300 rounded-lg px-3 py-2 text-sm bg-white" placeholder="例：フォークリフト免許の取り方">
                                <button onclick="addRelatedIdea()" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-1">
                                    <span class="material-symbols-outlined icon-sm">add</span> 追加
                                </button>
                            </div>
                            <div id="quick-idea-suggestions" class="mt-3 flex flex-wrap gap-2"></div>
                        </div>

                        <!-- アクションボタン -->
                        <div class="mt-8 p-6 bg-gradient-to-r from-indigo-50 to-slate-50 rounded-xl">
                            <h3 class="font-bold text-gray-800 mb-4 text-center">次のアクション</h3>

                            <!-- AI選択 -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">使用するAIを選択</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="ai-select" value="claude" class="hidden peer" checked>
                                        <div class="p-2 border-2 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 hover:bg-gray-50 text-center transition-all">
                                            <div class="font-semibold text-sm text-indigo-700">Claude</div>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="ai-select" value="chatgpt" class="hidden peer">
                                        <div class="p-2 border-2 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 hover:bg-gray-50 text-center transition-all">
                                            <div class="font-semibold text-sm text-indigo-700">ChatGPT</div>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="ai-select" value="gemini" class="hidden peer">
                                        <div class="p-2 border-2 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 hover:bg-gray-50 text-center transition-all">
                                            <div class="font-semibold text-sm text-indigo-700">Gemini</div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="grid md:grid-cols-2 gap-4">
                                <button type="button" onclick="copyForAI()" class="bg-white border-2 border-indigo-300 px-6 py-4 rounded-xl hover:bg-indigo-50 text-left">
                                    <div class="font-semibold text-indigo-700 mb-1">AIで本文を作成</div>
                                    <div class="text-xs text-gray-500">構成案を選択したAIに渡すプロンプトをコピー</div>
                                </button>
                                <button type="button" onclick="copyOutline()" class="bg-white border-2 border-indigo-300 px-6 py-4 rounded-xl hover:bg-indigo-50 text-left">
                                    <div class="font-semibold text-indigo-700 mb-1">構成案をコピー</div>
                                    <div class="text-xs text-gray-500">見出し・タイトル・一次情報をまとめてコピー</div>
                                </button>
                            </div>
                            <!-- 保存・履歴ボタン -->
                            <div class="grid md:grid-cols-2 gap-4 mt-4">
                                <button type="button" onclick="saveArticleStructure()" class="bg-emerald-50 border-2 border-emerald-300 px-6 py-4 rounded-xl hover:bg-emerald-100 text-left">
                                    <div class="font-semibold text-emerald-700 mb-1 flex items-center gap-2">
                                        <span class="material-symbols-outlined icon-sm">save</span> 構成を保存
                                    </div>
                                    <div class="text-xs text-gray-500">現在の記事構成をLocalStorageに保存</div>
                                </button>
                                <button type="button" onclick="openSavedStructures()" class="bg-slate-50 border-2 border-slate-300 px-6 py-4 rounded-xl hover:bg-slate-100 text-left">
                                    <div class="font-semibold text-slate-700 mb-1 flex items-center gap-2">
                                        <span class="material-symbols-outlined icon-sm">history</span> 保存履歴
                                        <span id="saved-structures-count" class="bg-slate-200 text-slate-600 text-xs px-2 py-0.5 rounded-full">0</span>
                                    </div>
                                    <div class="text-xs text-gray-500">過去に保存した構成を復元・参照</div>
                                </button>
                            </div>
                            <!-- 法令コードチェック -->
                            <div class="mt-4">
                                <button type="button" onclick="runLegalCodeCheck()" class="w-full bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-300 px-6 py-4 rounded-xl hover:from-purple-100 hover:to-indigo-100 text-left">
                                    <div class="font-semibold text-purple-700 mb-1 flex items-center gap-2">
                                        <span class="material-symbols-outlined icon-sm">policy</span> 法令コードチェック
                                        <span class="bg-purple-200 text-purple-700 text-xs px-2 py-0.5 rounded-full">NEW</span>
                                    </div>
                                    <div class="text-xs text-gray-500">記事構成の法令情報（講習時間・根拠法令・罰則等）を自動チェック</div>
                                </button>
                            </div>
                        </div>
                    </div>
                    </div><!-- /article-main-tab-design -->

                </div>
            </div>
        </div><!-- /main-content -->

        <!-- フッター -->
        <footer class="text-center text-sm text-gray-400 mt-8">
            <p>建設業安全教育サイトのSEO記事作成を支援するツールです</p>
        </footer>
    </div>

    <!-- 改善メモ（フローティング・左側） -->
    <div id="improvement-memo-panel" class="fixed bottom-4 left-4 z-40">
        <!-- トグルボタン -->
        <button onclick="toggleImprovementMemo()" id="improvement-toggle-btn" class="bg-amber-500 hover:bg-amber-600 text-white rounded-full w-14 h-14 shadow-lg flex items-center justify-center relative">
            <span class="material-symbols-outlined">edit_note</span>
            <span id="improvement-count-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">0</span>
        </button>
        <!-- パネル本体 -->
        <div id="improvement-panel-content" class="hidden absolute bottom-16 left-0 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden">
            <div class="bg-amber-500 text-white px-4 py-3 flex justify-between items-center">
                <h3 class="font-bold flex items-center gap-2">
                    <span class="material-symbols-outlined">edit_note</span> 改善メモ
                </h3>
                <button onclick="toggleImprovementMemo()" class="text-white/70 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-3">
                <p class="text-xs text-gray-500 mb-2">使いながら気づいた改善点をメモ</p>
                <!-- 新規追加フォーム -->
                <div class="flex gap-2 mb-3">
                    <input type="text" id="improvement-input" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="改善点を入力...">
                    <button onclick="addImprovementMemo()" class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-2 rounded-lg text-sm">
                        <span class="material-symbols-outlined icon-sm">add</span>
                    </button>
                </div>
                <!-- カテゴリ選択 -->
                <div class="flex gap-1 mb-3 flex-wrap">
                    <button onclick="setImprovementCategory('UI')" class="improvement-cat-btn px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200" data-cat="UI">UI</button>
                    <button onclick="setImprovementCategory('機能')" class="improvement-cat-btn px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200" data-cat="機能">機能</button>
                    <button onclick="setImprovementCategory('バグ')" class="improvement-cat-btn px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200" data-cat="バグ">バグ</button>
                    <button onclick="setImprovementCategory('その他')" class="improvement-cat-btn px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200" data-cat="その他">その他</button>
                </div>
                <!-- メモリスト -->
                <div id="improvement-list" class="max-h-60 overflow-y-auto space-y-2">
                    <p class="text-center text-gray-400 text-sm py-4">メモがありません</p>
                </div>
            </div>
            <div class="bg-gray-50 px-3 py-2 border-t flex justify-between items-center">
                <span class="text-xs text-gray-500">LocalStorageに保存</span>
                <button onclick="exportImprovementMemos()" class="text-xs text-amber-600 hover:text-amber-700">エクスポート</button>
            </div>
        </div>
    </div>

    <!-- 記事アイデアメモ（フローティング） -->
    <div id="article-ideas-panel" class="fixed bottom-4 right-4 z-40">
        <!-- トグルボタン -->
        <button onclick="toggleArticleIdeasPanel()" id="ideas-toggle-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full w-14 h-14 shadow-lg flex items-center justify-center relative">
            <span class="material-symbols-outlined">lightbulb</span>
            <span id="ideas-count-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">0</span>
        </button>
        <!-- パネル本体 -->
        <div id="ideas-panel-content" class="hidden absolute bottom-16 right-0 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden">
            <div class="bg-indigo-600 text-white px-4 py-3 flex justify-between items-center">
                <h3 class="font-bold flex items-center gap-2">
                    <span class="material-symbols-outlined">lightbulb</span> 記事アイデアメモ
                </h3>
                <button onclick="toggleArticleIdeasPanel()" class="text-white/70 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-3">
                <!-- 新規追加フォーム -->
                <div class="flex gap-2 mb-3">
                    <input type="text" id="new-idea-input" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="記事アイデアを入力...">
                    <button onclick="addArticleIdea()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-lg text-sm">
                        <span class="material-symbols-outlined icon-sm">add</span>
                    </button>
                </div>
                <!-- アイデアリスト -->
                <div id="ideas-list" class="max-h-60 overflow-y-auto space-y-2">
                    <p class="text-center text-gray-400 text-sm py-4">アイデアがありません</p>
                </div>
            </div>
            <div class="bg-gray-50 px-3 py-2 text-xs text-gray-500 border-t">
                <span class="material-symbols-outlined icon-sm">info</span>
                クリックで記事作成を開始
            </div>
        </div>
    </div>

    <!-- v4: エクスポートモーダル -->
    <div id="export-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">エクスポート</h2>
                    <button type="button" onclick="closeExportModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <p class="text-sm text-gray-600 mb-4">出力形式を選択してください</p>
                <div class="space-y-3">
                    <button onclick="exportExcel()" class="w-full p-4 border-2 border-indigo-200 rounded-xl hover:bg-indigo-50 text-left flex items-center gap-3">
                        <span class="material-symbols-outlined icon-xl text-indigo-600">table_chart</span>
                        <div>
                            <div class="font-semibold text-indigo-700">Excel形式 (.xlsx)</div>
                            <div class="text-xs text-gray-500">キーワード・クラスター・優先度をシート別に出力</div>
                        </div>
                    </button>
                    <button onclick="exportJSON()" class="w-full p-4 border-2 border-indigo-200 rounded-xl hover:bg-indigo-50 text-left flex items-center gap-3">
                        <span class="material-symbols-outlined icon-xl text-indigo-600">folder</span>
                        <div>
                            <div class="font-semibold text-indigo-700">JSON形式</div>
                            <div class="text-xs text-gray-500">完全なデータバックアップ（後でインポート可能）</div>
                        </div>
                    </button>
                    <button onclick="exportMarkdown()" class="w-full p-4 border-2 border-indigo-200 rounded-xl hover:bg-indigo-50 text-left flex items-center gap-3">
                        <span class="material-symbols-outlined icon-xl text-indigo-600">edit_note</span>
                        <div>
                            <div class="font-semibold text-indigo-700">マークダウン形式</div>
                            <div class="text-xs text-gray-500">記事構成案をMarkdown形式で出力</div>
                        </div>
                    </button>
                    <button onclick="exportCSV()" class="w-full p-4 border-2 border-gray-200 rounded-xl hover:bg-gray-50 text-left flex items-center gap-3">
                        <span class="material-symbols-outlined icon-xl text-slate-500">assignment</span>
                        <div>
                            <div class="font-semibold text-gray-700">CSV形式</div>
                            <div class="text-xs text-gray-500">シンプルなキーワード一覧</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- v4: インポートモーダル -->
    <div id="import-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">インポート</h2>
                    <button type="button" onclick="closeImportModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <p class="text-sm text-gray-600 mb-4">以前にエクスポートしたJSONファイルを読み込みます</p>
                <div id="import-dropzone" class="w-full h-40 border-2 border-dashed border-indigo-300 rounded-xl flex flex-col items-center justify-center bg-indigo-50 hover:bg-indigo-100 cursor-pointer transition-colors">
                    <svg class="w-12 h-12 text-indigo-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <p class="text-indigo-700 font-medium">JSONファイルをドロップ、またはクリックして選択</p>
                    <input type="file" id="import-file-input" accept=".json" class="hidden">
                </div>
                <div class="mt-4 p-3 bg-slate-50 rounded-lg text-xs text-slate-700">
                    <strong>注意:</strong> インポートすると現在のデータは上書きされます
                </div>
            </div>
        </div>
    </div>

    <!-- v4: クラスター編集モーダル -->
    <div id="cluster-edit-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">クラスター編集</h2>
                    <button type="button" onclick="closeClusterEditModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <p class="text-sm text-gray-600 mb-4">キーワードをドラッグ＆ドロップでクラスター間を移動できます</p>
                <div class="mb-4 flex gap-2">
                    <button onclick="addCustomCluster()" class="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm">+ 新規クラスター追加</button>
                </div>
                <div id="cluster-edit-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- 動的に生成 -->
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="closeClusterEditModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">キャンセル</button>
                    <button onclick="saveClusterEdits()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg">変更を保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AIプロンプトモーダル -->
    <div id="ai-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="ai-modal-title" class="text-xl font-bold">AIに送るプロンプト</h2>
                    <button type="button" onclick="closeAIModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <p id="ai-modal-description" class="text-sm text-gray-600 mb-4">以下のプロンプトをコピーしてAIに貼り付けてください</p>
                <textarea id="ai-prompt" class="w-full h-64 p-4 border rounded-xl text-sm font-mono" readonly></textarea>
                <div class="flex gap-3 mt-4">
                    <button type="button" onclick="copyAIPrompt()" class="btn-primary text-white px-6 py-2 rounded-lg flex-1">プロンプトをコピー</button>
                    <a id="ai-link" href="https://claude.ai/" target="_blank" class="bg-gray-100 px-6 py-2 rounded-lg text-center hover:bg-gray-200">AIを開く</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 保存した構成モーダル -->
    <div id="saved-structures-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <span class="material-symbols-outlined">history</span> 保存した記事構成
                    </h2>
                    <button type="button" onclick="closeSavedStructures()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <p class="text-sm text-gray-600 mt-2">過去に保存した記事構成を復元・参照できます</p>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div id="saved-structures-list" class="space-y-4">
                    <p class="text-center text-gray-400 py-8">保存された構成がありません</p>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-between">
                <button onclick="clearAllSavedStructures()" class="text-red-500 hover:text-red-600 text-sm">全て削除</button>
                <button onclick="closeSavedStructures()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        // ========== グローバル変数 ==========
        let keywords = [];
        let clusters = [];
        let selectedClusterIndex = null;

        // ========== 法令リファレンスデータ ==========
        const LEGAL_REFERENCE = {
            // 根拠法令
            laws: {
                '労働安全衛生法': {
                    abbreviation: '安衛法',
                    url: 'https://elaws.e-gov.go.jp/document?lawid=347AC0000000057',
                    keyArticles: {
                        '第59条': '雇入れ時教育・作業内容変更時教育',
                        '第60条': '職長等教育（職長・安全衛生責任者教育）',
                        '第60条の2': '危険有害業務従事者への安全衛生教育',
                        '第61条': '就業制限（技能講習・免許が必要な業務）',
                        '第119条': '罰則（6月以下の懲役または50万円以下の罰金）',
                        '第120条': '罰則（50万円以下の罰金）'
                    }
                },
                '労働安全衛生規則': {
                    abbreviation: '安衛則',
                    url: 'https://elaws.e-gov.go.jp/document?lawid=347M50002000032',
                    keyArticles: {
                        '第35条': '雇入れ時等の教育',
                        '第36条': '特別教育を必要とする業務（全41業務）',
                        '第37条': '特別教育の科目の省略',
                        '第38条': '特別教育の記録',
                        '第39条': '特別教育の細目',
                        '第40条': '就業制限に係る業務'
                    }
                },
                '酸素欠乏症等防止規則': {
                    abbreviation: '酸欠則',
                    url: 'https://elaws.e-gov.go.jp/document?lawid=347M50002000042',
                    keyArticles: {
                        '第11条': '特別教育（酸素欠乏危険作業）',
                        '第12条': '特別教育の科目'
                    }
                },
                '粉じん障害防止規則': {
                    abbreviation: '粉じん則',
                    url: 'https://elaws.e-gov.go.jp/document?lawid=354M50002000018',
                    keyArticles: {
                        '第22条': '特別教育（粉じん作業）'
                    }
                },
                '石綿障害予防規則': {
                    abbreviation: '石綿則',
                    url: 'https://elaws.e-gov.go.jp/document?lawid=417M60000100021',
                    keyArticles: {
                        '第27条': '特別教育（石綿使用建築物等解体等）'
                    }
                }
            },

            // 特別教育一覧（安衛則第36条）
            specialEducations: {
                'フルハーネス': {
                    officialName: '高さが2メートル以上の箇所であって作業床を設けることが困難なところにおいて、墜落制止用器具のうちフルハーネス型のものを用いて行う作業に係る業務',
                    shortName: 'フルハーネス型墜落制止用器具特別教育',
                    law: '安衛則第36条第41号',
                    totalHours: 6,
                    curriculum: [
                        { subject: '作業に関する知識', hours: 1 },
                        { subject: '墜落制止用器具に関する知識', hours: 2 },
                        { subject: '労働災害の防止に関する知識', hours: 1 },
                        { subject: '関係法令', hours: 0.5 },
                        { subject: '墜落制止用器具の使用方法等（実技）', hours: 1.5 }
                    ],
                    effectiveDate: '2019年2月1日',
                    targetPerson: '高さ2m以上でフルハーネス型を使用する作業者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし（ただし概ね5年ごとの再教育を推奨）',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技1.5時間は対面必須（器具の装着・点検）',
                    commonMistakes: [
                        '高さ2m未満でも墜落の危険がある場所では受講推奨',
                        '胴ベルト型のみ使用する場合は不要（ただし経過措置あり）',
                        '2022年1月2日以降、高さ6.75m超は原則フルハーネス型'
                    ]
                },
                '足場': {
                    officialName: '足場の組立て、解体又は変更の作業に係る業務',
                    shortName: '足場の組立て等特別教育',
                    law: '安衛則第36条第39号',
                    totalHours: 6,
                    curriculum: [
                        { subject: '足場及び作業の方法に関する知識', hours: 3 },
                        { subject: '工事用設備、機械、器具、作業環境等に関する知識', hours: 0.5 },
                        { subject: '労働災害の防止に関する知識', hours: 1.5 },
                        { subject: '関係法令', hours: 1 }
                    ],
                    effectiveDate: '2015年7月1日',
                    targetPerson: '足場の組立て・解体・変更作業に従事する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: false,
                    commonMistakes: [
                        '「足場作業主任者技能講習」とは別の資格',
                        '足場の上で作業するだけなら不要（組立て等に従事する者が対象）',
                        '2015年7月1日以前から従事している者も受講必要'
                    ]
                },
                '酸欠': {
                    officialName: '酸素欠乏危険作業に係る業務',
                    shortName: '酸素欠乏・硫化水素危険作業特別教育',
                    law: '酸欠則第12条',
                    totalHours: 5.5,
                    curriculum: [
                        { subject: '酸素欠乏等の発生の原因', hours: 1 },
                        { subject: '酸素欠乏症等の症状', hours: 1 },
                        { subject: '空気呼吸器等の使用の方法', hours: 1 },
                        { subject: '事故の場合の退避及び救急そ生の方法', hours: 1 },
                        { subject: 'その他酸素欠乏症等の防止に関し必要な事項', hours: 1.5 }
                    ],
                    targetPerson: '酸素欠乏危険場所で作業する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: false,
                    commonMistakes: [
                        '「酸素欠乏危険作業主任者技能講習」とは別',
                        '第1種（酸欠のみ）と第2種（酸欠+硫化水素）がある',
                        '特別教育は作業者向け、技能講習は作業主任者向け'
                    ]
                },
                '低圧電気': {
                    officialName: '低圧の充電電路の敷設若しくは修理の業務又は配電盤室、変電室等区画された場所に設置する低圧の電路のうち充電部分が露出している開閉器の操作の業務',
                    shortName: '低圧電気取扱特別教育',
                    law: '安衛則第36条第4号',
                    totalHours: 14,
                    curriculum: [
                        { subject: '低圧の電気に関する基礎知識', hours: 1 },
                        { subject: '低圧の電気設備に関する基礎知識', hours: 2 },
                        { subject: '低圧用の安全作業用具に関する基礎知識', hours: 1 },
                        { subject: '低圧の活線作業及び活線近接作業の方法', hours: 2 },
                        { subject: '関係法令', hours: 1 },
                        { subject: '低圧の活線作業及び活線近接作業（実技）', hours: 7 }
                    ],
                    targetPerson: '低圧（直流750V以下、交流600V以下）電気取扱者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技7時間（開閉器操作のみなら1時間に短縮可）',
                    commonMistakes: [
                        '電気工事士免許とは別の資格（両方必要な場合あり）',
                        '充電部分に触れない作業は対象外',
                        '開閉器操作のみなら学科7h+実技1hの短縮版あり'
                    ]
                },
                '粉じん': {
                    officialName: '粉じん作業に係る業務',
                    shortName: '粉じん作業特別教育',
                    law: '粉じん則第22条',
                    totalHours: 4.5,
                    curriculum: [
                        { subject: '粉じんの発散防止及び作業場の換気の方法', hours: 1 },
                        { subject: '作業場の管理', hours: 1 },
                        { subject: '呼吸用保護具の使用の方法', hours: 0.5 },
                        { subject: 'その他粉じんによる疾病の防止に関し必要な事項', hours: 1 },
                        { subject: '関係法令', hours: 1 }
                    ],
                    targetPerson: '粉じん作業（じん肺法施行規則別表に定める作業）従事者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: false,
                    commonMistakes: [
                        '特定粉じん作業と粉じん作業は異なる',
                        'じん肺健康診断も別途必要'
                    ]
                },
                '石綿': {
                    officialName: '石綿使用建築物等解体等の作業に係る業務',
                    shortName: '石綿取扱い作業特別教育',
                    law: '石綿則第27条',
                    totalHours: 4.5,
                    curriculum: [
                        { subject: '石綿の有害性', hours: 0.5 },
                        { subject: '石綿等の使用状況', hours: 1 },
                        { subject: '石綿等の粉じんの発散を抑制するための措置', hours: 1 },
                        { subject: '保護具の使用方法', hours: 1 },
                        { subject: 'その他石綿等のばく露防止に関し必要な事項', hours: 1 }
                    ],
                    targetPerson: '石綿含有建材の除去・解体作業従事者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: false,
                    commonMistakes: [
                        '石綿作業主任者技能講習とは別',
                        '2006年以前の建築物は石綿含有の可能性あり',
                        '事前調査も義務化されている'
                    ]
                },
                '丸のこ': {
                    officialName: '携帯用丸のこ盤を使用する作業に係る業務',
                    shortName: '丸のこ等取扱い作業特別教育',
                    law: '安衛則第36条第16号の2',
                    totalHours: 4,
                    curriculum: [
                        { subject: '携帯用丸のこ盤に関する知識', hours: 1 },
                        { subject: '携帯用丸のこ盤を使用する作業に関する知識', hours: 1 },
                        { subject: '携帯用丸のこ盤の点検及び整備に関する知識', hours: 0.5 },
                        { subject: '関係法令', hours: 0.5 },
                        { subject: '携帯用丸のこ盤の取扱い（実技）', hours: 1 }
                    ],
                    targetPerson: '携帯用丸のこ盤を使用する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技1時間',
                    commonMistakes: [
                        '据置型の丸のこは対象外',
                        'DIY用でも業務で使用するなら必要'
                    ]
                },
                '有機溶剤': {
                    officialName: '有機溶剤等を製造し、又は取り扱う業務',
                    shortName: '有機溶剤取扱業務特別教育',
                    law: '安衛則第36条第29号',
                    totalHours: 4.5,
                    curriculum: [
                        { subject: '有機溶剤による疾病及び健康管理', hours: 1 },
                        { subject: '作業環境管理', hours: 1 },
                        { subject: '保護具', hours: 0.5 },
                        { subject: '関係法令', hours: 1 },
                        { subject: 'その他有機溶剤中毒の予防に必要な事項', hours: 1 }
                    ],
                    targetPerson: '有機溶剤を取り扱う業務に従事する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: false,
                    commonMistakes: [
                        '有機溶剤作業主任者技能講習とは別',
                        '第1種・第2種・第3種で規制が異なる',
                        '換気設備の設置義務も確認が必要'
                    ]
                },
                '高所作業車': {
                    officialName: '高所作業車の運転の業務（作業床の高さが10m未満）',
                    shortName: '高所作業車運転特別教育',
                    law: '安衛則第36条第10号の5',
                    totalHours: 9,
                    curriculum: [
                        { subject: '高所作業車の作業に関する装置の構造及び取扱いの方法に関する知識', hours: 3 },
                        { subject: '原動機に関する知識', hours: 1 },
                        { subject: '高所作業車の運転に必要な一般的事項に関する知識', hours: 1 },
                        { subject: '関係法令', hours: 1 },
                        { subject: '高所作業車の作業のための装置の操作（実技）', hours: 3 }
                    ],
                    targetPerson: '作業床の高さ10m未満の高所作業車を運転する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技3時間',
                    commonMistakes: [
                        '10m以上は技能講習が必要',
                        '公道走行には別途自動車免許が必要',
                        'トラック式・自走式で操作が異なる'
                    ]
                },
                'クレーン': {
                    officialName: 'つり上げ荷重5t未満のクレーンの運転の業務',
                    shortName: 'クレーン運転特別教育',
                    law: '安衛則第36条第15号',
                    totalHours: 13,
                    curriculum: [
                        { subject: 'クレーンに関する知識', hours: 3 },
                        { subject: '原動機及び電気に関する知識', hours: 3 },
                        { subject: 'クレーンの運転のために必要な力学に関する知識', hours: 2 },
                        { subject: '関係法令', hours: 1 },
                        { subject: 'クレーンの運転（実技）', hours: 4 }
                    ],
                    targetPerson: 'つり上げ荷重5t未満のクレーンを運転する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技4時間',
                    commonMistakes: [
                        '5t以上は免許が必要',
                        '玉掛け作業は別の資格が必要',
                        '床上操作式・床上運転式で区分が異なる'
                    ]
                },
                '移動式クレーン': {
                    officialName: 'つり上げ荷重1t未満の移動式クレーンの運転の業務',
                    shortName: '移動式クレーン運転特別教育',
                    law: '安衛則第36条第16号',
                    totalHours: 13,
                    curriculum: [
                        { subject: '移動式クレーンに関する知識', hours: 3 },
                        { subject: '原動機及び電気に関する知識', hours: 3 },
                        { subject: '移動式クレーンの運転のために必要な力学に関する知識', hours: 2 },
                        { subject: '関係法令', hours: 1 },
                        { subject: '移動式クレーンの運転（実技）', hours: 4 }
                    ],
                    targetPerson: 'つり上げ荷重1t未満の移動式クレーンを運転する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技4時間',
                    commonMistakes: [
                        '1t以上5t未満は技能講習、5t以上は免許が必要',
                        'ユニック車も該当する場合あり',
                        '公道走行には別途自動車免許が必要'
                    ]
                },
                'アーク溶接': {
                    officialName: 'アーク溶接機を用いて行う金属の溶接、溶断等の業務',
                    shortName: 'アーク溶接等特別教育',
                    law: '安衛則第36条第3号',
                    totalHours: 21,
                    curriculum: [
                        { subject: 'アーク溶接等に関する知識', hours: 1 },
                        { subject: 'アーク溶接装置に関する基礎知識', hours: 3 },
                        { subject: 'アーク溶接等の作業の方法に関する知識', hours: 6 },
                        { subject: '関係法令', hours: 1 },
                        { subject: 'アーク溶接等の作業（実技）', hours: 10 }
                    ],
                    targetPerson: 'アーク溶接機を用いて金属の溶接・溶断等を行う者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技10時間',
                    commonMistakes: [
                        'ガス溶接は別の技能講習が必要',
                        '溶接技能者資格（JIS）とは別',
                        '作業環境の換気確保も必要'
                    ]
                },
                '小型車両系': {
                    officialName: '機体重量3t未満の車両系建設機械の運転の業務',
                    shortName: '小型車両系建設機械運転特別教育',
                    law: '安衛則第36条第9号',
                    totalHours: 13,
                    curriculum: [
                        { subject: '小型車両系建設機械の走行に関する装置の構造及び取扱いの方法に関する知識', hours: 3 },
                        { subject: '小型車両系建設機械の作業に関する装置の構造、取扱い及び作業方法に関する知識', hours: 2 },
                        { subject: '小型車両系建設機械の運転に必要な一般的事項に関する知識', hours: 1 },
                        { subject: '関係法令', hours: 1 },
                        { subject: '小型車両系建設機械の走行の操作（実技）', hours: 4 },
                        { subject: '小型車両系建設機械の作業のための装置の操作（実技）', hours: 2 }
                    ],
                    targetPerson: '機体重量3t未満の車両系建設機械（整地・運搬・積込み用、掘削用、解体用、基礎工事用）を運転する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技6時間',
                    commonMistakes: [
                        '3t以上は技能講習が必要',
                        'ユンボ、バックホーなど通称が多い',
                        '整地用・掘削用・解体用・基礎工事用で区分'
                    ]
                },
                'ショベルローダー': {
                    officialName: '最大荷重1t未満のショベルローダー又はフォークローダーの運転の業務',
                    shortName: 'ショベルローダー等運転特別教育',
                    law: '安衛則第36条第5号の3',
                    totalHours: 12,
                    curriculum: [
                        { subject: 'ショベルローダー等の走行に関する装置の構造及び取扱いの方法に関する知識', hours: 2 },
                        { subject: 'ショベルローダー等の荷役に関する装置の構造及び取扱いの方法に関する知識', hours: 2 },
                        { subject: 'ショベルローダー等の運転に必要な力学に関する知識', hours: 1 },
                        { subject: '関係法令', hours: 1 },
                        { subject: 'ショベルローダー等の走行及び荷役の操作（実技）', hours: 6 }
                    ],
                    targetPerson: '最大荷重1t未満のショベルローダー・フォークローダーを運転する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技6時間',
                    commonMistakes: [
                        '1t以上は技能講習が必要',
                        'フォークリフトとは別の資格',
                        '公道走行には別途自動車免許が必要'
                    ]
                },
                '玉掛け': {
                    officialName: 'つり上げ荷重1t未満のクレーン等の玉掛けの業務',
                    shortName: '玉掛け業務特別教育',
                    law: '安衛則第36条第19号',
                    totalHours: 9,
                    curriculum: [
                        { subject: 'クレーン等に関する知識', hours: 1 },
                        { subject: '玉掛けに必要な力学に関する知識', hours: 1 },
                        { subject: '玉掛けの方法', hours: 2 },
                        { subject: '関係法令', hours: 1 },
                        { subject: '玉掛け（実技）', hours: 4 }
                    ],
                    targetPerson: 'つり上げ荷重1t未満のクレーン等の玉掛けを行う者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技4時間',
                    commonMistakes: [
                        '1t以上は技能講習（19時間）が必要',
                        'クレーン運転とは別の資格',
                        '合図の方法も習得が必要'
                    ]
                },
                '熱中症': {
                    officialName: '熱中症予防のための安全衛生教育',
                    shortName: '熱中症対策・予防教育',
                    law: '基発0520第3号（通達）',
                    totalHours: 2,
                    curriculum: [
                        { subject: '熱中症の症状と対応', hours: 0.5 },
                        { subject: '熱中症の予防方法', hours: 0.5 },
                        { subject: 'WBGT（暑さ指数）の活用', hours: 0.5 },
                        { subject: '緊急時の対応', hours: 0.5 }
                    ],
                    targetPerson: '高温多湿な環境で作業する者',
                    penalty: '法定の罰則なし（通達による教育）',
                    validityPeriod: '法定の有効期限なし（毎年の実施を推奨）',
                    onlineAvailable: true,
                    practicalRequired: false,
                    commonMistakes: [
                        '法令による義務ではなく通達による指導',
                        '建設業では7〜8月の実施が特に重要',
                        '作業環境の測定も併せて行うことを推奨'
                    ]
                },
                'ロープ高所': {
                    officialName: 'ロープ高所作業に係る業務',
                    shortName: 'ロープ高所作業特別教育',
                    law: '安衛則第36条第40号',
                    totalHours: 7,
                    curriculum: [
                        { subject: 'ロープ高所作業に関する知識', hours: 2 },
                        { subject: 'メインロープ等に関する知識', hours: 2 },
                        { subject: '労働災害の防止に関する知識', hours: 1 },
                        { subject: '関係法令', hours: 0.5 },
                        { subject: 'ロープ高所作業の方法（実技）', hours: 1.5 }
                    ],
                    targetPerson: 'ロープにより身体を保持しながら高所で行う作業（ブランコ作業等）に従事する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技1.5時間',
                    commonMistakes: [
                        '足場が設置できない場所での作業が対象',
                        'ビルの外壁清掃等で必要',
                        'フルハーネス特別教育も併せて必要な場合あり'
                    ]
                },
                '巻上げ機': {
                    officialName: '巻上げ機（電気ホイスト、エアーホイストを除く）の運転の業務',
                    shortName: '巻上げ機運転特別教育',
                    law: '安衛則第36条第11号',
                    totalHours: 10,
                    curriculum: [
                        { subject: '巻上げ機に関する知識', hours: 3 },
                        { subject: '巻上げ機の運転に必要な一般的事項に関する知識', hours: 2 },
                        { subject: '関係法令', hours: 1 },
                        { subject: '巻上げ機の運転（実技）', hours: 4 }
                    ],
                    targetPerson: 'ウインチ等の巻上げ機を運転する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技4時間',
                    commonMistakes: [
                        '電気ホイスト・エアーホイストは対象外',
                        '建設現場での資材揚重で使用',
                        'クレーン運転とは別の資格'
                    ]
                },
                '研削砥石': {
                    officialName: '自由研削用といしの取替え又は取替え時の試運転の業務',
                    shortName: '研削といし取替え・試運転特別教育',
                    law: '安衛則第36条第1号',
                    totalHours: 6,
                    curriculum: [
                        { subject: '自由研削用といし、取付け具等に関する知識', hours: 2 },
                        { subject: '自由研削用といしの取付け方法及び試運転の方法に関する知識', hours: 1 },
                        { subject: '関係法令', hours: 1 },
                        { subject: '自由研削用といしの取付け方法及び試運転の方法（実技）', hours: 2 }
                    ],
                    targetPerson: 'グラインダー等の砥石の取替え・試運転を行う者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技2時間',
                    commonMistakes: [
                        '砥石を使用するだけなら不要（取替え作業者が対象）',
                        '研削盤（機械研削）は別の資格'
                    ]
                },
                '刈払機': {
                    officialName: '刈払機取扱い作業者に対する安全衛生教育',
                    shortName: '刈払機取扱作業者安全衛生教育',
                    law: '基発第66号（通達）',
                    totalHours: 6,
                    curriculum: [
                        { subject: '刈払機に関する知識', hours: 1 },
                        { subject: '刈払機を使用する作業に関する知識', hours: 1 },
                        { subject: '刈払機の点検及び整備に関する知識', hours: 0.5 },
                        { subject: '振動障害及びその予防に関する知識', hours: 2 },
                        { subject: '関係法令', hours: 0.5 },
                        { subject: '刈払機の作業等（実技）', hours: 1 }
                    ],
                    targetPerson: '刈払機を使用する作業に従事する者',
                    penalty: '法定の罰則なし（通達による教育）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技1時間',
                    commonMistakes: [
                        '法令による義務ではなく通達による指導',
                        '振動障害予防も含まれる'
                    ]
                },
                '振動工具': {
                    officialName: 'チェーンソー以外の振動工具取扱い作業に係る業務',
                    shortName: '振動工具取扱作業者安全衛生教育',
                    law: '基発第0710001号（通達）',
                    totalHours: 4,
                    curriculum: [
                        { subject: '振動工具に関する知識', hours: 1.5 },
                        { subject: '振動障害及びその予防に関する知識', hours: 1 },
                        { subject: '関係法令', hours: 0.5 },
                        { subject: '振動工具の取扱い方法（実技）', hours: 1 }
                    ],
                    targetPerson: 'ブレーカー、インパクトレンチ等の振動工具使用者',
                    penalty: '法定の罰則なし（通達による教育）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技1時間（器具の正しい持ち方等）',
                    commonMistakes: [
                        '法令による義務ではなく通達による指導',
                        'チェーンソーは別の特別教育が必要'
                    ]
                },
                'テールゲート': {
                    officialName: 'テールゲートリフターの操作の業務に係る特別教育',
                    shortName: 'テールゲートリフター操作特別教育',
                    law: '安衛則第36条第5号の2',
                    totalHours: 6,
                    curriculum: [
                        { subject: 'テールゲートリフターに関する知識', hours: 1.5 },
                        { subject: 'テールゲートリフターの操作方法', hours: 2 },
                        { subject: '関係法令', hours: 0.5 },
                        { subject: 'テールゲートリフターの操作（実技）', hours: 2 }
                    ],
                    effectiveDate: '2024年2月1日',
                    targetPerson: 'テールゲートリフター（パワーゲート）を操作する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技2時間',
                    commonMistakes: [
                        '2024年2月1日から義務化',
                        '経過措置あり（2024年1月31日以前からの従事者は猶予期間あり）',
                        '荷役作業全般の安全確保が目的'
                    ]
                },
                '不整地運搬車': {
                    officialName: '最大積載量1t未満の不整地運搬車の運転の業務',
                    shortName: '不整地運搬車運転特別教育',
                    law: '安衛則第36条第5号の4',
                    totalHours: 12,
                    curriculum: [
                        { subject: '不整地運搬車の走行に関する装置の構造及び取扱いの方法に関する知識', hours: 2 },
                        { subject: '不整地運搬車の荷の運搬に関する知識', hours: 2 },
                        { subject: '不整地運搬車の運転に必要な力学に関する知識', hours: 1 },
                        { subject: '関係法令', hours: 1 },
                        { subject: '不整地運搬車の走行及び荷役の操作（実技）', hours: 6 }
                    ],
                    targetPerson: '最大積載量1t未満の不整地運搬車を運転する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技6時間',
                    commonMistakes: [
                        '1t以上は技能講習が必要',
                        'キャリアダンプ、クローラーダンプ等が該当',
                        '公道走行には別途自動車免許が必要'
                    ]
                },
                'ローラー': {
                    officialName: 'ローラーの運転の業務',
                    shortName: 'ローラー運転特別教育',
                    law: '安衛則第36条第10号',
                    totalHours: 10,
                    curriculum: [
                        { subject: 'ローラーに関する知識', hours: 4 },
                        { subject: 'ローラーの運転に必要な一般的事項に関する知識', hours: 1 },
                        { subject: '関係法令', hours: 1 },
                        { subject: 'ローラーの運転（実技）', hours: 4 }
                    ],
                    targetPerson: 'ローラー（締固め機械）を運転する者',
                    penalty: '6月以下の懲役または50万円以下の罰金（安衛法第119条）',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技4時間',
                    commonMistakes: [
                        'ローラーには荷重制限がない（全て特別教育）',
                        'タイヤローラー、振動ローラー等が該当',
                        '公道走行には別途自動車免許が必要'
                    ]
                },
                '除染': {
                    officialName: '除染等業務に係る特別教育',
                    shortName: '除染等業務特別教育',
                    law: '除染電離則第19条',
                    totalHours: 7,
                    curriculum: [
                        { subject: '電離放射線の生体に与える影響及び被ばく線量の管理の方法に関する知識', hours: 1.5 },
                        { subject: '除染等作業の方法に関する知識', hours: 2.5 },
                        { subject: '除染等作業に使用する機械等の構造及び取扱いの方法に関する知識', hours: 1.5 },
                        { subject: '関係法令', hours: 1 },
                        { subject: '除染等作業の方法（実技）', hours: 0.5 }
                    ],
                    targetPerson: '除染等業務（汚染土壌等の除去等）に従事する者',
                    penalty: '6月以下の懲役または50万円以下の罰金',
                    validityPeriod: '法定の有効期限なし',
                    onlineAvailable: true,
                    practicalRequired: true,
                    practicalNote: '実技0.5時間',
                    commonMistakes: [
                        '福島第一原発事故に伴う除染作業が対象',
                        '被ばく線量管理も教育内容に含まれる',
                        '作業指揮者は別途教育が必要'
                    ]
                }
            },

            // 職長教育
            foremanEducation: {
                '職長教育': {
                    officialName: '職長等教育',
                    law: '安衛法第60条',
                    totalHours: 12,
                    curriculum: [
                        { subject: '作業方法の決定及び労働者の配置に関すること', hours: 2 },
                        { subject: '労働者に対する指導又は監督の方法に関すること', hours: 2.5 },
                        { subject: '危険性又は有害性等の調査及びその結果に基づき講ずる措置に関すること', hours: 4 },
                        { subject: '異常時等における措置に関すること', hours: 1.5 },
                        { subject: 'その他現場監督者として行うべき労働災害防止活動に関すること', hours: 2 }
                    ],
                    targetPerson: '新たに職長（作業中の労働者を直接指導監督する者）になる者',
                    targetIndustry: '建設業、製造業、電気業、ガス業、自動車整備業、機械修理業',
                    penalty: '50万円以下の罰金（安衛法第120条）',
                    validityPeriod: '法定の有効期限なし（概ね5年ごとの能力向上教育を推奨）',
                    onlineAvailable: true,
                    practicalRequired: false,
                    commonMistakes: [
                        '「職長」は役職名ではなく作業指揮者を指す',
                        '建設業は職長・安責者教育（14時間）が必要',
                        '製造業等は職長教育（12時間）でOK'
                    ]
                },
                '職長・安全衛生責任者': {
                    officialName: '職長・安全衛生責任者教育',
                    law: '安衛法第60条、安衛則第40条',
                    totalHours: 14,
                    curriculum: [
                        { subject: '職長教育', hours: 12 },
                        { subject: '安全衛生責任者の職務等', hours: 1 },
                        { subject: '統括安全衛生管理の進め方', hours: 1 }
                    ],
                    targetPerson: '建設業で職長になる者、または安全衛生責任者に選任される者',
                    targetIndustry: '建設業',
                    penalty: '50万円以下の罰金（安衛法第120条）',
                    validityPeriod: '法定の有効期限なし（概ね5年ごとの能力向上教育を推奨）',
                    onlineAvailable: true,
                    practicalRequired: false,
                    commonMistakes: [
                        '建設業の元請・下請両方で必要',
                        '安全衛生責任者は下請側の責任者',
                        '統括安全衛生責任者は元請側の責任者（別の要件）'
                    ]
                },
                '能力向上教育': {
                    officialName: '職長等及び安全衛生責任者の能力向上教育',
                    law: '安衛法第19条の2、基発第39号',
                    totalHours: 5.5,
                    curriculum: [
                        { subject: '事業場における安全衛生活動', hours: 1 },
                        { subject: '労働災害の動向と問題点', hours: 1.5 },
                        { subject: '職長等及び安全衛生責任者として行うべき労働災害防止活動', hours: 2 },
                        { subject: '危険性又は有害性等の調査等', hours: 0.5 },
                        { subject: 'グループ演習', hours: 0.5 }
                    ],
                    targetPerson: '職長・安全衛生責任者教育修了後、概ね5年経過した者',
                    targetIndustry: '建設業、製造業等',
                    penalty: '法定の罰則なし（通達による推奨）',
                    validityPeriod: '概ね5年ごとの再受講を推奨',
                    onlineAvailable: true,
                    practicalRequired: false,
                    commonMistakes: [
                        '法的義務ではないが、厚労省通達で推奨',
                        '元請から受講を求められることが多い',
                        '新規の職長教育（14時間）の代わりにはならない'
                    ]
                }
            },

            // 技能講習（参考）
            skillTraining: {
                '玉掛け': {
                    officialName: '玉掛け技能講習',
                    law: '安衛法第61条、クレーン則第221条',
                    totalHours: 19,
                    requirement: '1t以上のクレーン等の玉掛け作業',
                    note: '1t未満は特別教育（9時間）でOK'
                },
                'フォークリフト': {
                    officialName: 'フォークリフト運転技能講習',
                    law: '安衛法第61条、安衛則第41条',
                    totalHours: 35,
                    requirement: '最大荷重1t以上のフォークリフト運転',
                    note: '1t未満は特別教育（12時間）でOK'
                },
                '高所作業車': {
                    officialName: '高所作業車運転技能講習',
                    law: '安衛法第61条、安衛則第41条',
                    totalHours: 17,
                    requirement: '作業床高さ10m以上の高所作業車運転',
                    note: '10m未満は特別教育（9時間）でOK'
                },
                '足場作業主任者': {
                    officialName: '足場の組立て等作業主任者技能講習',
                    law: '安衛法第14条、安衛則第565条',
                    totalHours: 18,
                    requirement: 'つり足場、張出し足場、高さ5m以上の足場の組立て等の作業主任者',
                    note: '作業者は別途特別教育が必要'
                },
                '酸欠作業主任者': {
                    officialName: '酸素欠乏・硫化水素危険作業主任者技能講習',
                    law: '安衛法第14条、酸欠則第11条',
                    totalHours: 21,
                    requirement: '酸素欠乏危険場所での作業主任者',
                    note: '作業者は別途特別教育が必要'
                }
            },

            // よくある質問と正確な回答
            faq: [
                {
                    question: '特別教育に有効期限はありますか？',
                    answer: '法令上の有効期限はありません。ただし、厚生労働省は概ね5年ごとの再教育（能力向上教育）を推奨しています。',
                    law: '安衛法第60条の2、能力向上教育指針'
                },
                {
                    question: '特別教育はオンラインで受講できますか？',
                    answer: '学科部分はオンライン（eラーニング、Web講習）で受講可能です。ただし、実技が必要な教育は、実技部分は対面で行う必要があります。',
                    law: '令和3年1月25日基発0125第2号'
                },
                {
                    question: '特別教育と技能講習の違いは？',
                    answer: '特別教育は事業者が実施し修了証を発行。技能講習は都道府県労働局長登録機関が実施し、修了すると免許的な効力があります。技能講習は上位資格です。',
                    law: '安衛法第59条（特別教育）、第61条（技能講習）'
                },
                {
                    question: '修了証を紛失した場合は？',
                    answer: '受講した教育機関に再発行を依頼できます。事業者には特別教育の記録を3年間保存する義務があります。',
                    law: '安衛則第38条'
                },
                {
                    question: '外国人労働者も特別教育が必要？',
                    answer: 'はい、国籍に関係なく、該当業務に従事するすべての労働者に必要です。外国語対応の教育機関もあります。',
                    law: '安衛法第59条'
                }
            ],

            // 数値データ（記事チェック用）
            numericalData: {
                'フルハーネス講習時間': { value: 6, unit: '時間', allowRange: [4.5, 6] },
                '足場講習時間': { value: 6, unit: '時間', allowRange: [6, 6] },
                '職長教育時間': { value: 12, unit: '時間', allowRange: [12, 14] },
                '職長安責者時間': { value: 14, unit: '時間', allowRange: [14, 14] },
                '低圧電気講習時間': { value: 14, unit: '時間', allowRange: [7, 14] },
                '酸欠講習時間': { value: 5.5, unit: '時間', allowRange: [5.5, 5.5] },
                '粉じん講習時間': { value: 4.5, unit: '時間', allowRange: [4.5, 4.5] },
                'フルハーネス義務化高さ': { value: 6.75, unit: 'm', note: '2022年1月2日以降' },
                '墜落制止用器具義務化高さ': { value: 2, unit: 'm' },
                '記録保存期間': { value: 3, unit: '年' }
            }
        };

        // ========== サイト情報設定機能 ==========
        function toggleSiteSettings() {
            const panel = document.getElementById('site-settings-panel');
            const arrow = document.getElementById('site-settings-arrow');
            panel.classList.toggle('hidden');
            arrow.style.transform = panel.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }

        function getSiteSettings() {
            const featuresStr = document.getElementById('site-features')?.value || '';
            const features = featuresStr.split(/[,、\n]/).map(f => f.trim()).filter(f => f);
            return {
                name: document.getElementById('site-name')?.value || 'KCI教育センター',
                url: document.getElementById('site-url')?.value || 'https://kensetsu-mikata.jp',
                features: features,
                applicationUrl: document.getElementById('site-application-url')?.value || '',
                courseUrl: document.getElementById('site-course-url')?.value || '',
                elearningUrl: document.getElementById('site-elearning-url')?.value || '',
                phone: document.getElementById('site-phone')?.value || '',
                companyName: document.getElementById('site-company-name')?.value || '',
                businessHours: document.getElementById('site-business-hours')?.value || '',
                tagline: document.getElementById('site-tagline')?.value || '',
                courseCount: document.getElementById('site-course-count')?.value || '',
                companyCount: document.getElementById('site-company-count')?.value || '',
                userCount: document.getElementById('site-user-count')?.value || ''
            };
        }

        function saveSiteSettings() {
            const settings = getSiteSettings();
            try {
                localStorage.setItem('seo-tool-site-settings', JSON.stringify(settings));
                alert('保存しました');
            } catch (e) {
                alert('保存に失敗しました');
            }
        }

        function loadSiteSettings() {
            try {
                const saved = localStorage.getItem('seo-tool-site-settings');
                if (saved) {
                    const s = JSON.parse(saved);
                    const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
                    setVal('site-name', s.name);
                    setVal('site-url', s.url);
                    setVal('site-features', (s.features || []).join(', '));
                    setVal('site-application-url', s.applicationUrl);
                    setVal('site-course-url', s.courseUrl);
                    setVal('site-elearning-url', s.elearningUrl);
                    setVal('site-phone', s.phone);
                    setVal('site-company-name', s.companyName);
                    setVal('site-business-hours', s.businessHours);
                    setVal('site-tagline', s.tagline);
                    setVal('site-course-count', s.courseCount);
                    setVal('site-company-count', s.companyCount);
                    setVal('site-user-count', s.userCount);
                }
            } catch (e) {
                console.log('サイト設定の読み込みに失敗:', e);
            }
        }

        // ========== サイトリファレンス設定 ==========
        // ★★★ サイト変更時はこのセクションを更新してください ★★★
        const SITE_REFERENCE = {
            // 基本設定（URLを変更する場合はここを編集）
            baseUrl: 'https://kensetsu-mikata.jp',
            lastUpdated: '2026-01-14',

            // サイト構造（URLパスを変更する場合はここを編集）
            paths: {
                top: '/',
                about: '/about/',
                course: '/course/',
                courseInfo: '/course-information/',
                application: '/application/',
                company: '/company/',
                elearning: '/course-information/e-learning/',
                shokucho: '/course/shokucho/',
                store: 'https://store.kensetsu-mikata.jp/' // 外部ドメイン
            },

            // URLビルダー関数
            getUrl(path) {
                if (path.startsWith('http')) return path;
                return this.baseUrl + (this.paths[path] || path);
            }
        };

        // ========== ビッグキーワード候補データ（kensetsu-mikata.jp提供講座に対応） ==========
        const BIG_KEYWORD_VARIATIONS = {
            '職長': { name: '職長・安全衛生責任者教育', icon: 'engineering', estimatedVolume: 15000, priority: 'high', keywords: [
                { keyword: '職長教育', volume: 8000, note: '最重要・検索ボリューム最大' },
                { keyword: '職長安全衛生責任者教育', volume: 2000, note: '正式名称' },
                { keyword: '安全衛生責任者', volume: 1500, note: '責任者視点の検索' },
                { keyword: '職長 資格', volume: 1200, note: '資格取得意図' },
                { keyword: '職長 講習', volume: 1000, note: '講習受講意図' },
                { keyword: '職長教育 オンライン', volume: 1500, note: 'オンライン受講意図（CV高）' },
                { keyword: '職長 再教育', volume: 800, note: '5年更新の検索' }
            ]},
            '能力向上': { name: '能力向上教育（職長・安責の再教育）', icon: 'trending_up', estimatedVolume: 5000, priority: 'high', keywords: [
                { keyword: '職長 再教育', volume: 1500, note: '最重要・5年更新' },
                { keyword: '職長教育 能力向上', volume: 1000, note: '正式名称系' },
                { keyword: '安全衛生責任者 再教育', volume: 800, note: '責任者視点' },
                { keyword: '職長 更新', volume: 600, note: '更新意図' },
                { keyword: '職長教育 5年', volume: 500, note: '更新期間での検索' },
                { keyword: '能力向上教育 オンライン', volume: 600, note: 'オンライン受講意図（CV高）' }
            ]},
            'フルハーネス': { name: 'フルハーネス型墜落制止用器具特別教育', icon: 'safety_check', estimatedVolume: 12000, priority: 'high', keywords: [
                { keyword: 'フルハーネス 特別教育', volume: 5000, note: '最重要' },
                { keyword: 'フルハーネス 講習', volume: 3000, note: '講習受講意図' },
                { keyword: '墜落制止用器具', volume: 1500, note: '正式名称系' },
                { keyword: 'フルハーネス 義務化', volume: 600, note: '法改正関連' },
                { keyword: 'フルハーネス 資格', volume: 800, note: '資格取得意図' },
                { keyword: 'フルハーネス 特別教育 オンライン', volume: 1200, note: 'オンライン受講意図（CV高）' }
            ]},
            '足場': { name: '足場の組立て等特別教育', icon: 'construction', estimatedVolume: 8000, priority: 'high', keywords: [
                { keyword: '足場 特別教育', volume: 3500, note: '最重要' },
                { keyword: '足場の組立て等特別教育', volume: 2000, note: '正式名称' },
                { keyword: '足場 資格', volume: 1200, note: '資格取得意図' },
                { keyword: '足場 講習', volume: 800, note: '講習受講意図' },
                { keyword: '足場 特別教育 オンライン', volume: 800, note: 'オンライン受講意図（CV高）' }
            ]},
            '酸欠': { name: '酸素欠乏・硫化水素危険作業特別教育', icon: 'warning', estimatedVolume: 6000, priority: 'mid', keywords: [
                { keyword: '酸欠 特別教育', volume: 2500, note: '略称・最重要' },
                { keyword: '酸素欠乏 特別教育', volume: 1500, note: '正式名称系' },
                { keyword: '酸素欠乏危険作業', volume: 1000, note: '作業名での検索' },
                { keyword: '硫化水素 特別教育', volume: 500, note: '硫化水素視点' },
                { keyword: '酸欠 講習', volume: 600, note: '講習受講意図' },
                { keyword: '酸欠 特別教育 オンライン', volume: 500, note: 'オンライン受講意図（CV高）' }
            ]},
            '低圧電気': { name: '低圧電気取扱特別教育', icon: 'bolt', estimatedVolume: 5000, priority: 'mid', keywords: [
                { keyword: '低圧電気 特別教育', volume: 2000, note: '最重要' },
                { keyword: '低圧電気取扱業務特別教育', volume: 1500, note: '正式名称' },
                { keyword: '低圧電気 講習', volume: 600, note: '講習受講意図' },
                { keyword: '電気工事 資格', volume: 800, note: '資格系（関連）' },
                { keyword: '低圧電気 特別教育 オンライン', volume: 400, note: 'オンライン受講意図（CV高）' }
            ]},
            '粉じん': { name: '粉じん作業特別教育', icon: 'air', estimatedVolume: 4000, priority: 'mid', keywords: [
                { keyword: '粉じん 特別教育', volume: 1500, note: '最重要' },
                { keyword: '粉塵 特別教育', volume: 800, note: '漢字表記' },
                { keyword: '粉じん作業特別教育', volume: 1000, note: '正式名称' },
                { keyword: '粉じん 講習', volume: 400, note: '講習受講意図' },
                { keyword: '粉じん 特別教育 オンライン', volume: 300, note: 'オンライン受講意図（CV高）' }
            ]},
            '石綿': { name: '石綿取扱い作業従事者特別教育', icon: 'domain', estimatedVolume: 3500, priority: 'mid', keywords: [
                { keyword: '石綿 特別教育', volume: 1200, note: '最重要' },
                { keyword: 'アスベスト 特別教育', volume: 800, note: 'カタカナ表記' },
                { keyword: '石綿取扱い作業従事者特別教育', volume: 600, note: '正式名称' },
                { keyword: 'アスベスト 講習', volume: 500, note: '講習受講意図' },
                { keyword: '石綿 資格', volume: 400, note: '資格取得意図' }
            ]},
            '有機溶剤': { name: '有機溶剤取扱業務特別教育', icon: 'science', estimatedVolume: 3000, priority: 'mid', keywords: [
                { keyword: '有機溶剤 特別教育', volume: 1200, note: '最重要' },
                { keyword: '有機溶剤取扱業務', volume: 800, note: '正式名称系' },
                { keyword: '有機溶剤 講習', volume: 500, note: '講習受講意図' },
                { keyword: '有機溶剤 資格', volume: 300, note: '資格取得意図' },
                { keyword: '有機溶剤 特別教育 オンライン', volume: 200, note: 'オンライン受講意図（CV高）' }
            ]},
            '高所作業車': { name: '高所作業車運転特別教育', icon: 'local_shipping', estimatedVolume: 5000, priority: 'mid', keywords: [
                { keyword: '高所作業車 特別教育', volume: 1800, note: '最重要' },
                { keyword: '高所作業車 技能講習', volume: 1500, note: '技能講習との混同' },
                { keyword: '高所作業車 資格', volume: 1200, note: '資格取得意図' },
                { keyword: '高所作業車 免許', volume: 500, note: '免許系検索' }
            ]},
            'クレーン': { name: 'クレーン運転特別教育', icon: 'precision_manufacturing', estimatedVolume: 6000, priority: 'mid', keywords: [
                { keyword: 'クレーン 免許', volume: 3000, note: '最重要' },
                { keyword: 'クレーン 特別教育', volume: 1500, note: '特別教育系' },
                { keyword: 'クレーン 資格', volume: 1500, note: '資格取得意図' }
            ]},
            '移動式クレーン': { name: '移動式クレーン運転特別教育（1トン未満）', icon: 'precision_manufacturing', estimatedVolume: 3000, priority: 'mid', keywords: [
                { keyword: '移動式クレーン 特別教育', volume: 1200, note: '最重要' },
                { keyword: '小型移動式クレーン', volume: 800, note: '種類別検索' },
                { keyword: '移動式クレーン 資格', volume: 600, note: '資格取得意図' },
                { keyword: '移動式クレーン 1トン未満', volume: 400, note: '対象範囲での検索' }
            ]},
            'アーク溶接': { name: 'アーク溶接等作業特別教育', icon: 'local_fire_department', estimatedVolume: 4000, priority: 'mid', keywords: [
                { keyword: 'アーク溶接 特別教育', volume: 1500, note: '最重要' },
                { keyword: '溶接 資格', volume: 1500, note: '資格取得意図' },
                { keyword: 'アーク溶接 講習', volume: 800, note: '講習受講意図' },
                { keyword: '溶接 免許', volume: 600, note: '免許系検索' }
            ]},
            '小型車両系': { name: '小型車両系建設機械運転特別教育', icon: 'agriculture', estimatedVolume: 4000, priority: 'mid', keywords: [
                { keyword: '小型車両系建設機械 特別教育', volume: 1500, note: '正式名称' },
                { keyword: 'ユンボ 免許', volume: 1500, note: '通称での検索' },
                { keyword: 'バックホー 資格', volume: 800, note: '機種名検索' },
                { keyword: '重機 免許', volume: 1000, note: '一般名称' }
            ]},
            'ショベルローダー': { name: 'ショベルローダー運転特別教育', icon: 'agriculture', estimatedVolume: 1500, priority: 'mid', keywords: [
                { keyword: 'ショベルローダー 特別教育', volume: 600, note: '最重要' },
                { keyword: 'ショベルローダー 資格', volume: 400, note: '資格取得意図' },
                { keyword: 'ショベルローダー 講習', volume: 300, note: '講習受講意図' },
                { keyword: 'ショベルローダー 1トン未満', volume: 200, note: '対象範囲での検索' }
            ]},
            '丸のこ': { name: '丸のこ等取扱作業従事者教育', icon: 'carpenter', estimatedVolume: 2000, priority: 'low', keywords: [
                { keyword: '丸のこ 特別教育', volume: 800, note: '最重要' },
                { keyword: '丸のこ 講習', volume: 600, note: '講習受講意図' },
                { keyword: '丸鋸 資格', volume: 400, note: '漢字表記' }
            ]},
            '玉掛け': { name: '玉掛け業務特別教育', icon: 'fitness_center', estimatedVolume: 3000, priority: 'low', keywords: [
                { keyword: '玉掛け 特別教育', volume: 1200, note: '最重要' },
                { keyword: '玉掛け 資格', volume: 800, note: '資格取得意図' },
                { keyword: '玉掛け 講習', volume: 600, note: '講習受講意図' },
                { keyword: '玉掛け 特別教育 オンライン', volume: 400, note: 'オンライン受講意図（CV高）' }
            ]},
            '熱中症': { name: '熱中症対策・予防教育', icon: 'thermostat', estimatedVolume: 4000, priority: 'low', keywords: [
                { keyword: '熱中症 講習', volume: 1500, note: '最重要' },
                { keyword: '熱中症対策 教育', volume: 1000, note: '対策視点' },
                { keyword: '熱中症予防 研修', volume: 800, note: '研修視点' },
                { keyword: '熱中症 建設業', volume: 500, note: '業種特化' },
                { keyword: '熱中症対策 オンライン', volume: 200, note: 'オンライン受講意図（CV高）' }
            ]},
            'ロープ高所': { name: 'ロープ高所作業特別教育', icon: 'hiking', estimatedVolume: 1500, priority: 'low', keywords: [
                { keyword: 'ロープ高所作業 特別教育', volume: 600, note: '最重要' },
                { keyword: 'ロープアクセス 資格', volume: 500, note: '通称での検索' },
                { keyword: 'ブランコ作業 資格', volume: 400, note: '別名での検索' }
            ]},
            '巻上げ機': { name: '巻上げ機運転特別教育', icon: 'sync', estimatedVolume: 1000, priority: 'low', keywords: [
                { keyword: '巻上げ機 特別教育', volume: 400, note: '最重要' },
                { keyword: 'ウインチ 資格', volume: 400, note: '通称での検索' },
                { keyword: '巻上げ機 講習', volume: 200, note: '講習受講意図' }
            ]},
            '研削砥石': { name: '研削といし取替え・試運転特別教育', icon: 'settings', estimatedVolume: 1500, priority: 'low', keywords: [
                { keyword: '研削砥石 特別教育', volume: 600, note: '最重要' },
                { keyword: 'グラインダー 資格', volume: 500, note: '通称での検索' },
                { keyword: '砥石 交換 資格', volume: 400, note: '作業内容での検索' }
            ]},
            '刈払機': { name: '刈払機取扱作業者安全衛生教育', icon: 'grass', estimatedVolume: 2000, priority: 'low', keywords: [
                { keyword: '刈払機 講習', volume: 800, note: '最重要' },
                { keyword: '草刈機 資格', volume: 600, note: '通称での検索' },
                { keyword: '刈払機 安全衛生教育', volume: 400, note: '正式名称' }
            ]},
            '振動工具': { name: '振動工具取扱作業者安全衛生教育', icon: 'vibration', estimatedVolume: 1000, priority: 'low', keywords: [
                { keyword: '振動工具 特別教育', volume: 400, note: '最重要' },
                { keyword: '振動工具 講習', volume: 300, note: '講習受講意図' },
                { keyword: '振動障害 予防', volume: 300, note: '予防視点' }
            ]},
            'テールゲート': { name: 'テールゲートリフター操作特別教育', icon: 'local_shipping', estimatedVolume: 2000, priority: 'low', keywords: [
                { keyword: 'テールゲートリフター 特別教育', volume: 800, note: '最重要' },
                { keyword: 'テールゲート 講習', volume: 500, note: '講習受講意図' },
                { keyword: 'パワーゲート 資格', volume: 400, note: '通称での検索' },
                { keyword: 'テールゲートリフター 義務化', volume: 300, note: '法改正関連' }
            ]},
            '不整地運搬車': { name: '不整地運搬車運転特別教育（1トン未満）', icon: 'agriculture', estimatedVolume: 1500, priority: 'low', keywords: [
                { keyword: '不整地運搬車 特別教育', volume: 600, note: '最重要' },
                { keyword: '不整地運搬車 資格', volume: 500, note: '資格取得意図' },
                { keyword: 'キャリアダンプ 免許', volume: 400, note: '通称での検索' }
            ]},
            'ローラー': { name: 'ローラー運転特別教育', icon: 'compress', estimatedVolume: 1500, priority: 'low', keywords: [
                { keyword: 'ローラー 特別教育', volume: 600, note: '最重要' },
                { keyword: 'ローラー 資格', volume: 500, note: '資格取得意図' },
                { keyword: '締固め機械 免許', volume: 400, note: '作業内容での検索' }
            ]},
            '除染': { name: '除染等業務特別教育', icon: 'cleaning_services', estimatedVolume: 1000, priority: 'low', keywords: [
                { keyword: '除染 特別教育', volume: 400, note: '最重要' },
                { keyword: '除染作業 資格', volume: 300, note: '資格取得意図' },
                { keyword: '除染等業務 講習', volume: 300, note: '講習受講意図' }
            ]}
        };

        // ========== KCI教育センター サイト情報 ==========
        // （SITE_REFERENCEから自動生成）
        const kciSiteInfo = {
            // 基本情報
            name: 'KCI教育センター',
            domain: new URL(SITE_REFERENCE.baseUrl).hostname,
            tagline: '建設業・製造業向け労働安全衛生教育',

            // 運営会社情報
            company: {
                name: '株式会社manebi',
                address: '〒971-8124 福島県いわき市小名浜住吉折返2-2-3',
                phone: '0120-919-749',
                fax: '0246-85-0039',
                businessHours: '平日 8:00-12:00 / 13:00-17:00'
            },

            // 実績
            achievements: {
                courses: 29,           // 科目数
                companies: 1000,       // 実施企業数
                participants: 10000    // 延べ受講者数
            },

            // サービス特徴
            features: [
                'オンライン講座・DVD講座対応',
                'eラーニング講習',
                'ZOOM講習対応',
                '最短1日で修了証発行',
                '申込みから修了証発行まで3日程度',
                'カード型修了証（耐久性あり）',
                '全国対応'
            ],

            // ページURL（SITE_REFERENCEから生成）
            pages: {
                get top() { return SITE_REFERENCE.getUrl('top'); },
                get about() { return SITE_REFERENCE.getUrl('about'); },
                get course() { return SITE_REFERENCE.getUrl('course'); },
                get courseInfo() { return SITE_REFERENCE.getUrl('courseInfo'); },
                get application() { return SITE_REFERENCE.getUrl('application'); },
                get company() { return SITE_REFERENCE.getUrl('company'); },
                get elearning() { return SITE_REFERENCE.getUrl('elearning'); },
                get shokucho() { return SITE_REFERENCE.getUrl('shokucho'); },
                get store() { return SITE_REFERENCE.getUrl('store'); }
            },

            // コースカテゴリ
            courseCategories: {
                construction: {
                    name: '建設業向け',
                    courses: ['職長・安全衛生責任者教育', '能力向上教育（再教育）', '特別教育（29科目）']
                },
                manufacturing: {
                    name: '製造業向け',
                    courses: ['職長教育一般']
                }
            },

            // 受講方法
            learningMethods: [
                { id: 'online', name: 'オンライン講座', description: 'パソコン等で時間・場所を選ばず受講' },
                { id: 'dvd', name: 'DVD講座', description: 'DVD教材での受講' },
                { id: 'elearning', name: 'eラーニング', description: '顔認証付きeラーニングシステム' },
                { id: 'zoom', name: 'ZOOM講習', description: 'リアルタイムのオンライン講習' },
                { id: 'offline', name: '一般講座', description: '対面での講習' }
            ],

            // コース詳細（主要科目）
            courses: {
                '職長': { fullName: '職長・安全衛生責任者教育', category: 'basic', page: SITE_REFERENCE.getUrl('shokucho'), online: true, elearning: true, zoom: true, dvd: true, hours: 14 },
                '能力向上': { fullName: '能力向上教育（再教育）', category: 'basic', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: true, dvd: true, hours: 6 },
                'フルハーネス': { fullName: 'フルハーネス型墜落制止用器具特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 6, practicalHours: 1.5 },
                '足場': { fullName: '足場の組立て等特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 6 },
                '酸欠': { fullName: '酸素欠乏・硫化水素危険作業特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 5.5 },
                '低圧電気': { fullName: '低圧電気取扱特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 14, practicalHours: 7 },
                '粉じん': { fullName: '粉じん作業特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 4.5 },
                '石綿': { fullName: '石綿取扱い作業従事者特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 4.5 },
                '高所作業車': { fullName: '高所作業車運転特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 9, practicalHours: 3 },
                '小型車両系': { fullName: '小型車両系建設機械運転特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 13, practicalHours: 6 },
                'アーク溶接': { fullName: 'アーク溶接等作業特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 21, practicalHours: 10 },
                '丸のこ': { fullName: '丸のこ等取扱作業従事者教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 4 },
                '玉掛け補助': { fullName: '玉掛け補助作業特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 3 },
                '研削砥石': { fullName: '研削砥石取替試運転業務特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 6, practicalHours: 2 },
                '振動工具': { fullName: '振動工具取扱作業者安全衛生教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 4 },
                '刈払機': { fullName: '刈払機取扱作業者安全衛生教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 6 },
                'ロープ高所': { fullName: 'ロープ高所作業特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 7, practicalHours: 4 },
                '巻上げ機': { fullName: '巻上げ機運転特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 10, practicalHours: 4 },
                'クレーン': { fullName: 'クレーン運転特別教育（5t未満）', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 13, practicalHours: 4 },
                'ゴンドラ': { fullName: 'ゴンドラ取扱特別教育', category: 'special', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: false, dvd: true, hours: 6, practicalHours: 3 },
                '職長一般': { fullName: '職長教育一般（製造業等）', category: 'manufacturing', page: SITE_REFERENCE.getUrl('course'), online: true, elearning: true, zoom: true, dvd: true, hours: 12 }
            }
        };

        // ========== 一次情報データベース ==========
        const primarySources = {
            '職長': [
                { title: '厚生労働省 - 職長等に対する安全衛生教育', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/anzen/anzeneisei02.html' },
                { title: 'e-Gov - 労働安全衛生法第60条', url: 'https://elaws.e-gov.go.jp/document?lawid=347AC0000000057#Mp-At_60' }
            ],
            'フルハーネス': [
                { title: '厚生労働省 - 墜落制止用器具の安全な使用に関するガイドライン', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/0000184407.html' }
            ],
            '足場': [
                { title: '厚生労働省 - 足場からの墜落防止措置', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/0000187309.html' }
            ],
            '酸欠': [
                { title: '厚生労働省 - 酸素欠乏症等の防止', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/anzen/anzeneisei10.html' }
            ],
            '酸素欠乏': [
                { title: '厚生労働省 - 酸素欠乏症等の防止', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/anzen/anzeneisei10.html' }
            ],
            '粉じん': [
                { title: '厚生労働省 - 粉じん障害防止対策', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/anzen/anzeneisei05.html' }
            ],
            '低圧電気': [
                { title: '厚生労働省 - 電気災害の防止', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/anzen/anzeneisei17.html' }
            ],
            '石綿': [
                { title: '厚生労働省 - 石綿（アスベスト）情報', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/sekimen/index.html' }
            ],
            'アスベスト': [
                { title: '厚生労働省 - 石綿（アスベスト）情報', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/sekimen/index.html' }
            ],
            '玉掛け': [
                { title: '厚生労働省 - クレーン等安全規則', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/anzen/anzeneisei15.html' }
            ],
            'クレーン': [
                { title: '厚生労働省 - クレーン等安全規則', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/anzen/anzeneisei15.html' }
            ],
            'フォークリフト': [
                { title: '厚生労働省 - フォークリフトの安全', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/anzen/anzeneisei14.html' }
            ],
            '特別教育': [
                { title: '厚生労働省 - 特別教育一覧', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/anzen/anzeneisei36/index.html' }
            ],
            '技能講習': [
                { title: '厚生労働省 - 技能講習一覧', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/anzen/anzeneisei36/index.html' }
            ],
            '安全衛生教育': [
                { title: '厚生労働省 - 安全衛生教育', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/anzen/anzeneisei02.html' }
            ]
        };

        // ========== 推定検索ボリュームデータ ==========
        const estimatedVolumes = {
            // 職長教育系（月間推定）
            '職長教育': 8000,
            '職長教育 オンライン': 1500,
            '職長教育とは': 1200,
            '職長教育 web': 800,
            '職長教育 料金': 600,
            '職長教育 費用': 500,
            '職長 安全衛生責任者': 2000,
            '職長 安全衛生責任者教育': 1500,
            '職長教育 再教育': 400,
            '職長教育 5年': 300,
            '職長教育 内容': 400,
            '職長教育 カリキュラム': 200,
            '職長教育 時間': 300,
            '職長教育 対象者': 250,
            '職長教育 義務': 350,
            '職長教育 申し込み': 200,

            // フルハーネス系
            'フルハーネス 特別教育': 5000,
            'フルハーネス 講習': 3000,
            'フルハーネス 特別教育 オンライン': 1200,
            'フルハーネス 特別教育 web': 600,
            'フルハーネス 特別教育とは': 800,
            'フルハーネス 特別教育 料金': 400,
            'フルハーネス 特別教育 費用': 350,
            'フルハーネス 特別教育 時間': 300,
            'フルハーネス 特別教育 内容': 250,
            'フルハーネス 義務化': 600,

            // 足場系
            '足場 特別教育': 3500,
            '足場の組立て等特別教育': 2000,
            '足場 特別教育 オンライン': 800,
            '足場 特別教育 web': 400,
            '足場 特別教育 料金': 300,
            '足場 特別教育とは': 500,

            // 酸欠系
            '酸欠 特別教育': 2500,
            '酸素欠乏 特別教育': 1500,
            '酸素欠乏危険作業': 1000,
            '酸欠 特別教育 オンライン': 500,
            '酸欠 特別教育 料金': 250,

            // 粉じん系
            '粉じん 特別教育': 1500,
            '粉塵 特別教育': 800,
            '粉じん作業特別教育': 1000,
            '粉じん 特別教育 オンライン': 300,

            // 低圧電気系
            '低圧電気 特別教育': 2000,
            '低圧電気取扱業務特別教育': 1500,
            '低圧電気 特別教育 オンライン': 400,
            '低圧電気 特別教育 料金': 200,

            // 石綿・アスベスト系
            '石綿 特別教育': 1200,
            'アスベスト 特別教育': 800,
            '石綿取扱い作業従事者特別教育': 600,

            // 玉掛け系
            '玉掛け 技能講習': 4000,
            '玉掛け 資格': 2500,
            '玉掛け 講習': 2000,
            '玉掛け 料金': 500,

            // フォークリフト系
            'フォークリフト 免許': 6000,
            'フォークリフト 講習': 3500,
            'フォークリフト 技能講習': 2500,
            'フォークリフト 料金': 800,

            // 高所作業車系
            '高所作業車 特別教育': 1800,
            '高所作業車 技能講習': 1500,
            '高所作業車 資格': 1200,

            // クレーン系
            'クレーン 免許': 3000,
            'クレーン 特別教育': 1500,
            '小型移動式クレーン': 2000,

            // 一般系
            '特別教育': 8000,
            '特別教育 一覧': 2000,
            '技能講習': 5000,
            '技能講習 一覧': 1500,
            '安全衛生教育': 3000,
            '雇入れ時教育': 1500
        };

        // ボリューム推定関数
        function estimateVolume(keyword) {
            // 完全一致
            if (estimatedVolumes[keyword]) {
                return estimatedVolumes[keyword];
            }
            // 部分一致（スペースなし版も確認）
            const kwNormalized = keyword.replace(/\s+/g, ' ').trim();
            for (const [key, vol] of Object.entries(estimatedVolumes)) {
                if (kwNormalized.includes(key) || key.includes(kwNormalized)) {
                    return Math.round(vol * 0.7); // 部分一致は70%で推定
                }
            }
            // パターンマッチで推定
            if (/オンライン|web|eラーニング/.test(keyword)) return 300;
            if (/料金|費用|価格/.test(keyword)) return 200;
            if (/申し込み|申込/.test(keyword)) return 150;
            if (/とは|意味/.test(keyword)) return 400;
            return 100; // デフォルト
        }

        // ========== 教育種別マスターデータ（実データ） ==========
        const educationMasterData = {
            '職長': {
                name: '職長・安全衛生責任者教育',
                law: '労働安全衛生法第60条',
                lawUrl: 'https://elaws.e-gov.go.jp/document?lawid=347AC0000000057#Mp-At_60',
                totalHours: 14,
                curriculum: [
                    { subject: '作業方法の決定及び労働者の配置', hours: 2 },
                    { subject: '労働者に対する指導又は監督の方法', hours: 2.5 },
                    { subject: '危険性又は有害性等の調査等', hours: 4 },
                    { subject: '異常時等における措置', hours: 1.5 },
                    { subject: 'その他現場監督者として行うべき労働災害防止活動', hours: 2 },
                    { subject: '安全衛生責任者の職務等', hours: 2 }
                ],
                priceRange: { online: { min: 8000, max: 12000 }, offline: { min: 12000, max: 18000 } },
                validityPeriod: 'なし（法的義務なし）',
                recommendedRefresh: '5年ごとに能力向上教育',
                targetPerson: '新たに職長（作業中の労働者を直接指導・監督する者）に就く者',
                industries: '建設業、製造業、電気業、ガス業、自動車整備業、機械修理業',
                penalty: '6ヶ月以下の懲役または50万円以下の罰金（労安法第119条）',
                onlineAvailable: true,
                practicalRequired: false
            },
            'フルハーネス': {
                name: 'フルハーネス型墜落制止用器具特別教育',
                law: '労働安全衛生規則第36条第41号',
                lawUrl: 'https://elaws.e-gov.go.jp/document?lawid=347M50002000032#Mp-At_36',
                totalHours: 6,
                curriculum: [
                    { subject: '作業に関する知識', hours: 1 },
                    { subject: 'フルハーネス型墜落制止用器具に関する知識', hours: 2 },
                    { subject: '労働災害の防止に関する知識', hours: 1 },
                    { subject: '関係法令', hours: 0.5 },
                    { subject: '墜落制止用器具の使用方法等（実技）', hours: 1.5 }
                ],
                priceRange: { online: { min: 6000, max: 9000 }, offline: { min: 8000, max: 12000 } },
                validityPeriod: 'なし（法的義務なし）',
                recommendedRefresh: '特になし',
                targetPerson: '高さ2m以上でフルハーネス型を使用して作業する者',
                industries: '建設業全般、設備工事業、電気工事業',
                penalty: '6ヶ月以下の懲役または50万円以下の罰金',
                onlineAvailable: true,
                practicalRequired: true,
                practicalNote: '実技1.5時間は対面必須（一部講座は実技のみ別日程）'
            },
            '足場': {
                name: '足場の組立て等特別教育',
                law: '労働安全衛生規則第36条第39号',
                lawUrl: 'https://elaws.e-gov.go.jp/document?lawid=347M50002000032#Mp-At_36',
                totalHours: 6,
                curriculum: [
                    { subject: '足場及び作業の方法に関する知識', hours: 3 },
                    { subject: '工事用設備、機械、器具、作業環境等に関する知識', hours: 0.5 },
                    { subject: '労働災害の防止に関する知識', hours: 1.5 },
                    { subject: '関係法令', hours: 1 }
                ],
                priceRange: { online: { min: 6000, max: 9000 }, offline: { min: 8000, max: 12000 } },
                validityPeriod: 'なし（法的義務なし）',
                recommendedRefresh: '特になし',
                targetPerson: '足場の組立て・解体・変更作業に従事する者（地上補助作業を除く）',
                industries: '建設業、塗装業、設備工事業',
                penalty: '6ヶ月以下の懲役または50万円以下の罰金',
                onlineAvailable: true,
                practicalRequired: false
            },
            '酸欠': {
                name: '酸素欠乏・硫化水素危険作業特別教育',
                law: '酸素欠乏症等防止規則第12条',
                lawUrl: 'https://elaws.e-gov.go.jp/document?lawid=347M50002000042',
                totalHours: 5.5,
                curriculum: [
                    { subject: '酸素欠乏等の発生の原因', hours: 1 },
                    { subject: '酸素欠乏症等の症状', hours: 1 },
                    { subject: '空気呼吸器等の使用方法', hours: 1 },
                    { subject: '事故の場合の退避及び救急そ生の方法', hours: 1 },
                    { subject: 'その他酸素欠乏症等の防止に関し必要な事項', hours: 1.5 }
                ],
                priceRange: { online: { min: 6000, max: 9000 }, offline: { min: 8000, max: 12000 } },
                validityPeriod: 'なし（法的義務なし）',
                recommendedRefresh: '特になし',
                targetPerson: '酸素欠乏危険場所で作業に従事する者',
                industries: '建設業、製造業、清掃業、下水道業',
                penalty: '6ヶ月以下の懲役または50万円以下の罰金',
                onlineAvailable: true,
                practicalRequired: false
            },
            '低圧電気': {
                name: '低圧電気取扱特別教育',
                law: '労働安全衛生規則第36条第4号',
                lawUrl: 'https://elaws.e-gov.go.jp/document?lawid=347M50002000032#Mp-At_36',
                totalHours: 14,
                curriculum: [
                    { subject: '低圧の電気に関する基礎知識', hours: 1 },
                    { subject: '低圧の電気設備に関する基礎知識', hours: 2 },
                    { subject: '低圧用の安全作業用具に関する基礎知識', hours: 1 },
                    { subject: '低圧の活線作業及び活線近接作業の方法', hours: 2 },
                    { subject: '関係法令', hours: 1 },
                    { subject: '実技', hours: 7 }
                ],
                priceRange: { online: { min: 8000, max: 12000 }, offline: { min: 12000, max: 18000 } },
                validityPeriod: 'なし（法的義務なし）',
                recommendedRefresh: '特になし',
                targetPerson: '低圧電路の敷設・修理、配電盤の操作業務に従事する者',
                industries: '電気工事業、設備業、製造業',
                penalty: '6ヶ月以下の懲役または50万円以下の罰金',
                onlineAvailable: true,
                practicalRequired: true,
                practicalNote: '実技7時間は対面必須'
            },
            '玉掛け': {
                name: '玉掛け技能講習',
                law: '労働安全衛生法第61条、クレーン等安全規則第221条',
                lawUrl: 'https://elaws.e-gov.go.jp/document?lawid=347M50002000034',
                totalHours: 19,
                curriculum: [
                    { subject: 'クレーン等に関する知識', hours: 1 },
                    { subject: 'クレーン等の玉掛けに必要な力学', hours: 3 },
                    { subject: '玉掛けの方法', hours: 7 },
                    { subject: '関係法令', hours: 1 },
                    { subject: '実技（玉掛け）', hours: 6 },
                    { subject: '実技（合図）', hours: 1 }
                ],
                priceRange: { online: null, offline: { min: 18000, max: 25000 } },
                validityPeriod: 'なし（法的義務なし）',
                recommendedRefresh: '特になし',
                targetPerson: 'つり上げ荷重1t以上のクレーン等の玉掛け作業に従事する者',
                industries: '建設業、製造業、運送業、港湾業',
                penalty: '6ヶ月以下の懲役または50万円以下の罰金',
                onlineAvailable: false,
                practicalRequired: true,
                practicalNote: '技能講習のため全課程対面必須'
            },
            'フォークリフト': {
                name: 'フォークリフト運転技能講習',
                law: '労働安全衛生法第61条',
                lawUrl: 'https://elaws.e-gov.go.jp/document?lawid=347AC0000000057#Mp-At_61',
                totalHours: 35,
                curriculum: [
                    { subject: '走行に関する装置の構造及び取扱い', hours: 4 },
                    { subject: '荷役に関する装置の構造及び取扱い', hours: 4 },
                    { subject: '運転に必要な力学', hours: 2 },
                    { subject: '関係法令', hours: 1 },
                    { subject: '実技（走行）', hours: 20 },
                    { subject: '実技（荷役）', hours: 4 }
                ],
                priceRange: { online: null, offline: { min: 35000, max: 50000 } },
                validityPeriod: 'なし（法的義務なし）',
                recommendedRefresh: '特になし',
                targetPerson: '最大荷重1t以上のフォークリフトを運転する者',
                industries: '物流業、製造業、倉庫業、建設業',
                penalty: '6ヶ月以下の懲役または50万円以下の罰金',
                onlineAvailable: false,
                practicalRequired: true,
                practicalNote: '技能講習のため全課程対面必須'
            },
            '粉じん': {
                name: '粉じん作業特別教育',
                law: '粉じん障害防止規則第22条',
                lawUrl: 'https://elaws.e-gov.go.jp/document?lawid=354M50002000018',
                totalHours: 4.5,
                curriculum: [
                    { subject: '粉じんの発散防止及び作業場の換気の方法', hours: 1 },
                    { subject: '作業場の管理', hours: 1 },
                    { subject: '呼吸用保護具の使用の方法', hours: 0.5 },
                    { subject: '粉じんに係る疾病及び健康管理', hours: 1 },
                    { subject: '関係法令', hours: 1 }
                ],
                priceRange: { online: { min: 5000, max: 8000 }, offline: { min: 7000, max: 10000 } },
                validityPeriod: 'なし（法的義務なし）',
                recommendedRefresh: '特になし',
                targetPerson: '特定粉じん作業に従事する者',
                industries: '建設業、製造業、鋳造業、石材加工業',
                penalty: '6ヶ月以下の懲役または50万円以下の罰金',
                onlineAvailable: true,
                practicalRequired: false
            }
        };

        // ========== クラスター定義 ==========
        const clusterDefinitions = [
            { name: '基礎知識・概要', patterns: ['とは', '意味', '定義', '概要', '必要'], priority: 3, cvExpect: 30 },
            { name: '受講資格・対象者', patterns: ['資格', '要件', '対象', '誰', '条件'], priority: 2, cvExpect: 40 },
            { name: '受講方法・形式', patterns: ['オンライン', 'web', 'eラーニング', '対面', '出張', '講座'], priority: 5, cvExpect: 80 },
            { name: '費用・料金', patterns: ['料金', '費用', '価格', '安い', '相場'], priority: 5, cvExpect: 85 },
            { name: '講習内容・カリキュラム', patterns: ['カリキュラム', '内容', '時間', '科目', '講習'], priority: 3, cvExpect: 35 },
            { name: '修了証・有効期限', patterns: ['修了証', '有効期限', '期限', '更新', '再教育', '5年'], priority: 4, cvExpect: 50 },
            { name: '申し込み方法', patterns: ['申し込み', '申込', '予約', '受講方法', '手続き'], priority: 5, cvExpect: 90 },
            { name: 'おすすめ・比較', patterns: ['おすすめ', '比較', 'ランキング', 'どこがいい', '選び方'], priority: 5, cvExpect: 75 },
            { name: '法律・義務・罰則', patterns: ['義務', '法律', '罰則', '労働安全衛生法', '違反'], priority: 2, cvExpect: 25 },
            { name: '違い・種類', patterns: ['違い', '種類', '区分', '分類'], priority: 3, cvExpect: 35 }
        ];

        // ========== ビッグキーワード候補表示 ==========
        function showBigKeywordVariations() {
            const theme = document.getElementById('big-keyword-theme').value;
            const container = document.getElementById('big-keyword-variations');

            if (!theme || !BIG_KEYWORD_VARIATIONS[theme]) {
                container.classList.add('hidden');
                return;
            }

            const data = BIG_KEYWORD_VARIATIONS[theme];

            // テーマ名と合計ボリューム表示（Material Icons使用）
            document.getElementById('big-keyword-theme-name').innerHTML = `<span class="material-symbols-outlined icon-lg" style="vertical-align: middle;">${data.icon}</span> ${data.name}`;
            document.getElementById('big-keyword-total-volume').textContent = `合計推定ボリューム: ${data.estimatedVolume.toLocaleString()}/月`;

            // キーワードリスト生成
            const listContainer = document.getElementById('big-keyword-list');
            listContainer.innerHTML = data.keywords.map((kw, idx) => `
                <div class="flex items-center gap-3 p-2 ${idx === 0 ? 'bg-slate-100 rounded-lg' : 'border-b border-gray-100'}">
                    <span class="w-6 h-6 rounded-full ${idx === 0 ? 'bg-indigo-500' : 'bg-gray-300'} text-white text-xs flex items-center justify-center font-bold">${idx + 1}</span>
                    <div class="flex-1">
                        <span class="font-medium text-gray-800">${kw.keyword}</span>
                        <span class="text-xs text-gray-500 ml-2">${kw.note}</span>
                    </div>
                    <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">${kw.volume.toLocaleString()}/月</span>
                    <button type="button" onclick="copySingleKeyword('${kw.keyword}')" class="text-indigo-500 hover:text-indigo-700 text-xs underline">コピー</button>
                </div>
            `).join('');

            container.classList.remove('hidden');
        }

        function copyBigKeywords() {
            const theme = document.getElementById('big-keyword-theme').value;
            if (!theme || !BIG_KEYWORD_VARIATIONS[theme]) return;

            const allKeywords = BIG_KEYWORD_VARIATIONS[theme].keywords
                .map(kw => kw.keyword)
                .join('\n');

            copyToClipboard(allKeywords, 'キーワードをコピーしました。ラッコキーワードで検索してください。');
        }

        function copySingleKeyword(keyword) {
            copyToClipboard(keyword, `「${keyword}」をコピーしました`);
        }

        // ========== 地域キーワード展開 ==========
        let expandedRegionKeywords = [];

        // 生成済み地域記事の追跡（重複コンテンツ警告用）
        let generatedRegionalArticles = JSON.parse(localStorage.getItem('generated-regional-articles') || '[]');

        function saveGeneratedRegionalArticle(baseKeyword, region) {
            const article = {
                baseKeyword,
                region,
                generatedAt: new Date().toISOString()
            };
            generatedRegionalArticles.push(article);
            localStorage.setItem('generated-regional-articles', JSON.stringify(generatedRegionalArticles));
        }

        function checkDuplicateRegionalContent(baseKeyword, currentRegion) {
            // 同じベースキーワードで別の地域の記事があるかチェック
            const sameBaseArticles = generatedRegionalArticles.filter(a =>
                a.baseKeyword === baseKeyword && a.region !== currentRegion
            );
            return sameBaseArticles;
        }

        function showDuplicateContentWarning(duplicates, currentRegion) {
            const regionList = duplicates.map(d => d.region).join('、');
            return `
⚠️ 重複コンテンツ警告

同じベースキーワードで以下の地域記事を既に作成しています：
${regionList}

【重複を避けるために】
「${currentRegion}」版では以下を必ず差別化してください：

1. 地域固有の統計・データを入れる
   例：「${currentRegion}の建設業従事者数は○○人」

2. 地域の特色に言及する
   例：「${currentRegion}は○○産業が盛んなため△△の需要が高い」

3. 地域内の具体的な教習所を紹介する
   例：「${currentRegion}で受講できる教習所3選」

4. 地域からの受講者の声を入れる
   例：「${currentRegion}から通われたAさんの体験談」

これらを含めないと、Googleから重複コンテンツと判定されるリスクがあります。
`;
        }

        // エリア選択
        function selectRegionArea(area) {
            const checkboxes = document.querySelectorAll('.region-pref');

            if (area === 'all') {
                checkboxes.forEach(cb => cb.checked = true);
            } else if (area === 'none') {
                checkboxes.forEach(cb => cb.checked = false);
            } else {
                // 特定エリアのみ選択
                checkboxes.forEach(cb => {
                    const label = cb.closest('label');
                    if (label.dataset.area === area) {
                        cb.checked = !cb.checked; // トグル
                    }
                });
            }
            updateRegionCount();
        }

        // 選択数を更新
        function updateRegionCount() {
            const count = document.querySelectorAll('.region-pref:checked').length;
            document.getElementById('region-selected-count').textContent = `選択中: ${count}都道府県`;
        }

        // キーワード展開
        function expandRegionKeywords() {
            const baseKeywordInput = document.getElementById('region-base-keyword').value.trim();
            if (!baseKeywordInput) {
                alert('ベースキーワードを入力してください');
                return;
            }

            const baseKeywords = baseKeywordInput.split(/[\n,]/).map(k => k.trim()).filter(k => k);
            const selectedPrefectures = Array.from(document.querySelectorAll('.region-pref:checked')).map(cb => cb.value);

            if (selectedPrefectures.length === 0) {
                alert('地域を選択してください');
                return;
            }

            // パターンを確認
            const patterns = [];
            if (document.getElementById('region-pattern-1').checked) patterns.push((kw, region) => `${kw} ${region}`);
            if (document.getElementById('region-pattern-2').checked) patterns.push((kw, region) => `${region} ${kw}`);
            if (document.getElementById('region-pattern-3').checked) patterns.push((kw, region) => `${kw} ${region}で`);

            if (patterns.length === 0) {
                alert('展開パターンを1つ以上選択してください');
                return;
            }

            // 展開
            expandedRegionKeywords = [];
            baseKeywords.forEach(baseKw => {
                selectedPrefectures.forEach(pref => {
                    patterns.forEach(pattern => {
                        expandedRegionKeywords.push(pattern(baseKw, pref));
                    });
                });
            });

            // 結果を表示
            const resultDiv = document.getElementById('expanded-keywords-result');
            const textarea = document.getElementById('expanded-keywords-textarea');
            const countSpan = document.getElementById('expanded-keywords-count');
            const copyBtn = document.getElementById('copy-expanded-btn');

            textarea.value = expandedRegionKeywords.join('\n');
            countSpan.textContent = `${expandedRegionKeywords.length}キーワード`;
            resultDiv.classList.remove('hidden');
            copyBtn.classList.remove('hidden');
        }

        // 展開したキーワードをコピー
        function copyExpandedKeywords() {
            const textarea = document.getElementById('expanded-keywords-textarea');
            if (textarea.value) {
                copyToClipboard(textarea.value, `${expandedRegionKeywords.length}件のキーワードをコピーしました`);
            }
        }

        // チェックボックスの変更を監視
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.region-pref').forEach(cb => {
                cb.addEventListener('change', updateRegionCount);
            });
        });

        // ========== ステップ管理 ==========
        function goToStep(step) {
            document.querySelectorAll('#step-1, #step-2, #step-3').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${step}`).classList.remove('hidden');

            // インジケーター更新（3ステップ対応）
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`step-indicator-${i}`);
                if (!indicator) continue;
                indicator.className = 'flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium ';
                const circle = indicator.querySelector('span');

                if (i < step) {
                    indicator.className += 'bg-indigo-100 text-indigo-700';
                    circle.className = 'w-6 h-6 rounded-full bg-slate-600 text-white flex items-center justify-center text-xs font-bold';
                } else if (i === step) {
                    indicator.className += 'bg-indigo-600 text-white';
                    circle.className = 'w-6 h-6 rounded-full bg-white text-indigo-600 flex items-center justify-center text-xs font-bold';
                } else {
                    indicator.className += 'bg-gray-200 text-gray-500';
                    circle.className = 'w-6 h-6 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-xs font-bold';
                }
            }
        }

        // ========== 記事設計タブ切り替え ==========
        function showArticleMainTab(tab) {
            // タブボタンのスタイル更新
            document.querySelectorAll('.article-main-tab-btn').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.className = 'article-main-tab-btn px-6 py-3 rounded-t-lg text-sm font-semibold bg-indigo-100 text-indigo-700 border-b-2 border-indigo-600';
                } else {
                    btn.className = 'article-main-tab-btn px-6 py-3 rounded-t-lg text-sm font-semibold bg-gray-100 text-gray-600 border-b-2 border-transparent hover:bg-gray-200';
                }
            });

            // タブコンテンツの表示切り替え
            document.querySelectorAll('.article-main-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            const targetTab = document.getElementById(`article-main-tab-${tab}`);
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
        }

        // 競合分析セクションの開閉
        function toggleCompetitorSection() {
            const section = document.getElementById('competitor-section');
            const icon = document.getElementById('competitor-toggle-icon');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                icon.textContent = 'expand_less';
            } else {
                section.classList.add('hidden');
                icon.textContent = 'expand_more';
            }
        }

        // ========== CSVファイル処理 ==========
        let loadedCSVData = null; // CSVから読み込んだデータを保持
        function initCSVDropzone() {
            const dropzone = document.getElementById('csv-dropzone');
            const fileInput = document.getElementById('csv-file-input');

            if (!dropzone || !fileInput) return;

            // クリックでファイル選択
            dropzone.addEventListener('click', () => fileInput.click());

            // ファイル選択時
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleCSVFile(e.target.files[0]);
                }
            });

            // ドラッグ＆ドロップ
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('border-indigo-500', 'bg-indigo-100');
            });
            dropzone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropzone.classList.remove('border-indigo-500', 'bg-indigo-100');
            });
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('border-indigo-500', 'bg-indigo-100');
                if (e.dataTransfer.files.length > 0) {
                    handleCSVFile(e.dataTransfer.files[0]);
                }
            });
        }

        function handleCSVFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert('CSVファイルを選択してください');
                return;
            }

            // まずArrayBufferとして読み込み、エンコーディングを判定
            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                const uint8Array = new Uint8Array(arrayBuffer);

                let csvText;

                // BOMを確認してエンコーディングを判定
                if (uint8Array[0] === 0xFF && uint8Array[1] === 0xFE) {
                    // UTF-16 LE (Google Keyword Plannerのデフォルト)
                    console.log('UTF-16 LE encoding detected');
                    // TextDecoderを使用（より安全）
                    csvText = new TextDecoder('utf-16le').decode(arrayBuffer);
                } else if (uint8Array[0] === 0xFE && uint8Array[1] === 0xFF) {
                    // UTF-16 BE
                    console.log('UTF-16 BE encoding detected');
                    csvText = new TextDecoder('utf-16be').decode(arrayBuffer);
                } else if (uint8Array[0] === 0xEF && uint8Array[1] === 0xBB && uint8Array[2] === 0xBF) {
                    // UTF-8 with BOM
                    console.log('UTF-8 with BOM detected');
                    csvText = new TextDecoder('utf-8').decode(arrayBuffer);
                } else {
                    // UTF-8 without BOM (default)
                    console.log('UTF-8 encoding assumed');
                    csvText = new TextDecoder('utf-8').decode(arrayBuffer);
                }

                console.log('Decoded CSV length:', csvText.length);
                console.log('First 200 chars:', csvText.substring(0, 200));

                // Google Keyword Plannerの形式を検出
                // 最初の2行がメタデータ（タイトル、日付範囲）の場合はスキップ
                let lines = csvText.split('\n');
                console.log('Total lines:', lines.length);
                console.log('First 3 lines:', lines.slice(0, 3));

                // Keyword Planner形式の検出（3行目がヘッダー）
                let headerRowIndex = 0;
                if (lines.length > 2) {
                    // 3行目に「Keyword」が含まれているか確認
                    if (lines[2] && lines[2].includes('Keyword') && lines[2].includes('Currency')) {
                        console.log('Google Keyword Planner format detected - skipping first 2 rows');
                        headerRowIndex = 2;
                        // 最初の2行を削除
                        lines = lines.slice(2);
                        csvText = lines.join('\n');
                    }
                }

                console.log('CSV text after processing (first 500 chars):', csvText.substring(0, 500));

                // PapaParseで解析（タブ区切りを自動検出）
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: '\t', // タブ区切りを明示
                    complete: function(results) {
                        console.log('CSV解析結果:', results);
                        console.log('Parsed rows count:', results.data.length);
                        if (results.data.length > 0) {
                            console.log('First row:', results.data[0]);
                        }
                        loadedCSVData = parseCSVData(results.data);

                        // ファイル情報表示
                        document.getElementById('csv-dropzone').classList.add('hidden');
                        document.getElementById('csv-file-info').classList.remove('hidden');
                        document.getElementById('csv-filename').textContent = file.name;
                        document.getElementById('csv-rowcount').textContent = `${loadedCSVData.length}件のキーワード`;
                    },
                    error: function(error) {
                        alert('CSVファイルの読み込みに失敗しました: ' + error.message);
                    }
                });
            };

            reader.onerror = function() {
                alert('ファイルの読み込みに失敗しました');
            };

            reader.readAsArrayBuffer(file);
        }

        function parseCSVData(data) {
            const results = [];
            console.log('parseCSVData called with', data.length, 'rows');

            for (let i = 0; i < data.length; i++) {
                const row = data[i];

                // キーワード列を探す
                let keyword = row['Keyword'] || row['キーワード'] || row['keyword'] || '';

                // トリムして空かチェック
                keyword = keyword.toString().trim();

                // 空のキーワードやサマリー行をスキップ
                if (!keyword || keyword === '' || keyword === 'すべて' || keyword === '日本') {
                    continue;
                }

                // ボリューム列を探す
                let volumeStr = row['Avg. monthly searches'] || row['月間平均検索ボリューム'] ||
                                row['Search Volume'] || row['検索ボリューム'] || '';

                // デバッグ用（最初の10行のみ）
                if (i < 10) {
                    console.log(`Row ${i}: keyword="${keyword}", volume="${volumeStr}"`);
                }

                // ボリュームを数値に変換
                let volume = 10; // デフォルト（ボリュームなしの場合）
                if (volumeStr) {
                    const volStr = volumeStr.toString().trim();
                    // 「1万〜10万」「10〜100」形式
                    const rangeMatch = volStr.match(/(\d+(?:,\d+)?)(万)?[～~\-−](\d+(?:,\d+)?)(万)?/);
                    if (rangeMatch) {
                        let min = parseInt(rangeMatch[1].replace(/,/g, ''));
                        let max = parseInt(rangeMatch[3].replace(/,/g, ''));
                        if (rangeMatch[2] === '万') min *= 10000;
                        if (rangeMatch[4] === '万') max *= 10000;
                        volume = Math.round((min + max) / 2);
                    } else {
                        // 単純な数値（50.0のような小数も対応）
                        const numMatch = volStr.replace(/,/g, '').match(/(\d+(?:\.\d+)?)/);
                        if (numMatch) {
                            volume = Math.round(parseFloat(numMatch[1]));
                        }
                    }
                }

                results.push({ keyword: keyword, volume });
            }

            console.log('parseCSVData result:', results.length, 'keywords');
            if (results.length > 0) {
                console.log('First 5 keywords:', results.slice(0, 5));
            }

            return results;
        }

        function clearCSVFile() {
            loadedCSVData = null;
            document.getElementById('csv-dropzone').classList.remove('hidden');
            document.getElementById('csv-file-info').classList.add('hidden');
            document.getElementById('csv-file-input').value = '';
        }

        // 初期化時にCSVドロップゾーンを設定
        document.addEventListener('DOMContentLoaded', () => {
            initCSVDropzone();
            initCompetitorUpload();
            loadSiteSettings();
        });

        // ========== キーワードプランナーデータ解析 ==========
        function parseKeywordPlannerData(input) {
            const results = [];

            // デバッグ: 生データを表示
            console.log('=== 生データ ===');
            console.log(JSON.stringify(input));

            // タブ区切りでテーブル形式かチェック
            const lines = input.split('\n').filter(l => l.trim());

            // 各行を解析
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                console.log(`行${i}: ${JSON.stringify(line)}`);

                // タブで分割してみる
                const tabCols = line.split('\t');
                console.log(`  タブ分割(${tabCols.length}): ${JSON.stringify(tabCols)}`);

                // 形式1: __keyword__ 形式
                const underscoreMatch = line.match(/__(.+?)__/);
                if (underscoreMatch) {
                    let rawKeyword = underscoreMatch[1].trim();
                    // 日本語文字間のスペースを削除、数字の前はスペース保持
                    let keyword = rawKeyword
                        .replace(/([ぁ-んァ-ヶー一-龯々])\s+([ぁ-んァ-ヶー一-龯々])/g, '$1$2')
                        .replace(/\s+(\d)/g, ' $1')
                        .replace(/(\d)\s+([ぁ-んァ-ヶー一-龯々])/g, '$1$2')
                        .replace(/\s+/g, ' ')
                        .trim();

                    // 次の行からボリュームを取得
                    let volume = 100;
                    if (i + 1 < lines.length) {
                        const nextLine = lines[i + 1];
                        if (!nextLine.includes('———') && !nextLine.match(/__/)) {
                            const rangeMatch = nextLine.match(/^(\d+(?:,\d+)?)(万)?[～~ー\-−](\d+(?:,\d+)?)(万)?/);
                            if (rangeMatch) {
                                let min = parseInt(rangeMatch[1].replace(/,/g, ''));
                                let max = parseInt(rangeMatch[3].replace(/,/g, ''));
                                if (rangeMatch[2] === '万') min *= 10000;
                                if (rangeMatch[4] === '万') max *= 10000;
                                volume = Math.round((min + max) / 2);
                            }
                        }
                    }

                    if (keyword && keyword.length > 1) {
                        results.push({ keyword, volume });
                        console.log(`  → キーワード追加: ${keyword} (vol: ${volume})`);
                    }
                    continue;
                }

                // 形式2: タブ区切り形式（キーワード\tボリューム\t...）
                if (tabCols.length >= 2) {
                    let keyword = tabCols[0].trim();
                    // スペースで区切られた日本語を連結
                    keyword = keyword
                        .replace(/([ぁ-んァ-ヶー一-龯々])\s+([ぁ-んァ-ヶー一-龯々])/g, '$1$2')
                        .replace(/\s+(\d)/g, ' $1')
                        .replace(/(\d)\s+([ぁ-んァ-ヶー一-龯々])/g, '$1$2')
                        .replace(/\s+/g, ' ')
                        .trim();

                    // ヘッダー行や無効な行をスキップ
                    if (!keyword || keyword === 'キーワード' || keyword.includes('月間') ||
                        keyword === '低' || keyword === '中' || keyword === '高' ||
                        keyword.length <= 1) {
                        continue;
                    }

                    // ボリュームを探す
                    let volume = 100;
                    for (let j = 1; j < tabCols.length; j++) {
                        const col = tabCols[j].trim();
                        // 「1万～10万」「10～100」形式
                        const rangeMatch = col.match(/^(\d+(?:,\d+)?)(万)?[～~ー\-−](\d+(?:,\d+)?)(万)?/);
                        if (rangeMatch) {
                            let min = parseInt(rangeMatch[1].replace(/,/g, ''));
                            let max = parseInt(rangeMatch[3].replace(/,/g, ''));
                            if (rangeMatch[2] === '万') min *= 10000;
                            if (rangeMatch[4] === '万') max *= 10000;
                            volume = Math.round((min + max) / 2);
                            break;
                        }
                        // 単純な数値
                        const numMatch = col.match(/^(\d+(?:,\d+)?)$/);
                        if (numMatch) {
                            volume = parseInt(numMatch[1].replace(/,/g, ''));
                            break;
                        }
                    }

                    results.push({ keyword, volume });
                    console.log(`  → キーワード追加: ${keyword} (vol: ${volume})`);
                }
            }

            console.log('=== 解析結果 ===');
            console.log(results);
            return results;
        }

        // ========== サンプルデータ ==========
        function loadSampleData() {
            try {
                const sample = `職長教育
職長教育 オンライン
職長教育 費用
職長教育 とは
職長教育 カリキュラム
職長教育 有効期限
職長教育 申し込み
職長教育 おすすめ
職長教育 義務
職長教育 対象者
職長 安全衛生責任者 違い
職長教育 web
職長教育 料金
職長教育 修了証
職長教育 時間
職長教育 再教育
職長教育 5年
フルハーネス 特別教育
フルハーネス 特別教育 オンライン
フルハーネス 特別教育 費用
足場 特別教育
足場 特別教育 オンライン`;

                // CSVをクリアして簡易モードに切り替え
                loadedCSVData = null;

                const dropzone = document.getElementById('csv-dropzone');
                const fileInfo = document.getElementById('csv-file-info');
                const keywordInput = document.getElementById('keyword-input');

                if (dropzone) dropzone.classList.remove('hidden');
                if (fileInfo) fileInfo.classList.add('hidden');

                // detailsを開いてテキストエリアを表示
                const details = document.querySelector('#step-1 details');
                if (details) {
                    details.open = true;
                }

                if (keywordInput) {
                    keywordInput.value = sample;
                    // 入力後にフォーカスを当てる（視覚的フィードバック）
                    keywordInput.focus();
                    console.log('サンプルデータを読み込みました');
                } else {
                    console.error('keyword-input要素が見つかりません');
                    alert('エラー: テキストエリアが見つかりません');
                }
            } catch (e) {
                console.error('loadSampleData エラー:', e);
                alert('サンプルデータの読み込み中にエラーが発生しました: ' + e.message);
            }
        }

        // ========== 分析開始 ==========
        function startAnalysis() {
            // CSVファイルがあればそれを優先、なければテキストエリアを使用
            if (loadedCSVData && loadedCSVData.length > 0) {
                // CSVから読み込んだデータを使用（実ボリューム）
                keywords = loadedCSVData.map(item => {
                    const kw = item.keyword;
                    let intent = '情報収集', cvExpect = 30;
                    if (/申し込み|申込|予約|受講/.test(kw)) { intent = '購入意向'; cvExpect = 90; }
                    else if (/料金|費用|価格|安い/.test(kw)) { intent = '購入意向'; cvExpect = 85; }
                    else if (/おすすめ|比較|ランキング|どこがいい/.test(kw)) { intent = '比較検討'; cvExpect = 70; }
                    else if (/オンライン|web|eラーニング/.test(kw)) { intent = '購入意向'; cvExpect = 80; }
                    else if (/とは|意味|必要|義務/.test(kw)) { intent = '情報収集'; cvExpect = 25; }

                    return { keyword: kw, intent, cvExpect, volume: item.volume, cluster: null };
                });
            } else {
                // テキストエリアから取り込み（推定ボリューム使用）
                const input = document.getElementById('keyword-input').value;
                const lines = input.split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length === 0) {
                    alert('CSVファイルを選択するか、キーワードを入力してください');
                    return;
                }
                keywords = lines.map(kw => {
                    let intent = '情報収集', cvExpect = 30;
                    if (/申し込み|申込|予約|受講/.test(kw)) { intent = '購入意向'; cvExpect = 90; }
                    else if (/料金|費用|価格|安い/.test(kw)) { intent = '購入意向'; cvExpect = 85; }
                    else if (/おすすめ|比較|ランキング|どこがいい/.test(kw)) { intent = '比較検討'; cvExpect = 70; }
                    else if (/オンライン|web|eラーニング/.test(kw)) { intent = '購入意向'; cvExpect = 80; }
                    else if (/とは|意味|必要|義務/.test(kw)) { intent = '情報収集'; cvExpect = 25; }

                    // 推定検索ボリュームを取得
                    const volume = estimateVolume(kw);

                    return { keyword: kw, intent, cvExpect, volume, cluster: null };
                });
            }

            // クラスタリング
            clusters = [];
            clusterDefinitions.forEach(def => {
                const matched = keywords.filter(kw =>
                    def.patterns.some(p => kw.keyword.includes(p)) && !kw.cluster
                );
                if (matched.length > 0) {
                    clusters.push({
                        name: def.name,
                        keywords: matched,
                        priority: def.priority,
                        cvExpect: def.cvExpect
                    });
                    matched.forEach(kw => kw.cluster = def.name);
                }
            });

            // 未分類
            const unassigned = keywords.filter(kw => !kw.cluster);
            if (unassigned.length > 0) {
                clusters.push({
                    name: 'その他',
                    keywords: unassigned,
                    priority: 1,
                    cvExpect: 30
                });
                unassigned.forEach(kw => kw.cluster = 'その他');
            }

            // ソート（優先スコア = CV期待度 × ボリューム）
            clusters.sort((a, b) => b.priority - a.priority || b.keywords.length - a.keywords.length);
            keywords.sort((a, b) => {
                const scoreA = a.cvExpect * Math.log10(a.volume + 1);
                const scoreB = b.cvExpect * Math.log10(b.volume + 1);
                return scoreB - scoreA;
            });

            // 表示更新
            renderAnalysisResult();
            goToStep(2);
        }

        // ========== 分析結果表示 ==========
        function renderAnalysisResult() {
            // サマリー
            document.getElementById('summary-keywords').textContent = keywords.length;
            document.getElementById('summary-clusters').textContent = clusters.length;
            document.getElementById('summary-articles').textContent = clusters.filter(c => c.priority >= 3).length;
            document.getElementById('summary-priority').textContent = clusters.filter(c => c.priority >= 4).length;

            // クラスター一覧
            const clusterList = document.getElementById('cluster-list');
            clusterList.innerHTML = clusters.map((c, idx) => {
                const priorityClass = c.priority >= 4 ? 'priority-badge-high' : c.priority >= 3 ? 'priority-badge-mid' : 'priority-badge-low';
                const borderClass = c.priority >= 4 ? 'border-indigo-300 bg-indigo-50' : c.priority >= 3 ? 'border-indigo-200 bg-slate-50' : 'border-gray-200 bg-gray-50';
                return `
                    <div class="cluster-card border-2 ${borderClass} rounded-xl p-4" onclick="selectCluster(${idx})">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-gray-800">${c.name}</h4>
                            <span class="${priorityClass} text-white text-xs px-2 py-1 rounded-full">優先度${c.priority}</span>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">${c.keywords.length}キーワード</div>
                        <div class="flex flex-wrap gap-1">
                            ${c.keywords.slice(0, 3).map(k => `<span class="text-xs bg-white px-2 py-1 rounded border">${k.keyword.length > 15 ? k.keyword.slice(0, 15) + '...' : k.keyword}</span>`).join('')}
                            ${c.keywords.length > 3 ? `<span class="text-xs text-gray-400">+${c.keywords.length - 3}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // 優先度TOP20
            const priorityTable = document.getElementById('priority-table');
            priorityTable.innerHTML = keywords.slice(0, 20).map((kw, i) => {
                const sources = getPrimarySources(kw.keyword);
                const sourceLink = sources.length > 0
                    ? `<a href="${sources[0].url}" target="_blank" class="text-indigo-600 underline text-xs">参照</a>`
                    : '-';
                const intentColor = kw.intent === '購入意向' ? 'text-indigo-700 font-semibold' : kw.intent === '比較検討' ? 'text-indigo-500' : 'text-slate-500';
                const volumeDisplay = kw.volume >= 1000 ? (kw.volume / 1000).toFixed(1) + 'K' : kw.volume;
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-bold text-indigo-600">${i + 1}</td>
                        <td class="p-3">${kw.keyword}</td>
                        <td class="p-3 text-center text-gray-500 text-sm">${volumeDisplay}</td>
                        <td class="p-3 text-center"><span class="${intentColor} text-xs font-medium">${kw.intent}</span></td>
                        <td class="p-3 text-center"><span class="font-semibold">${kw.cvExpect}%</span></td>
                        <td class="p-3 text-center">${sourceLink}</td>
                    </tr>
                `;
            }).join('');
        }

        // ========== 一次情報取得 ==========
        function getPrimarySources(keyword) {
            const sources = [];
            const addedUrls = new Set();
            for (const [key, items] of Object.entries(primarySources)) {
                if (keyword.includes(key)) {
                    items.forEach(item => {
                        if (!addedUrls.has(item.url)) {
                            sources.push(item);
                            addedUrls.add(item.url);
                        }
                    });
                }
            }
            if (sources.length === 0) {
                sources.push({ title: '厚生労働省 - 安全衛生関係', url: 'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/anzen/index.html' });
            }
            return sources;
        }

        // ========== クラスター選択 ==========
        // クラスター名から推奨記事タイプを判定
        function getRecommendedArticleType(clusterName) {
            const name = clusterName.toLowerCase();

            // テスト対策系 → チェックリスト（優先度高）
            if (/テスト|答え|例文|記入例|ワークシート|グループ討議/.test(name)) {
                return { type: 'checklist', reason: 'テスト対策・記入例の検索意図' };
            }
            // オンライン・Web受講系 → ハウツー
            if (/オンライン|web|ウェブ|eラーニング|通信/.test(name)) {
                return { type: 'howto', reason: 'オンライン受講方法の検索意図' };
            }
            // 更新・期限系 → FAQ
            if (/更新|期限|期限切れ|有効期限|5年|しないとどうなる/.test(name)) {
                return { type: 'faq', reason: '更新・期限に関する疑問' };
            }
            // 能力向上・再教育系 → ハウツー
            if (/能力向上|再教育|スキルアップ/.test(name)) {
                return { type: 'howto', reason: '再教育・能力向上の受講方法' };
            }
            // 地域系 → 選び方ガイド
            if (/東京|大阪|名古屋|神奈川|福岡|愛知|埼玉|千葉|札幌|横浜|京都|地域|エリア/.test(name)) {
                return { type: 'comparison', reason: '地域別講座の選び方' };
            }
            // 費用・手当・料金系 → 選び方ガイド
            if (/費用|料金|価格|相場|いくら|安い|手当|助成金/.test(name)) {
                return { type: 'comparison', reason: '費用比較・手当情報の検索意図' };
            }
            // 関連資格・責任者系 → 用語解説
            if (/資格|免許|責任者|推進者|統括|違い/.test(name)) {
                return { type: 'glossary', reason: '資格・役職の基礎知識' };
            }
            // 「とは」・基礎知識系 → 用語解説
            if (/とは|基礎|概要|意味|定義|内容|役割|職務/.test(name)) {
                return { type: 'glossary', reason: '基礎知識の検索意図' };
            }
            // 手順・方法系 → ハウツー
            if (/方法|手順|流れ|やり方|受け方|申し込み|取り方|受講/.test(name)) {
                return { type: 'howto', reason: '手順解説の検索意図' };
            }
            // 比較・違い系 → 選び方ガイド
            if (/比較|種類|選び方|おすすめ|ランキング/.test(name)) {
                return { type: 'comparison', reason: '比較検討の検索意図' };
            }
            // 法改正・義務化系 → ニュース
            if (/法改正|義務化|改正|新制度|いつから/.test(name)) {
                return { type: 'news', reason: '法改正情報の検索意図' };
            }
            // 持ち物・準備系 → チェックリスト
            if (/持ち物|準備|必要なもの|チェック/.test(name)) {
                return { type: 'checklist', reason: '準備確認の検索意図' };
            }
            // デフォルト → ピラー記事
            return { type: 'pillar', reason: '総合的な情報ニーズ' };
        }

        // おすすめラベルを更新
        function updateRecommendedLabel(recommendedType) {
            // 既存のおすすめラベルを削除
            document.querySelectorAll('.recommend-badge').forEach(el => el.remove());

            // 推奨タイプにラベルを追加
            const radio = document.querySelector(`input[name="article-type"][value="${recommendedType}"]`);
            if (radio) {
                const labelDiv = radio.nextElementSibling;
                const titleDiv = labelDiv.querySelector('.flex.items-center.justify-between');
                if (titleDiv && !titleDiv.querySelector('.recommend-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'recommend-badge text-[10px] px-1.5 py-0.5 bg-yellow-100 text-yellow-700 rounded font-medium ml-1';
                    badge.textContent = 'おすすめ';
                    titleDiv.querySelector('.font-semibold').appendChild(badge);
                }
            }
        }

        function selectCluster(idx) {
            selectedClusterIndex = idx;
            const cluster = clusters[idx];
            document.getElementById('selected-cluster-name').textContent = `「${cluster.name}」の記事を設計`;
            document.getElementById('article-design-result').classList.add('hidden');
            goToStep(3);
            // 構成作成タブをデフォルトで表示
            showArticleMainTab('design');

            // 記事タイプを自動推奨
            const recommendation = getRecommendedArticleType(cluster.name);
            const radio = document.querySelector(`input[name="article-type"][value="${recommendation.type}"]`);
            if (radio) {
                radio.checked = true;
            }
            updateRecommendedLabel(recommendation.type);
        }

        // ========== 記事設計生成（プロ仕様・実データ活用版） ==========
        function generateArticleDesign() {
            if (selectedClusterIndex === null) {
                alert('グループを選択してください');
                return;
            }

            const cluster = clusters[selectedClusterIndex];
            const type = document.querySelector('input[name="article-type"]:checked').value;
            const mainKw = cluster.keywords[0]?.keyword || cluster.name;
            const year = new Date().getFullYear();

            // キーワードから教育種別を判定し、マスターデータを取得
            let eduKey = null;
            let eduData = null;

            const eduKeyMapping = [
                { patterns: ['職長'], key: '職長' },
                { patterns: ['フルハーネス'], key: 'フルハーネス' },
                { patterns: ['足場'], key: '足場' },
                { patterns: ['酸欠', '酸素欠乏'], key: '酸欠' },
                { patterns: ['粉じん', '粉塵'], key: '粉じん' },
                { patterns: ['低圧電気', '低圧'], key: '低圧電気' },
                { patterns: ['玉掛け', '玉掛'], key: '玉掛け' },
                { patterns: ['フォークリフト'], key: 'フォークリフト' }
            ];

            for (const mapping of eduKeyMapping) {
                if (mapping.patterns.some(p => mainKw.includes(p))) {
                    eduKey = mapping.key;
                    eduData = educationMasterData[eduKey];
                    break;
                }
            }

            // 地域キーワードの検出
            const allPrefectures = [
                '北海道', '青森', '岩手', '宮城', '秋田', '山形', '福島',
                '茨城', '栃木', '群馬', '埼玉', '千葉', '東京', '神奈川',
                '新潟', '富山', '石川', '福井', '山梨', '長野', '岐阜', '静岡', '愛知',
                '三重', '滋賀', '京都', '大阪', '兵庫', '奈良', '和歌山',
                '鳥取', '島根', '岡山', '広島', '山口', '徳島', '香川', '愛媛', '高知',
                '福岡', '佐賀', '長崎', '熊本', '大分', '宮崎', '鹿児島', '沖縄'
            ];

            // 主要都市も検出
            const majorCities = {
                '札幌': '北海道', '仙台': '宮城', 'さいたま': '埼玉', '横浜': '神奈川',
                '川崎': '神奈川', '名古屋': '愛知', '京都市': '京都', '神戸': '兵庫',
                '広島市': '広島', '北九州': '福岡', '福岡市': '福岡', '那覇': '沖縄'
            };

            let detectedRegion = null;
            let detectedPrefecture = null;

            // 都道府県を検出
            for (const pref of allPrefectures) {
                if (mainKw.includes(pref)) {
                    detectedRegion = pref;
                    detectedPrefecture = pref;
                    break;
                }
            }

            // 主要都市を検出
            if (!detectedRegion) {
                for (const [city, pref] of Object.entries(majorCities)) {
                    if (mainKw.includes(city)) {
                        detectedRegion = city;
                        detectedPrefecture = pref;
                        break;
                    }
                }
            }

            // 地域キーワードの場合の追加情報
            const isRegionalKeyword = !!detectedRegion;
            let regionalInfo = '';
            if (isRegionalKeyword) {
                regionalInfo = `
【地域キーワード検出】
この記事は「${detectedRegion}」をターゲットとした地域特化記事です。

★重複コンテンツ回避のため、以下の独自情報を必ず含めてください★
- ${detectedRegion}での受講場所・アクセス情報
- ${detectedRegion}周辺の教習所比較（3〜5箇所）
- ${detectedRegion}特有の需要（地域の主要産業に関連付け）
- ${detectedRegion}からの受講者の声・体験談
- ${detectedRegion}での出張講習の有無

【SEOポイント】
- タイトルに「${detectedRegion}」を含める
- H2見出しに最低1回「${detectedRegion}」を含める
- 地域名+サービス名の組み合わせをメタディスクリプションに含める
`;
            }

            // 実データから各種情報を取得（データがない場合はデフォルト値）
            const eduName = eduData?.name || mainKw;
            const lawRef = eduData?.law || '労働安全衛生法';
            const lawUrl = eduData?.lawUrl || 'https://elaws.e-gov.go.jp/';
            const totalHours = eduData?.totalHours || '○';
            const curriculum = eduData?.curriculum || [];
            const priceOnlineMin = eduData?.priceRange?.online?.min ? eduData.priceRange.online.min.toLocaleString() : '○○○○';
            const priceOnlineMax = eduData?.priceRange?.online?.max ? eduData.priceRange.online.max.toLocaleString() : '○○○○';
            const priceOfflineMin = eduData?.priceRange?.offline?.min ? eduData.priceRange.offline.min.toLocaleString() : '○○○○';
            const priceOfflineMax = eduData?.priceRange?.offline?.max ? eduData.priceRange.offline.max.toLocaleString() : '○○○○';
            const targetPerson = eduData?.targetPerson || '該当する作業に従事する者';
            const industries = eduData?.industries || '建設業など';
            const penalty = eduData?.penalty || '罰則あり';
            const validityPeriod = eduData?.validityPeriod || '法的義務なし';
            const recommendedRefresh = eduData?.recommendedRefresh || '定期的な再教育推奨';
            const onlineAvailable = eduData?.onlineAvailable !== false;
            const practicalRequired = eduData?.practicalRequired || false;
            const practicalNote = eduData?.practicalNote || '';

            // カリキュラムを文字列に変換
            let curriculumText = '';
            let gakkaHours = 0;
            let jitsugiHours = 0;
            if (curriculum.length > 0) {
                curriculum.forEach(c => {
                    if (c.subject.includes('実技')) {
                        jitsugiHours += c.hours;
                    } else {
                        gakkaHours += c.hours;
                    }
                });
                curriculumText = curriculum.map(c => `- ${c.subject}（${c.hours}時間）`).join('\n');
            }

            // 構成案・タイトル・メタを記事タイプ別に生成
            let outline = '';
            let titles = [];
            let metaDesc = '';
            let ctaGuide = '';
            let internalLinks = '';
            let schemaMarkup = '';
            let eeaTips = '';
            let aiDiffTips = '';

            // 競合分析データがある場合は活用
            const hasCompetitorData = competitorHeadingsData.mustHave && competitorHeadingsData.mustHave.length > 0;
            let competitorInsights = '';
            if (hasCompetitorData) {
                const mustHaveList = competitorHeadingsData.mustHave.slice(0, 5).map(h => `- ${h.text}`).join('\n');
                const diffList = competitorHeadingsData.kciUnique?.slice(0, 3).map(h => `- ${h.text}（${h.category}）`).join('\n') || '';
                competitorInsights = `
【競合分析に基づく推奨】
必須見出し（競合共通）:
${mustHaveList}

差別化ポイント（競合にない独自性）:
${diffList}
`;
            }

            // KCI教育センターの講座URLを取得
            const courseUrl = kciSiteInfo.courses[eduKey]?.page || kciSiteInfo.pages.courseInfo;

            if (type === 'pillar') {
                // =============================================
                // ピラー記事：網羅的な総合ガイド（実データ反映版）
                // =============================================
                outline = `# ${eduName}完全ガイド【${year}年最新版】

## ${eduName}とは？基本と法的根拠
${eduName}は、${lawRef}に基づき、${targetPerson}に対して義務付けられている教育です。

【この記事の信頼性】
※E-E-A-T強化ポイント※
- 執筆者情報を記載（例：「○○資格保有、現場経験○年の安全管理者が監修」）
- 参照法令へのリンクを明記
- 最終更新日を表示

### なぜ${eduName}が必要なのか
- 法的義務：${lawRef}
- 罰則：${penalty}
- 対象業種：${industries}

【CTA挿入ポイント①】
「今すぐ受講したい方はこちら」ボタン

## ${eduName}の受講対象者
### 受講が義務付けられている人
${targetPerson}

### 受講資格・条件
- 特別な資格は不要
- 年齢制限なし（実務経験も問われない）

【内部リンク①】
→「○○との違いを知りたい方はこちら」

## ${eduName}のカリキュラム・講習内容【全${totalHours}時間】
${gakkaHours > 0 ? `### 学科講習（${gakkaHours}時間）` : '### 講習科目'}
${curriculumText || '- 詳細カリキュラムは講座により異なります'}

${practicalRequired ? `### 実技講習（${jitsugiHours}時間）
${practicalNote ? `※注意：${practicalNote}` : '実技講習は対面で実施'}` : ''}

【差別化ポイント】
※現場経験に基づく具体例を追加※
「実際の講習では○○のような事例を学びます」

## ${eduName}の受講方法を比較
### オンライン講座
${onlineAvailable ? `- 受講可能
- メリット：場所を選ばない、費用が安い
- デメリット：${practicalRequired ? '実技は別途対面が必要' : '質問がしにくい場合がある'}` : '- オンライン受講不可（技能講習のため全課程対面必須）'}

### 対面講座
- 費用相場：${priceOfflineMin}円〜${priceOfflineMax}円
- メリット：実技もまとめて受講可能、その場で質問できる
- デメリット：会場まで行く必要がある

【CTA挿入ポイント②】
オンライン・対面それぞれの申込ボタン

## ${eduName}の費用・料金相場【${year}年最新】
### 受講料の目安
${onlineAvailable ? `| 受講形式 | 料金相場 |
|---------|---------|
| オンライン | ${priceOnlineMin}円〜${priceOnlineMax}円 |
| 対面講座 | ${priceOfflineMin}円〜${priceOfflineMax}円 |` : `| 受講形式 | 料金相場 |
|---------|---------|
| 対面講座 | ${priceOfflineMin}円〜${priceOfflineMax}円 |`}

## 修了証について
### 有効期限
${validityPeriod}

### 再教育（能力向上教育）
${recommendedRefresh}

### 修了証の再発行
受講した機関に連絡すれば可能（手数料が発生する場合あり）

## よくある質問
### Q. ${eduName}を受講しないとどうなる？
A. 事業者に対して${penalty}が科される可能性があります。

### Q. 最短何日で取得できる？
A. ${onlineAvailable ? 'オンライン講座なら最短1〜2日で修了可能です。' : `講習時間は合計${totalHours}時間のため、通常2〜4日かかります。`}

### Q. 修了試験はありますか？
A. 多くの講座では理解度確認テストがありますが、事前に学習すれば問題ありません。

## まとめ：${eduName}を受講するなら

【CTA挿入ポイント③】最終CTA
- 「当社のオンライン講座はこちら」
- 受講料、所要時間、特徴を再掲`;

                titles = [
                    `【${year}年版】${eduName}とは？対象者・内容・費用${priceOnlineMin ? '（' + priceOnlineMin + '円〜）' : ''}を完全解説`,
                    `${eduName}完全ガイド｜全${totalHours}時間のカリキュラムから料金相場まで`,
                    `${eduName}の全知識｜${lawRef}の義務・対象者・費用【${year}年最新】`
                ];
                metaDesc = `${eduName}を徹底解説。${targetPerson}が対象。講習時間は全${totalHours}時間、費用相場は${onlineAvailable ? priceOnlineMin + '円〜' + priceOnlineMax + '円（オンライン）' : priceOfflineMin + '円〜' + priceOfflineMax + '円'}。${lawRef}に基づく法的義務から修了証の有効期限まで網羅。`;

                // E-E-A-T強化ガイド
                eeaTips = `【E-E-A-T強化チェックリスト】
□ 執筆者プロフィールを記載（資格・経験年数）
□ 監修者情報を追加（可能であれば顔写真も）
□ 参照した法令・公的資料のリンクを明記
□ 最終更新日を表示
□ 現場での実体験に基づくエピソードを追加
□ 具体的な数字（${totalHours}時間、${priceOnlineMin}円〜など）を使用`;

                // CTA設計ガイド（KCI教育センター用）
                ctaGuide = `【CTA設計ガイド - KCI教育センター】
1. リード文直後（ファーストビュー）
   → 「KCI教育センターで${eduName}を受講する」ボタン
   → リンク先：${courseUrl}

2. 受講方法セクション
   → 「eラーニング講座を見る」リンク
   → リンク先：${kciSiteInfo.pages.elearning}
   → 「ZOOM講習の詳細」リンク
   → リンク先：${kciSiteInfo.pages.online}

3. 費用セクション
   → 「KCI教育センターの料金を確認」ボタン
   → リンク先：${courseUrl}

4. まとめセクション（最重要）
   → メインCTA：「今すぐ申し込む」
   → リンク先：${kciSiteInfo.pages.application}
   → サブCTA：「講座一覧を見る」
   → リンク先：${kciSiteInfo.pages.courseInfo}

【KCI教育センターの強み（CTA訴求ポイント）】
✓ ${kciSiteInfo.features.join('\n✓ ')}`;

                // 内部リンク設計（KCI教育センター用）
                internalLinks = `【内部リンク設計 - KCI教育センター】
■ このピラー記事からリンクすべきページ：

【サービスページへの内部リンク】
- 講座申込ページ → ${kciSiteInfo.pages.application}
- eラーニング講座一覧 → ${kciSiteInfo.pages.elearning}
- オンライン講座（ZOOM） → ${kciSiteInfo.pages.online}
- ${eduName}詳細ページ → ${courseUrl}

【関連記事へのリンク（トピッククラスター）】
- 「${eduName}の費用・料金」詳細記事
- 「${eduName}のカリキュラム」詳細記事
- 「${eduName} オンライン おすすめ」記事
- 「${eduName}と○○の違い」比較記事
- 「${eduName} よくある質問」記事

【逆リンク設計】
上記すべての関連記事から、このピラー記事（${eduName}完全ガイド）へリンクを設置

【サイト回遊導線】
記事下部に「関連する講座」として他の教育種別へのリンクを設置：
- 職長教育 → ${kciSiteInfo.pages.shokucho}
- 講座一覧 → ${kciSiteInfo.pages.courseInfo}`;

                // 構造化データ
                schemaMarkup = `【構造化データ（FAQPage Schema）】
よくある質問セクションに以下のJSON-LDを実装：

&lt;script type="application/ld+json"&gt;
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "${eduName}を受講しないとどうなる？",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "事業者に対して${penalty}が科される可能性があります。"
      }
    },
    {
      "@type": "Question",
      "name": "${eduName}は最短何日で取得できる？",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "${onlineAvailable ? 'オンライン講座なら最短1〜2日で修了可能です。' : '講習時間は合計' + totalHours + '時間のため、通常2〜4日かかります。'}"
      }
    }
  ]
}
&lt;/script&gt;`;

                // AI記事との差別化
                aiDiffTips = `【AI記事との差別化ポイント】
□ 現場でよくある失敗事例を追加（実体験ベース）
□ 「受講者の声」を掲載（実在の受講者から取材）
□ 写真・図解を追加（オリジナルの講習風景など）
□ 地域別の講習会場情報を追加
□ 最新の法改正情報を反映（${year}年時点）
□ 「○○の場合はどうする？」ニッチな疑問に回答
□ 比較表にオリジナルの評価軸を追加`;

            } else if (type === 'howto') {
                // =============================================
                // ハウツー記事：手順・方法にフォーカス（実データ反映版）
                // =============================================
                outline = `# ${eduName}の受け方｜申し込みから修了証取得までの全手順【${year}年】

## この記事で分かること
- ${eduName}の申し込み方法
- 受講当日の流れ（全${totalHours}時間）
- 修了証の受け取り方

【執筆者情報】
※E-E-A-T：実際に受講した経験者または講師が執筆していることを明記※

【CTA挿入ポイント①】
「今すぐ申し込む方はこちら」

## 【前提知識】${eduName}とは
${eduName}は${lawRef}に基づく法定教育です。
${targetPerson}は必ず受講が必要です。

【内部リンク】→ 詳しくは「${eduName}完全ガイド」へ

## ${eduName}を受講する5つのステップ

### STEP1：受講する講座を選ぶ
#### オンライン講座を選ぶ場合（${onlineAvailable ? '受講可' : '受講不可'}）
${onlineAvailable ? `- 料金相場：${priceOnlineMin}円〜${priceOnlineMax}円
- 選ぶポイント：修了証即日発行、サポート体制
${practicalRequired ? `- 注意：${practicalNote}` : ''}` : '- この教育はオンライン受講ができません'}

#### 対面講座を選ぶ場合
- 料金相場：${priceOfflineMin}円〜${priceOfflineMax}円
- 選ぶポイント：会場のアクセス、日程の豊富さ

【差別化】講座選びの失敗談と対策を追加

### STEP2：申し込み手続きをする
- 必要な情報：氏名、生年月日、勤務先、連絡先
- 支払い方法：クレジットカード、銀行振込、請求書払い
- 申し込みから受講までの期間：通常1週間程度

【CTA挿入ポイント②】
「当社の講座はWebから簡単申込」

### STEP3：受講準備をする
- 届くもの：テキスト（事前送付の場合）、受講票、請求書
- 用意するもの：筆記用具、身分証明書（顔写真付き）
${onlineAvailable ? '- オンラインの場合：PC/タブレット、安定したネット環境' : ''}

### STEP4：講習を受講する（全${totalHours}時間）
#### 当日のスケジュール例
${curriculum.length > 0 ? curriculum.map(c => `- ${c.subject}：${c.hours}時間`).join('\n') : '- 学科講習\n- 理解度テスト'}

#### 遅刻・欠席した場合
- 遅刻：振替受講が必要になる場合あり
- 欠席：事前連絡で日程変更可能（講座による）

#### 修了試験について
- 形式：選択式または○×式が多い
- 合格率：事前学習すればほぼ100%

【差別化】実際の講習で「ここがポイント」になる部分を追加

### STEP5：修了証を受け取る
- 即日発行：オンライン講座の多くは対応
- 後日郵送：対面講座は1〜2週間後が多い
- 届かない場合：受講した機関に連絡

## 受講時の注意点・よくある失敗
${practicalRequired ? `- 実技講習を忘れずに：${practicalNote}` : ''}
- 身分証明書を忘れると受講できない場合あり
- オンラインは途中離席するとやり直しになることも

## まとめ：${eduName}受講の流れ
1. 講座を選ぶ
2. 申し込み
3. 事前準備
4. 受講（${totalHours}時間）
5. 修了証取得

【CTA挿入ポイント③】最終CTA
「当社のオンライン講座なら最短○日で修了証取得」`;

                titles = [
                    `${eduName}の受け方｜申し込みから修了証取得まで5ステップ【全${totalHours}時間】`,
                    `【初心者向け】${eduName}の受講手順を徹底ガイド【${year}年版】`,
                    `${eduName}はどうやって受ける？費用${priceOnlineMin}円〜の申し込み方法を解説`
                ];
                metaDesc = `${eduName}の受講方法を5ステップで解説。講習時間は全${totalHours}時間、費用は${onlineAvailable ? priceOnlineMin + '円〜' : priceOfflineMin + '円〜'}。講座の選び方から修了証取得まで、初めての方にも分かりやすく説明します。`;

                eeaTips = `【E-E-A-T強化チェックリスト】
□ 実際に受講した経験を記載（受講日、会場など）
□ 講習当日の写真を追加（可能であれば）
□ 「私が受講したときは○○でした」という一人称の体験談
□ 具体的な時間・費用の数字を使用`;

                ctaGuide = `【CTA設計ガイド - KCI教育センター】
1. 冒頭（前提知識セクション後）
   → 「KCI教育センターの講座を見る」ボタン
   → リンク先：${courseUrl}

2. STEP1（講座を選ぶ）
   → 「eラーニング講座を見る」→ ${kciSiteInfo.pages.elearning}
   → 「ZOOM講習を見る」→ ${kciSiteInfo.pages.online}

3. STEP2（申し込み手続き）
   → 「KCI教育センターで申し込む」ボタン
   → リンク先：${kciSiteInfo.pages.application}

4. まとめセクション
   → メインCTA：「KCI教育センターで受講する」
   → リンク先：${kciSiteInfo.pages.application}

【KCI教育センターの特徴を訴求】
- 顔認証付きeラーニングで24時間受講可能
- 最短1日で修了証発行`;

                internalLinks = `【内部リンク設計 - KCI教育センター】
【サービスページへのリンク】
- 講座申込ページ → ${kciSiteInfo.pages.application}
- ${eduName}講座ページ → ${courseUrl}
- eラーニング一覧 → ${kciSiteInfo.pages.elearning}

【関連記事へのリンク】
- 「${eduName}完全ガイド」へリンク
- 「${eduName}の費用・料金」記事へリンク
- 「${eduName}おすすめ講座」記事へリンク`;

                schemaMarkup = `【構造化データ（HowTo Schema）】
&lt;script type="application/ld+json"&gt;
{
  "@context": "https://schema.org",
  "@type": "HowTo",
  "name": "${eduName}の受け方",
  "totalTime": "PT${totalHours}H",
  "step": [
    {"@type": "HowToStep", "name": "講座を選ぶ", "text": "オンラインまたは対面講座を選択"},
    {"@type": "HowToStep", "name": "申し込み", "text": "必要事項を入力して申込"},
    {"@type": "HowToStep", "name": "受講準備", "text": "テキストと身分証明書を用意"},
    {"@type": "HowToStep", "name": "受講", "text": "全${totalHours}時間の講習を受講"},
    {"@type": "HowToStep", "name": "修了証取得", "text": "修了証を受け取る"}
  ]
}
&lt;/script&gt;`;

                aiDiffTips = `【AI記事との差別化ポイント】
□ 実際の申込画面のスクリーンショットを追加
□ 講習当日の持ち物リスト（写真付き）
□ 「私が受講したときの失敗談」を追加
□ 講習会場の雰囲気を伝える写真
□ 実際の修了証の画像（個人情報は隠す）`;

            } else if (type === 'comparison') {
                // =============================================
                // 講座の選び方＋自社紹介記事（ランキングなし）
                // =============================================
                outline = `# ${eduName}の講座の選び方｜失敗しない3つのポイント【${year}年版】

【この記事の信頼性】
※E-E-A-T：安全教育の専門機関として、講座選びのポイントを解説※

## ${eduName}講座を選ぶ3つのポイント

### ポイント1：受講形式で選ぶ
${onlineAvailable ? `■ オンライン講座（eラーニング・ZOOM）
- メリット：時間・場所を選ばない、費用${priceOnlineMin}円〜
- デメリット：自己管理が必要
${practicalRequired ? `- 注意点：${practicalNote}` : ''}

■ 対面講座
- メリット：実技もまとめて受講可能、講師に直接質問できる
- デメリット：日程・場所の制約あり
- 費用相場：${priceOfflineMin}円〜${priceOfflineMax}円` : `この講習は技能講習のため、対面での受講が必要です。
- 費用相場：${priceOfflineMin}円〜${priceOfflineMax}円`}

### ポイント2：料金だけで選ばない
- オンライン相場：${onlineAvailable ? `${priceOnlineMin}円〜${priceOnlineMax}円` : '対応講座なし'}
- 対面相場：${priceOfflineMin}円〜${priceOfflineMax}円

料金以外にチェックすべき点：
- 修了証の発行スピード
- サポート体制（質問対応など）
- 不正受講防止の仕組み（企業として重要）

### ポイント3：信頼性・コンプライアンスで選ぶ
- 修了証が正式に発行されるか
- 受講記録が適切に管理されているか
- 不正受講を防止する仕組みがあるか

【CTA挿入ポイント①】
「講座を探している方はこちら」

## KCI教育センターの${eduName}講座

当センターでは、以下の特徴で${eduName}を提供しています。

### 受講形式
${onlineAvailable ? `- eラーニング（顔認証付き）：24時間いつでも受講可能
- ZOOM講習：リアルタイムで講師とやり取り
- 対面講習：全国の会場で開催` : `- 対面講習：全国の会場で開催`}

### 講習時間
- 全${totalHours}時間

### KCI教育センターの5つの特徴

**1. 顔認証付きeラーニング**
不正受講を防止し、企業のコンプライアンスをサポート。
労働基準監督署の調査にも安心して対応できます。

**2. 最短1日で修了証発行**
急ぎで資格が必要な方にも対応。
eラーニングなら受講完了後すぐに修了証をダウンロード可能。

**3. 土日も開催**
平日は現場で忙しい方も、土日に受講できます。

**4. 全国対応**
eラーニング・ZOOMなら全国どこからでも受講可能。
対面講習も各地で開催しています。

**5. 充実のサポート体制**
受講中の質問対応、修了証の再発行など、受講後もサポート。

【CTA挿入ポイント②】
「KCI教育センターの講座を見る」→ ${courseUrl}

## こんな方におすすめ

- 忙しくて講習会場に行く時間がない方
- すぐに修了証が必要な方
- 企業としてコンプライアンスを重視している方
- 複数名の社員をまとめて受講させたい方

【内部リンク】
→「${eduName}とは？基礎知識を確認する」

## まとめ

${eduName}の講座を選ぶ際は、料金だけでなく「受講形式」「信頼性」「サポート体制」も重要です。

KCI教育センターでは：
- 顔認証付きeラーニングで不正受講を防止
- 最短1日で修了証発行
- 土日も開催、全国対応

【CTA挿入ポイント③】最終CTA
「${eduName}の講座を見る」→ ${courseUrl}
「今すぐ申し込む」→ ${kciSiteInfo.pages.application}`;

                titles = [
                    `${eduName}の講座の選び方｜失敗しない3つのポイント【${year}年版】`,
                    `${eduName}はどこで受ける？講座選びのコツと料金相場を解説`,
                    `【${year}年】${eduName}講座の選び方ガイド｜受講形式・費用・サポートで比較`
                ];
                metaDesc = `${eduName}の講座選びで失敗しないためのポイントを解説。受講形式（eラーニング・ZOOM・対面）、料金相場${onlineAvailable ? priceOnlineMin + '円〜' : priceOfflineMin + '円〜'}、サポート体制など、チェックすべき項目を詳しく紹介します。`;

                eeaTips = `【E-E-A-T強化チェックリスト】
□ 安全教育の専門機関としての立場を明記
□ 選び方のポイントに具体的な理由を記載
□ 料金は税込/税抜を明記
□ 各受講形式のメリット・デメリットを公平に記載
□ 実際の受講者の声を追加（可能であれば）`;

                ctaGuide = `【CTA設計ガイド - KCI教育センター】
1. 選び方セクション後
   → 「講座を探している方はこちら」ボタン
   → リンク先：${kciSiteInfo.pages.courseInfo}

2. KCI教育センター紹介セクション
   → 「講座の詳細を見る」ボタン
   → リンク先：${courseUrl}

3. まとめセクション
   → メインCTA：「${eduName}の講座を見る」
   → リンク先：${courseUrl}
   → サブCTA：「今すぐ申し込む」
   → リンク先：${kciSiteInfo.pages.application}`;

                internalLinks = `【内部リンク設計 - KCI教育センター】
【サービスページへのリンク】
- 講座申込ページ → ${kciSiteInfo.pages.application}
- ${eduName}講座ページ → ${courseUrl}
- eラーニング講座一覧 → ${kciSiteInfo.pages.elearning}

【関連記事へのリンク】
- 「${eduName}完全ガイド」ピラー記事へリンク
- 「${eduName}の費用・料金」詳細記事へリンク`;

                schemaMarkup = `【構造化データ（Article Schema）】
&lt;script type="application/ld+json"&gt;
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "${eduName}の講座の選び方｜失敗しない3つのポイント",
  "author": {
    "@type": "Organization",
    "name": "KCI教育センター",
    "url": "${kciSiteInfo.pages.top}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "KCI教育センター"
  }
}
&lt;/script&gt;`;

                aiDiffTips = `【AI記事との差別化ポイント】
□ 自社の講座運営経験に基づく選び方のアドバイス
□ 講座の申込画面・受講画面のスクリーンショット
□ 実際に受講した人のインタビュー・感想
□ 「○○な人にはこの受講形式がおすすめ」具体的なペルソナ別提案
□ 不正受講防止の重要性など、企業目線の情報を追加`;

            } else if (type === 'faq') {
                // =============================================
                // FAQ記事：Q&A形式（実データ反映版）
                // =============================================
                outline = `# ${eduName}のよくある質問｜費用・時間・オンラインの疑問を解決【${year}年】

【この記事の信頼性】
※E-E-A-T：${lawRef}に基づく正確な情報、講師経験者が回答※

## ${eduName}の基本に関する質問

### Q1. ${eduName}とは何ですか？
A. ${eduName}は、${lawRef}に基づき、${targetPerson}に対して義務付けられている法定教育です。対象業種は${industries}などです。

### Q2. ${eduName}は誰が受講する必要がありますか？
A. ${targetPerson}は受講が必要です。
具体例：
- ○○の作業に従事する方
- ○○を行う現場の作業員

### Q3. ${eduName}を受講しないとどうなりますか？
A. 事業者に対して${penalty}が科される可能性があります。また、無資格者による作業は労災事故発生時に重大な問題となります。

【CTA挿入ポイント①】
「今すぐ受講する」ボタン

## 受講方法に関する質問

### Q4. ${eduName}はオンラインで受講できますか？
A. ${onlineAvailable ? `はい、オンラインで受講可能です。${practicalRequired ? `ただし、${practicalNote}` : '学科講習はすべてオンラインで完結します。'}` : 'いいえ、この講習は技能講習のため、全課程対面での受講が必要です。'}

### Q5. ${eduName}の講習時間はどのくらいですか？
A. 合計${totalHours}時間です。
${curriculum.length > 0 ? curriculum.map(c => `- ${c.subject}：${c.hours}時間`).join('\n') : '詳細なカリキュラムは講座により異なります。'}

### Q6. 最短何日で修了証を取得できますか？
A. ${onlineAvailable ? `オンライン講座なら最短1〜2日で修了証取得可能です。即日発行に対応している講座もあります。` : `講習時間は合計${totalHours}時間のため、通常2〜4日かかります。`}

## 費用に関する質問

### Q7. ${eduName}の受講料はいくらですか？
A. 受講形式により異なります。
${onlineAvailable ? `- オンライン：${priceOnlineMin}円〜${priceOnlineMax}円
- 対面講座：${priceOfflineMin}円〜${priceOfflineMax}円` : `- 対面講座：${priceOfflineMin}円〜${priceOfflineMax}円`}

## 修了証に関する質問

### Q8. 修了証に有効期限はありますか？
A. ${validityPeriod}。ただし、${recommendedRefresh}。

### Q9. 修了証を紛失した場合は再発行できますか？
A. はい、受講した機関に連絡すれば再発行可能です（手数料1,000〜3,000円程度）。

## その他の質問

### Q10. 他の教育との違いは？
A. ${eduKey === '職長' ? '職長教育は現場監督者向け、特別教育は作業者向けという違いがあります。' : '詳細は関連記事をご確認ください。'}

【内部リンク】→「${eduName}と○○の違いを解説」

### Q11. 試験に落ちることはありますか？
A. 修了試験は理解度確認が目的のため、講習内容を理解していれば問題ありません。万が一不合格でも、再テストを受けられる講座がほとんどです。

## まとめ
${eduName}についてよくある質問に回答しました。
- 対象者：${targetPerson}
- 講習時間：${totalHours}時間
- 費用：${onlineAvailable ? priceOnlineMin + '円〜' : priceOfflineMin + '円〜'}

【CTA挿入ポイント②】最終CTA
「${eduName}を受講する」ボタン`;

                titles = [
                    `${eduName}のよくある質問｜費用${onlineAvailable ? priceOnlineMin + '円〜' : priceOfflineMin + '円〜'}・時間${totalHours}時間の疑問を解決`,
                    `【Q&A】${eduName}の疑問11選｜${lawRef}の義務から受講方法まで`,
                    `${eduName}FAQ｜費用・有効期限・オンライン受講の疑問に全回答【${year}年】`
                ];
                metaDesc = `${eduName}に関するよくある質問に回答。費用相場${onlineAvailable ? priceOnlineMin + '円〜' + priceOnlineMax + '円' : priceOfflineMin + '円〜' + priceOfflineMax + '円'}、講習時間${totalHours}時間、オンライン受講${onlineAvailable ? '可' : '不可'}など。${lawRef}に基づく正確な情報でお答えします。`;

                eeaTips = `【E-E-A-T強化チェックリスト】
□ 法令の正確な条文番号を記載
□ 回答の根拠（厚生労働省サイトなど）へリンク
□ 「よくある誤解」を正す内容を追加
□ 回答者のプロフィール（講師経験など）を明記`;

                ctaGuide = `【CTA設計ガイド - KCI教育センター】
1. Q3（受講しないとどうなる？）の後
   → 「KCI教育センターで今すぐ受講する」ボタン
   → リンク先：${kciSiteInfo.pages.application}

2. Q4（オンラインで受講できる？）の後
   → 「顔認証付きeラーニングを見る」ボタン
   → リンク先：${kciSiteInfo.pages.elearning}

3. Q7（費用）の後
   → 「KCI教育センターの料金を確認」ボタン
   → リンク先：${courseUrl}

4. まとめセクション
   → メインCTA：「KCI教育センターで${eduName}を受講する」
   → リンク先：${kciSiteInfo.pages.application}

【回答で訴求できるKCIの強み】
- Q4回答内：「KCI教育センターでは顔認証付きeラーニングで24時間受講可能」
- Q6回答内：「KCI教育センターなら最短1日で修了証発行」`;

                internalLinks = `【内部リンク設計 - KCI教育センター】
【サービスページへのリンク】
- 講座申込ページ → ${kciSiteInfo.pages.application}
- ${eduName}講座ページ → ${courseUrl}
- eラーニング一覧 → ${kciSiteInfo.pages.elearning}
- ZOOM講習 → ${kciSiteInfo.pages.online}

【関連記事へのリンク】
- 「${eduName}完全ガイド」へリンク
- 「${eduName}の費用・料金」詳細記事へリンク
- 「${eduName}おすすめ講座」記事へリンク
- 「${eduName}と○○の違い」記事へリンク`;

                schemaMarkup = `【構造化データ（FAQPage Schema）】
&lt;script type="application/ld+json"&gt;
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "${eduName}とは何ですか？",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "${eduName}は、${lawRef}に基づき、${targetPerson}に対して義務付けられている法定教育です。"
      }
    },
    {
      "@type": "Question",
      "name": "${eduName}の講習時間はどのくらいですか？",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "合計${totalHours}時間です。"
      }
    },
    {
      "@type": "Question",
      "name": "${eduName}の受講料はいくらですか？",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "${onlineAvailable ? 'オンライン：' + priceOnlineMin + '円〜' + priceOnlineMax + '円、対面：' + priceOfflineMin + '円〜' + priceOfflineMax + '円' : '対面講座：' + priceOfflineMin + '円〜' + priceOfflineMax + '円'}"
      }
    },
    {
      "@type": "Question",
      "name": "修了証に有効期限はありますか？",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "${validityPeriod}。ただし、${recommendedRefresh}。"
      }
    }
  ]
}
&lt;/script&gt;`;

                aiDiffTips = `【AI記事との差別化ポイント】
□ 実際の受講者から寄せられた質問を追加
□ 「現場でよく聞かれる質問」セクションを追加
□ 回答に具体的な事例・エピソードを含める
□ 法改正による最新情報を反映（更新日を明記）`;

            } else if (type === 'case') {
                // =============================================
                // 事例・体験談記事：E-E-A-T強化用
                // =============================================
                outline = `# ${eduName}の受講体験談｜実際に受講した感想と学んだこと【${year}年】

【この記事のポイント】
※実体験に基づくE-E-A-T最強コンテンツ※
- 実際の受講者の声を掲載
- 現場での活用事例を紹介
- 受講前後の変化を具体的に記載

## ${eduName}を受講したきっかけ
### 受講前の状況
- どんな課題があったか
- なぜ受講が必要になったか
- 会社からの指示？自主的？

### ${eduName}を選んだ理由
- オンライン/対面どちらを選んだか
- 受講機関を選んだポイント
- 費用・時間・場所の条件

【CTA挿入ポイント①】
「私も${eduName}を受講する」ボタン

## 実際の講習内容と感想
### 講習の流れ
1. 受講申込（所要時間：約○分）
2. 教材・ログイン情報の受け取り
3. 講習受講（合計${totalHours}時間）
4. 修了試験
5. 修了証の発行

### 印象に残った講習内容
${curriculum.length > 0 ? curriculum.slice(0, 3).map(c => `- ${c.subject}：「○○が印象的だった」`).join('\n') : '- 具体的な事例が多く分かりやすかった'}

### 講習の難易度
- 予習は必要？→○○
- 試験の難しさ→○○
- 合格率の体感→○○

【写真・スクリーンショット挿入】
受講画面や修了証の写真（個人情報に注意）

## 現場での活用事例
### 受講後に変わったこと
- 安全意識の向上
- 作業手順の見直し
- 同僚への指導

### 実際に役立った場面
「○○の現場で△△を判断する際に、講習で学んだ□□の知識が役立った」

【内部リンク】
→「${eduName}の詳しいカリキュラムはこちら」

## 受講を検討している方へのアドバイス
### おすすめの受講形式
- ${onlineAvailable ? 'オンライン受講がおすすめな人：忙しい人、遠方の人' : '対面受講が基本です'}
- 対面受講がおすすめな人：実技をしっかり学びたい人

### 受講前に準備しておくこと
- ○○を確認しておく
- △△を用意しておく

### 費用を抑えるコツ
- 複数名でまとめて申し込み（団体割引）
- 会社負担で受講

【CTA挿入ポイント②】最終CTA
「${eduName}を受講する」ボタン

## まとめ：${eduName}を受講した感想
${eduName}を受講して、○○が一番の収穫でした。
特に現場で○○する際に、学んだ知識が役立っています。
これから受講する方は、○○に注意して取り組んでください。`;

                titles = [
                    `【体験談】${eduName}を受講した感想｜現場で役立った知識とは`,
                    `${eduName}受講レポート｜実際の講習内容と活用事例【${year}年】`,
                    `${eduName}を受講してみた｜難易度・所要時間・費用のリアルな感想`
                ];
                metaDesc = `${eduName}を実際に受講した体験談。講習内容、難易度、かかった費用、現場での活用事例を紹介。受講を検討中の方へのアドバイスも。`;

                eeaTips = `【E-E-A-T強化チェックリスト】
□ 実際の受講者情報（業種・経験年数など）を明記
□ 修了証の写真（個人情報は隠す）を掲載
□ 具体的な日時・場所・費用を記載
□ 受講前後のBefore/Afterを明確に
□ ネガティブな点も正直に記載（信頼性向上）`;

                ctaGuide = `【CTA設計ガイド - KCI教育センター】
1. 受講のきっかけセクション後
   → 「KCI教育センターで受講する」ボタン
   → リンク先：${courseUrl}

2. 講習内容セクション内
   → 「顔認証付きeラーニングを見る」ボタン
   → リンク先：${kciSiteInfo.pages.elearning}

3. まとめセクション
   → メインCTA：「私も${eduName}を受講する」
   → リンク先：${kciSiteInfo.pages.application}

【体験談で訴求できるKCIの強み】
- 「KCI教育センターで受講して○○が良かった」という具体的な体験
- 顔認証システムの使いやすさ
- サポート対応の良さ
- 修了証発行の速さ`;

                internalLinks = `【内部リンク設計】
【サービスページへのリンク】
- 「${eduName}の詳細・申込」→ ${courseUrl}
- 「他の受講者の声」→ 別の体験談記事
- 「${eduName}とは」→ ピラー記事
- 「よくある質問」→ FAQ記事`;

                aiDiffTips = `【AI記事との差別化ポイント】
□ 実際の受講体験に基づく一次情報
□ 受講画面・修了証の実物写真
□ 具体的な数字（費用○円、時間○分）
□ 失敗談・反省点も正直に記載
□ 現場での具体的な活用エピソード`;

            } else if (type === 'glossary') {
                // =============================================
                // 用語解説記事：「〇〇とは」系
                // =============================================
                outline = `# ${eduName}とは？基本から分かりやすく解説【${year}年版】

【この記事で分かること】
- ${eduName}の定義と目的
- 法律上の根拠と義務
- 受講対象者と受講方法

## ${eduName}とは
${eduName}とは、${lawRef}に基づき実施される法定教育です。
${targetPerson}に対して、○○に関する知識と技能を身につけさせることを目的としています。

### 一言でいうと
「○○の作業を行う人が、安全に作業するために受ける教育」です。

【CTA挿入ポイント①】
「${eduName}を受講する」ボタン

## ${eduName}の法的根拠
### 根拠法令
${lawRef}

### 条文の要点
- 事業者の義務として○○が定められている
- 違反した場合：${penalty}

【参照リンク】
→ e-Gov法令検索：${lawUrl}

## ${eduName}と似た教育との違い
### ${eduName} vs ○○教育
| 項目 | ${eduName} | ○○教育 |
|------|------------|---------|
| 対象者 | ${targetPerson} | △△ |
| 時間 | ${totalHours}時間 | □□時間 |
| 根拠法令 | ${lawRef} | △△法 |

### よくある混同
- 「特別教育」と「技能講習」の違い
- 「安全衛生教育」と「特別教育」の違い

【内部リンク】
→「特別教育と技能講習の違いを詳しく解説」

## ${eduName}の受講対象者
### 受講が義務の人
${targetPerson}

### 具体的には
- ○○の作業に従事する人
- △△を行う現場の作業員
- □□を操作する人

### 受講しなくてもよい人
- ○○の資格をすでに持っている人
- △△の経験が○年以上ある人（一部免除）

## ${eduName}の受講方法と費用
### 受講形式
${onlineAvailable ? `- オンライン講座：${priceOnlineMin}円〜${priceOnlineMax}円
- 対面講座：${priceOfflineMin}円〜${priceOfflineMax}円` : `- 対面講座のみ：${priceOfflineMin}円〜${priceOfflineMax}円`}

### 講習時間
合計${totalHours}時間

【CTA挿入ポイント②】
「${eduName}を申し込む」ボタン

## まとめ：${eduName}の基本ポイント
- **定義**：${lawRef}に基づく法定教育
- **対象者**：${targetPerson}
- **時間**：${totalHours}時間
- **費用**：${onlineAvailable ? priceOnlineMin + '円〜' : priceOfflineMin + '円〜'}

【関連記事】
→ ${eduName}の完全ガイド（ピラー記事へ）
→ ${eduName}のよくある質問（FAQ記事へ）`;

                titles = [
                    `${eduName}とは？初心者向けに分かりやすく解説【${year}年】`,
                    `【基礎知識】${eduName}とは｜法的義務・対象者・費用を解説`,
                    `${eduName}の意味と目的｜${lawRef}の基本を分かりやすく`
                ];
                metaDesc = `${eduName}とは、${lawRef}に基づく法定教育です。対象者は${targetPerson}。講習時間${totalHours}時間、費用${onlineAvailable ? priceOnlineMin + '円〜' : priceOfflineMin + '円〜'}。基本から分かりやすく解説。`;

                eeaTips = `【E-E-A-T強化チェックリスト】
□ 法令の正確な条文番号・条項を記載
□ 厚生労働省・e-Govへのリンクを設置
□ 最終更新日を明記
□ 監修者情報（資格・経験）を記載`;

                ctaGuide = `【CTA設計ガイド】
1. 定義セクション後
   → 「${eduName}を受講する」ボタン
   → リンク先：${courseUrl}

2. まとめセクション
   → 「今すぐ申し込む」ボタン
   → リンク先：${kciSiteInfo.pages.application}`;

                internalLinks = `【内部リンク設計】
- 「詳しい受講方法」→ ハウツー記事
- 「費用の相場」→ 選び方ガイド記事
- 「よくある質問」→ FAQ記事
- 「受講体験談」→ 事例記事`;

                aiDiffTips = `【AI記事との差別化ポイント】
□ 法令の最新改正情報を反映
□ 現場経験者の補足説明を追加
□ 実際の修了証・講習風景の写真
□ よくある誤解・間違いを訂正`;

            } else if (type === 'checklist') {
                // =============================================
                // チェックリスト記事：実用的なリスト形式
                // =============================================
                outline = `# ${eduName}受講前の準備チェックリスト｜持ち物・確認事項まとめ【${year}年】

【この記事の使い方】
印刷またはブックマークして、受講前にチェックしてください。

## 受講申込前のチェックリスト
### 受講資格の確認
- [ ] 自分が受講対象者か確認した
- [ ] 上司・会社に受講許可を得た
- [ ] 受講日程を確保した（${totalHours}時間）

### 受講形式の選択
- [ ] オンラインか対面か決めた
${practicalRequired ? '- [ ] 実技講習の日程も確認した' : ''}
- [ ] 費用を確認した（${onlineAvailable ? priceOnlineMin + '円〜' : priceOfflineMin + '円〜'}）

【CTA挿入ポイント①】
「${eduName}を申し込む」ボタン

## 申込時のチェックリスト
### 必要な情報
- [ ] 氏名（本人確認書類と同じ表記）
- [ ] 生年月日
- [ ] 住所
- [ ] 連絡先（電話番号・メールアドレス）
- [ ] 勤務先情報
- [ ] 支払い方法

### 確認事項
- [ ] 受講日時を確認した
- [ ] キャンセルポリシーを確認した
- [ ] 修了証の発行方法を確認した

## 受講当日の持ち物リスト
### オンライン受講の場合
- [ ] PC・タブレット（推奨スペック確認済み）
- [ ] 安定したインターネット環境
- [ ] ヘッドホン・イヤホン
- [ ] 本人確認書類（顔認証用）
- [ ] 筆記用具（メモ用）
- [ ] 受講に集中できる環境

### 対面講座の場合
- [ ] 本人確認書類（運転免許証など）
- [ ] 受講票・申込確認メール
- [ ] 筆記用具
- [ ] 昼食・飲み物（長時間の場合）
${practicalRequired ? '- [ ] 作業着・安全靴（実技用）\n- [ ] ヘルメット（貸出の場合もあり）' : ''}

## 受講中のチェックリスト
### オンライン受講の注意点
- [ ] 顔認証が正常に動作している
- [ ] カメラから離席していない
- [ ] 集中して受講している
- [ ] 分からない点はメモしている

### 修了試験対策
- [ ] 講習内容を復習した
- [ ] 重要ポイントをメモした

【内部リンク】
→「修了試験の出題傾向と対策」

## 受講後のチェックリスト
### 修了証の確認
- [ ] 修了証を受け取った
- [ ] 記載内容（氏名・生年月日など）に誤りがない
- [ ] 修了証のコピーを保管した
- [ ] 会社に修了報告をした

## 修了証の保管について
### 保管のポイント
- 原本は大切に保管
- コピーを複数取っておく
- データ化してクラウド保存も推奨

### 紛失した場合
- 受講機関に再発行を依頼（手数料：1,000〜3,000円程度）

【CTA挿入ポイント②】
「${eduName}を受講する」ボタン`;

                titles = [
                    `【保存版】${eduName}受講前チェックリスト｜持ち物・準備・当日の流れ`,
                    `${eduName}の準備完全ガイド｜申込から修了証取得までのチェックリスト`,
                    `${eduName}受講に必要なもの一覧｜忘れ物ゼロで当日を迎える方法`
                ];
                metaDesc = `${eduName}受講前の準備チェックリスト。申込前・当日の持ち物・受講後の確認事項を網羅。印刷して使える実用的なリスト形式。`;

                eeaTips = `【E-E-A-T強化チェックリスト】
□ 実際の受講経験に基づくリスト
□ 見落としがちなポイントを強調
□ 印刷用PDFを提供
□ 定期的に最新情報に更新`;

                ctaGuide = `【CTA設計ガイド】
1. 申込前チェックリスト後
   → 「KCI教育センターで申し込む」ボタン
   → リンク先：${kciSiteInfo.pages.application}

2. ページ下部
   → 「今すぐ受講申込」ボタン
   → リンク先：${courseUrl}`;

                internalLinks = `【内部リンク設計】
- 「${eduName}とは」→ 用語解説記事
- 「オンライン受講の詳細」→ ハウツー記事
- 「受講体験談」→ 事例記事`;

                aiDiffTips = `【AI記事との差別化ポイント】
□ 実際の受講者が「持っていけばよかった」と思ったもの
□ よくある忘れ物・トラブル事例
□ 印刷用レイアウトの提供
□ 受講機関別の注意点`;

            } else if (type === 'news') {
                // =============================================
                // 法改正・ニュース記事：最新情報
                // =============================================
                outline = `# ${eduName}の最新情報｜${year}年の法改正・制度変更まとめ

【この記事について】
${eduName}に関する最新の法改正・制度変更情報をまとめています。
最終更新日：${year}年○月○日

## ${year}年の主な変更点
### 変更点①：○○の改正
- **施行日**：${year}年○月○日
- **変更内容**：○○が△△に変更
- **影響**：受講者は□□に注意が必要

### 変更点②：△△の追加
- **施行日**：${year}年○月○日
- **変更内容**：新たに○○が義務化
- **影響**：対象者が拡大

【参照】厚生労働省発表資料へのリンク

【CTA挿入ポイント①】
「最新カリキュラムで受講する」ボタン

## 法改正の背景
### なぜ改正されたのか
- 労働災害の発生状況
- 現場からの要望
- 国際基準への対応

### 今後の見通し
- ○○年にさらなる改正が予定
- △△の義務化が検討中

## 受講者への影響
### 新規受講者
- ${year}年○月以降の受講者は新カリキュラム適用
- 講習時間：${totalHours}時間（変更なし/○時間増）

### 既受講者
- 再教育の要否：○○
- 修了証の有効性：○○

【内部リンク】
→「${eduName}の再教育について」

## よくある質問
### Q. 改正前に取得した修了証は有効？
A. 有効です。ただし、○○の場合は再教育が推奨されます。

### Q. いつから新カリキュラムが適用？
A. ${year}年○月○日施行の講習から適用です。

### Q. 費用は変わる？
A. ○○（据え置き/○円程度の変更）

【CTA挿入ポイント②】
「最新の${eduName}を受講する」ボタン

## 関連する法令・通達
- ${lawRef}（改正後）
- 厚生労働省通達○○号
- ○○ガイドライン（${year}年版）

【参照リンク】
- e-Gov法令検索：${lawUrl}
- 厚生労働省HP

## まとめ
${year}年の${eduName}に関する主な変更点をまとめました。
- 変更点①：○○
- 変更点②：△△
- 施行日：${year}年○月○日

最新情報は本記事で随時更新していきます。`;

                titles = [
                    `【${year}年】${eduName}の法改正情報｜変更点と受講者への影響`,
                    `${eduName}最新ニュース｜${year}年の制度変更・カリキュラム改定まとめ`,
                    `【速報】${eduName}が変わる！${year}年の改正ポイントを解説`
                ];
                metaDesc = `${year}年の${eduName}に関する法改正・制度変更情報。変更点、施行日、受講者への影響を分かりやすく解説。最新情報を随時更新。`;

                eeaTips = `【E-E-A-T強化チェックリスト】
□ 厚生労働省・官報の一次情報を参照
□ 施行日・条文番号を正確に記載
□ 最終更新日を明記
□ 変更があれば即座に更新`;

                ctaGuide = `【CTA設計ガイド】
1. 変更点セクション後
   → 「最新カリキュラムで受講する」ボタン
   → リンク先：${courseUrl}

2. まとめセクション
   → 「${eduName}を申し込む」ボタン
   → リンク先：${kciSiteInfo.pages.application}`;

                internalLinks = `【内部リンク設計】
- 「${eduName}の基本」→ 用語解説記事
- 「受講方法」→ ハウツー記事
- 「過去の法改正履歴」→ 別記事
- 「関連する他の教育の改正情報」→ 関連ニュース記事`;

                aiDiffTips = `【AI記事との差別化ポイント】
□ 官報・厚労省発表の一次情報に基づく
□ 法改正の施行日を正確に記載
□ 現場への実際の影響を専門家が解説
□ 随時更新で常に最新情報を提供`;

            } else {
                // デフォルト（その他）
                outline = `# ${mainKw}について【${year}年】

## 概要
${mainKw}に関する記事です。

## 詳細
※記事タイプを選択して再生成してください`;

                titles = [`${mainKw}について【${year}年】`];
                metaDesc = `${mainKw}に関する情報をまとめました。`;
                eeaTips = '記事タイプを選択してください';
                ctaGuide = '記事タイプを選択してください';
                internalLinks = '記事タイプを選択してください';
                aiDiffTips = '記事タイプを選択してください';
            }

            // 競合データがあれば、不足トピックを追加
            const competitorHeadings = getCompetitorHeadingsForOutline();
            if (competitorHeadings.length > 0) {
                outline = appendCompetitorTopics(outline, competitorHeadings, eduName);
            }

            // 結果をDOMに反映
            document.getElementById('article-outline').textContent = outline;

            // SEO統合版を生成
            const integratedData = {
                eduName: eduName,
                courseUrl: courseUrl,
                kciSiteInfo: kciSiteInfo
            };
            const integratedOutline = generateIntegratedOutline(outline, integratedData);
            document.getElementById('article-outline-integrated').innerHTML = integratedOutline;

            // タイトル案
            document.getElementById('title-suggestions').innerHTML = titles.map((t, i) => `
                <div class="bg-gray-50 rounded-lg p-3 text-sm">
                    <span class="text-xs text-gray-400">案${i + 1}</span>
                    <div class="font-medium">${t}</div>
                </div>
            `).join('');

            // メタディスクリプション
            document.getElementById('meta-description').innerHTML = `${metaDesc}<p class="text-xs text-gray-400 mt-2">※${metaDesc.length}文字（120〜160文字推奨）</p>`;

            // 一次情報
            const sources = getPrimarySources(mainKw);
            document.getElementById('primary-sources').innerHTML = sources.map(s => `
                <a href="${s.url}" target="_blank" class="block bg-indigo-50 rounded-lg p-3 text-sm text-indigo-700 hover:bg-indigo-100">
                    ${s.title} <span class="text-xs">↗</span>
                </a>
            `).join('');

            // プロ向け追加情報を表示
            document.getElementById('pro-tips-eeat').textContent = eeaTips;
            document.getElementById('pro-tips-cta').textContent = ctaGuide;
            document.getElementById('pro-tips-links').textContent = internalLinks;
            document.getElementById('pro-tips-schema').textContent = schemaMarkup;
            document.getElementById('pro-tips-diff').textContent = aiDiffTips;

            // 地域キーワードバナーの表示/非表示
            const regionalBanner = document.getElementById('regional-keyword-banner');
            const regionalNameSpan = document.getElementById('regional-keyword-name');
            if (isRegionalKeyword && detectedRegion) {
                regionalNameSpan.textContent = detectedRegion;
                regionalBanner.classList.remove('hidden');

                // ベースキーワードを抽出（地域名を除去）
                let baseKw = mainKw;
                if (detectedRegion) {
                    baseKw = mainKw.replace(detectedRegion, '').replace(/\s+/g, ' ').trim();
                }

                // 重複コンテンツチェック
                const duplicates = checkDuplicateRegionalContent(baseKw, detectedRegion);
                const duplicateWarningEl = document.getElementById('duplicate-content-warning');
                if (duplicates.length > 0 && duplicateWarningEl) {
                    duplicateWarningEl.innerHTML = `
                        <div class="mt-3 p-3 bg-red-50 border border-red-300 rounded-lg">
                            <p class="text-sm font-bold text-red-700 mb-1">
                                <span class="material-symbols-outlined icon-sm align-middle">warning</span>
                                重複コンテンツ警告
                            </p>
                            <p class="text-xs text-red-600 mb-2">
                                同じベースキーワード「${baseKw}」で既に
                                <strong>${duplicates.map(d => d.region).join('、')}</strong>
                                向けの記事を生成しています。
                            </p>
                            <p class="text-xs text-red-600">
                                差別化のため、${detectedRegion}独自の情報（教習所比較、地域データ、体験談）を必ず含めてください。
                            </p>
                        </div>
                    `;
                    duplicateWarningEl.classList.remove('hidden');
                } else if (duplicateWarningEl) {
                    duplicateWarningEl.classList.add('hidden');
                }

                // 生成履歴に保存
                saveGeneratedRegionalArticle(baseKw, detectedRegion);
            } else {
                regionalBanner.classList.add('hidden');
            }

            document.getElementById('article-design-result').classList.remove('hidden');
        }

        // SEO統合版の記事構成を生成する関数
        function generateIntegratedOutline(outline, data) {
            let result = outline;
            const siteSettings = getSiteSettings();
            const siteName = siteSettings.name;
            const applicationUrl = siteSettings.applicationUrl || data.kciSiteInfo?.pages?.application || '#';

            // CTA挿入ポイントを実際のCTA HTMLに置換
            result = result.replace(/【CTA挿入ポイント①】[\s\S]*?(?=\n\n|$)/g, `
<div class="cta-box" style="background: linear-gradient(135deg, #eef2ff, #e0e7ff); border: 2px solid #6366f1; border-radius: 12px; padding: 20px; margin: 20px 0; text-align: center;">
  <p style="font-weight: bold; color: #4338ca; margin-bottom: 12px;">今すぐ${data.eduName}を受講する</p>
  <a href="${applicationUrl}" style="display: inline-block; background: #4f46e5; color: white; padding: 12px 32px; border-radius: 8px; text-decoration: none; font-weight: bold;">${siteName}で申し込む →</a>
  <p style="font-size: 12px; color: #64748b; margin-top: 8px;">オンライン・対面どちらも対応</p>
</div>`);

            const courseUrl = siteSettings.courseUrl || data.kciSiteInfo?.pages?.course || '#';
            result = result.replace(/【CTA挿入ポイント②】[\s\S]*?(?=\n\n|$)/g, `
<div class="cta-box-inline" style="display: flex; gap: 12px; margin: 16px 0; flex-wrap: wrap;">
  <a href="${courseUrl}" style="flex: 1; min-width: 200px; background: #f8fafc; border: 1px solid #e2e8f0; padding: 16px; border-radius: 8px; text-decoration: none; text-align: center;">
    <span style="font-weight: bold; color: #334155;">eラーニング講座</span><br>
    <span style="font-size: 12px; color: #64748b;">自分のペースで学習</span>
  </a>
  <a href="${courseUrl}" style="flex: 1; min-width: 200px; background: #f8fafc; border: 1px solid #e2e8f0; padding: 16px; border-radius: 8px; text-decoration: none; text-align: center;">
    <span style="font-weight: bold; color: #334155;">ZOOM講座</span><br>
    <span style="font-size: 12px; color: #64748b;">リアルタイムで質問可能</span>
  </a>
</div>`);

            const features = siteSettings.features.slice(0, 3);
            const featureText = features.length > 0 ? features.map(f => `✓ ${f}`).join('　') : '✓ オンライン対応　✓ 即日修了証発行　✓ 法人一括対応';
            result = result.replace(/【CTA挿入ポイント③】[\s\S]*?(?=\n\n|$)/g, `
<div class="cta-box-final" style="background: linear-gradient(135deg, #4f46e5, #4338ca); border-radius: 16px; padding: 32px; margin: 24px 0; text-align: center; color: white;">
  <p style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">${data.eduName}を受講するなら</p>
  <p style="margin-bottom: 16px; opacity: 0.9;">${siteName}は全国対応・即日修了証発行</p>
  <a href="${applicationUrl}" style="display: inline-block; background: white; color: #4f46e5; padding: 16px 48px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 16px;">今すぐ申し込む →</a>
  <div style="margin-top: 16px; font-size: 14px; opacity: 0.9;">
    ${featureText}
  </div>
</div>`);

            // 内部リンクを実際のリンクに置換
            result = result.replace(/【内部リンク①】[\s\S]*?(?=\n\n|$)/g, `
<div class="internal-link" style="background: #f8fafc; border-left: 4px solid #6366f1; padding: 12px 16px; margin: 16px 0;">
  <span style="font-size: 12px; color: #64748b;">関連記事</span><br>
  <a href="#" style="color: #4f46e5; text-decoration: none; font-weight: 500;">→ ${data.eduName}と他の資格の違いを詳しく解説</a>
</div>`);

            result = result.replace(/【内部リンク②】[\s\S]*?(?=\n\n|$)/g, `
<div class="internal-link" style="background: #f8fafc; border-left: 4px solid #6366f1; padding: 12px 16px; margin: 16px 0;">
  <span style="font-size: 12px; color: #64748b;">関連記事</span><br>
  <a href="#" style="color: #4f46e5; text-decoration: none; font-weight: 500;">→ ${data.eduName}の費用・料金を詳しく解説</a>
</div>`);

            // E-E-A-T要素を具体的な内容に置換
            result = result.replace(/【この記事の信頼性】[\s\S]*?(?=\n\n)/g, `
<div class="eeat-box" style="background: #fefce8; border: 1px solid #fef08a; border-radius: 8px; padding: 16px; margin: 16px 0;">
  <p style="font-weight: bold; color: #854d0e; margin-bottom: 8px;"><span class="material-symbols-outlined" style="vertical-align: middle;">verified</span> この記事の信頼性</p>
  <ul style="margin: 0; padding-left: 20px; color: #713f12; font-size: 14px;">
    <li>執筆：安全衛生教育の専門スタッフ（実務経験10年以上）</li>
    <li>監修：${siteName}講師陣</li>
    <li>参照：厚生労働省・労働安全衛生法の公式資料</li>
    <li>最終更新：${new Date().toLocaleDateString('ja-JP')}</li>
  </ul>
</div>`);

            result = result.replace(/【執筆者情報】[\s\S]*?(?=\n\n)/g, `
<div class="author-box" style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 16px; margin: 16px 0; display: flex; gap: 16px; align-items: center;">
  <div style="width: 64px; height: 64px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
    <span class="material-symbols-outlined" style="font-size: 32px; color: #16a34a;">person</span>
  </div>
  <div>
    <p style="font-weight: bold; color: #166534; margin-bottom: 4px;">この記事を書いた人</p>
    <p style="font-size: 14px; color: #15803d; margin: 0;">KCI教育センター 安全教育チーム<br>
    <span style="font-size: 12px; color: #22c55e;">労働安全衛生の専門家が実体験に基づいて解説</span></p>
  </div>
</div>`);

            // 差別化ポイントを具体的なアドバイスに置換
            result = result.replace(/【差別化ポイント】[\s\S]*?(?=\n\n|$)/g, `
<div class="diff-tip" style="background: #fdf4ff; border: 1px dashed #e879f9; border-radius: 8px; padding: 12px 16px; margin: 16px 0;">
  <p style="font-weight: bold; color: #a21caf; margin-bottom: 8px;"><span class="material-symbols-outlined" style="vertical-align: middle;">tips_and_updates</span> ここで差別化</p>
  <p style="font-size: 14px; color: #86198f; margin: 0;">現場経験に基づく具体例やよくある失敗談を追加すると、AI生成記事との差別化になります。</p>
</div>`);

            result = result.replace(/【差別化】[\s\S]*?(?=\n\n|$)/g, `
<div class="diff-tip-inline" style="background: #fdf4ff; padding: 8px 12px; border-radius: 6px; margin: 8px 0; font-size: 13px; color: #a21caf;">
  <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 16px;">tips_and_updates</span> 実体験に基づく失敗談・成功事例を追加
</div>`);

            // プレーンテキストをHTMLとして整形
            result = result
                .replace(/^# (.+)$/gm, '<h1 style="font-size: 24px; font-weight: bold; color: #1e293b; border-bottom: 3px solid #6366f1; padding-bottom: 8px; margin: 24px 0 16px;">$1</h1>')
                .replace(/^## (.+)$/gm, '<h2 style="font-size: 20px; font-weight: bold; color: #334155; border-left: 4px solid #6366f1; padding-left: 12px; margin: 20px 0 12px;">$1</h2>')
                .replace(/^### (.+)$/gm, '<h3 style="font-size: 16px; font-weight: bold; color: #475569; margin: 16px 0 8px;">$1</h3>')
                .replace(/^#### (.+)$/gm, '<h4 style="font-size: 14px; font-weight: bold; color: #64748b; margin: 12px 0 6px;">$1</h4>')
                .replace(/^- (.+)$/gm, '<li style="margin: 4px 0; padding-left: 8px;">$1</li>')
                .replace(/\n\n/g, '</p><p style="margin: 12px 0;">')
                .replace(/\|(.+)\|/g, '<code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px;">$1</code>');

            return `<div class="integrated-outline" style="font-family: sans-serif; line-height: 1.8; color: #334155;">${result}</div>`;
        }

        // ========== AI設定 ==========
        const AI_CONFIG = {
            claude: { name: 'Claude', url: 'https://claude.ai/' },
            chatgpt: { name: 'ChatGPT', url: 'https://chat.openai.com/' },
            gemini: { name: 'Gemini', url: 'https://gemini.google.com/' }
        };

        function getSelectedAI() {
            const selected = document.querySelector('input[name="ai-select"]:checked');
            return selected ? selected.value : 'claude';
        }

        // ========== AIプロンプト生成（マルチAI対応） ==========
        function copyForAI() {
            try {
                // 事前チェック
                if (selectedClusterIndex === null || !clusters || !clusters[selectedClusterIndex]) {
                    alert('クラスターを選択してください');
                    return;
                }
                const outlineEl = document.getElementById('article-outline');
                if (!outlineEl) {
                    alert('記事構成の要素が見つかりません。ページを再読み込みしてください。');
                    return;
                }
                const outline = outlineEl.textContent;
                if (!outline || outline.trim() === '' || outline.includes('クラスターを選択')) {
                    alert('先に「記事構成を生成」ボタンをクリックして記事構成を生成してください');
                    return;
                }
            const cluster = clusters[selectedClusterIndex];
            const mainKw = cluster.keywords[0]?.keyword || cluster.name;
            const sources = getPrimarySources(mainKw);
            const articleTypeEl = document.querySelector('input[name="article-type"]:checked');
            if (!articleTypeEl) {
                alert('記事タイプを選択してください');
                return;
            }
            const articleType = articleTypeEl.value;
            const selectedAI = getSelectedAI();
            const aiConfig = AI_CONFIG[selectedAI];

            // 教育種別を判定
            let eduKey = null;
            let eduData = null;
            const eduKeyMapping = [
                { patterns: ['職長'], key: '職長' },
                { patterns: ['フルハーネス'], key: 'フルハーネス' },
                { patterns: ['足場'], key: '足場' },
                { patterns: ['酸欠', '酸素欠乏'], key: '酸欠' },
                { patterns: ['粉じん', '粉塵'], key: '粉じん' },
                { patterns: ['低圧電気', '低圧'], key: '低圧電気' },
                { patterns: ['玉掛け', '玉掛'], key: '玉掛け' },
                { patterns: ['フォークリフト'], key: 'フォークリフト' }
            ];
            for (const mapping of eduKeyMapping) {
                if (mapping.patterns.some(p => mainKw.includes(p))) {
                    eduKey = mapping.key;
                    eduData = educationMasterData[eduKey];
                    break;
                }
            }

            // 記事タイプ別の指示（詳細版）
            const siteSettings = getSiteSettings();
            const siteName = siteSettings.name;
            let typeInstruction = '';
            if (articleType === 'pillar') {
                typeInstruction = `【ピラー記事（総合ガイド）】
■ 目的：「この1記事で全てわかる」と思わせる決定版コンテンツ
■ 構成の特徴：
  - 冒頭に「この記事の全体像」を目次形式で提示
  - 基礎→応用→実践の流れで体系的に構成
  - 各セクションが独立しても理解できるように
■ 差別化ポイント：
  - 「他サイトにない深い情報」を各セクションに1つ以上
  - 経験者でも「なるほど」と思う発見を入れる
  - データ・事例・専門家の見解を豊富に
■ 読者に提供する価値：「辞書のように何度も見返したくなる」`;
            } else if (articleType === 'howto') {
                typeInstruction = `【ハウツー記事（手順解説）】
■ 目的：読者が「この通りにやれば迷わない」と確信できるマニュアル
■ 構成の特徴：
  - STEP形式で番号を振り、進捗が見えるように
  - 各STEPに「所要時間」「難易度」を明記
  - 「ここで失敗する人が多い」注意ポイントを随所に
■ 差別化ポイント：
  - 「やってみてわかった」実体験ベースのコツ
  - 「最短ルート」と「確実ルート」両方を提示
  - つまずきやすいポイントと解決策をセット
■ 読者に提供する価値：「迷わず最短で目的を達成できる」`;
            } else if (articleType === 'comparison') {
                typeInstruction = `【選び方ガイド】
■ 目的：「自分に合った選択ができた」と納得してもらう
■ 構成の特徴：
  - 最初に「選ぶ前に知っておくべき基準」を提示
  - 比較表で一目でわかるように可視化
  - 「○○な人には△△がおすすめ」と条件別に推奨
■ 差別化ポイント：
  - 「安ければいいわけではない理由」など意外な視点
  - 「講師が教える"いい講座"の見分け方」専門家目線
  - ${siteName}の強みは押し売りせず、客観的に紹介
■ 読者に提供する価値：「後悔しない選択ができた」`;
            } else if (articleType === 'faq') {
                typeInstruction = `【FAQ記事】
■ 目的：検索でたどり着いた疑問を「完璧に解決」する
■ 構成の特徴：
  - 質問は実際の検索クエリを意識した言葉で
  - 回答は「結論→理由→具体例」の順で
  - 関連する疑問への導線を各Q&Aに設置
■ 差別化ポイント：
  - 「みんなが聞きたいけど聞けない質問」も入れる
  - 「よくある誤解」を正す内容を含める
  - 「〜の場合は？」と例外ケースも網羅
■ 読者に提供する価値：「もやもやが全て解消された」`;
            } else if (articleType === 'case') {
                typeInstruction = `【事例・体験談記事】
■ 目的：「自分もこうなれる」とイメージさせる
■ 構成の特徴：
  - ビフォーアフターを明確に描写
  - 感情の変化も含めてストーリー調に
  - 「これから受講する人へのアドバイス」で締める
■ 差別化ポイント：
  - 「正直、○○は大変だった」とリアルな苦労も
  - 「事前に知っていれば」と後悔ポイント
  - 具体的な数字（勉強時間、費用、期間）
■ 読者に提供する価値：「先輩から直接話を聞いたような安心感」`;
            } else if (articleType === 'glossary') {
                typeInstruction = `【用語解説記事】
■ 目的：「完璧に理解できた」と自信を持ってもらう
■ 構成の特徴：
  - 最初に結論（○○とは〜である）
  - 背景・歴史・なぜ必要かを深掘り
  - 関連用語との違い・関係性を明確に
■ 差別化ポイント：
  - 「現場ではこう使われる」実務的な文脈
  - 「よくある混同」を解消
  - 「知っておくと役立つ」周辺知識も追加
■ 読者に提供する価値：「人に説明できるレベルで理解できた」`;
            } else if (articleType === 'checklist') {
                typeInstruction = `【チェックリスト記事】
■ 目的：「これを見れば漏れなく準備できる」実用ツール
■ 構成の特徴：
  - コピペして使えるチェックボックス形式
  - 時系列（1週間前→前日→当日）で整理
  - 「忘れがちだけど重要」な項目をハイライト
■ 差別化ポイント：
  - 「実際に忘れて困った人の声」から逆算
  - 印刷用レイアウトへの配慮
  - 「これも準備しておくと安心」プラスα情報
■ 読者に提供する価値：「保存して何度も使いたい」`;
            } else if (articleType === 'news') {
                typeInstruction = `【法改正・ニュース記事】
■ 目的：「今知るべき最新情報」をいち早く・正確に届ける
■ 構成の特徴：
  - 「何が」「いつから」「誰に影響」を冒頭で明示
  - 改正前後の比較表を必ず入れる
  - 「結局どうすればいいの？」アクションを明示
■ 差別化ポイント：
  - 一次情報（官公庁サイト）へのリンク必須
  - 「専門家の見解」「現場への影響」を追加
  - 今後の動向・予測も可能な範囲で
■ 読者に提供する価値：「これだけ読めば最新情報がわかる」`;
            } else {
                typeInstruction = '記事タイプに応じた最適な構成で作成してください。';
            }

            // 実データがある場合は追加情報を含める
            let dataInfo = '';
            if (eduData) {
                dataInfo = `
【この教育の正確なデータ】
- 正式名称：${eduData.name}
- 根拠法令：${eduData.law}
- 講習時間：${eduData.totalHours}時間
- 対象者：${eduData.targetPerson}
- 対象業種：${eduData.industries}
- 罰則：${eduData.penalty}
- オンライン受講：${eduData.onlineAvailable ? '可能' : '不可'}
${eduData.practicalRequired ? `- 実技講習：${eduData.practicalNote}` : ''}
- 有効期限：${eduData.validityPeriod}
- 再教育：${eduData.recommendedRefresh}
- 料金相場：
  ${eduData.priceRange.online ? `オンライン ${eduData.priceRange.online.min.toLocaleString()}円〜${eduData.priceRange.online.max.toLocaleString()}円` : ''}
  対面 ${eduData.priceRange.offline.min.toLocaleString()}円〜${eduData.priceRange.offline.max.toLocaleString()}円
`;
            }

            // 競合分析データがあれば含める
            let competitorInfo = '';
            if (competitorHeadingsData.mustHave && competitorHeadingsData.mustHave.length > 0) {
                // SERPモードの場合は詳細な検索結果分析を含める
                if (competitorHeadingsData.isSerpMode && competitorHeadingsData.serpUrls) {
                    const serpData = competitorHeadingsData.serpUrls;
                    const domains = serpData.map(item => {
                        try { return new URL(item.url).hostname.replace('www.', ''); } catch(e) { return item.url; }
                    });
                    const domainTypes = analyzeDomainTypes(domains);

                    // 上位5サイトの情報
                    const top5Info = serpData.slice(0, 5).map((item, i) => {
                        const domain = domains[i];
                        return `${i + 1}位: ${domain}${item.title ? ` - 「${item.title}」` : ''}`;
                    }).join('\n');

                    competitorInfo = `
【検索上位分析結果】★この情報に基づいて構成を最適化★

■ 検索上位サイトの構成（上位5サイト）:
${top5Info}

■ 上位サイトのタイプ分析:
- 官公庁・公式: ${domainTypes.official}件
- 企業サイト: ${domainTypes.corporate}件
- メディア: ${domainTypes.media}件
${domainTypes.official > 3 ? '→ 官公庁サイトが多いため「わかりやすさ」「実践的情報」で差別化が有効' : ''}
${domainTypes.media > 3 ? '→ メディアサイトが多いため「専門性」「正確性」で差別化が有効' : ''}

■ 上位サイトで共通して扱われているトピック（必須で含める）:
${competitorHeadingsData.mustHave.slice(0, 7).map(h => `- ${h.text}（${h.count}サイトで言及）`).join('\n')}

■ 差別化のための独自コンテンツ（競合にない価値を提供）:
${competitorHeadingsData.kciUnique?.slice(0, 5).map(h => `- ${h.text}（${h.category}）`).join('\n') || '- 独自の視点・体験談を追加'}

■ 上位表示を狙うための構成の方向性:
- 上位サイトが扱っているトピックは必ずカバーする
- 上位サイトにない独自の切り口を追加して差別化
- 検索意図に対して結論ファーストで回答
- FAQセクションで関連疑問にも対応
`;
                } else {
                    competitorInfo = `
【競合分析結果】
必須で含めるべき見出し（上位サイト共通）:
${competitorHeadingsData.mustHave.slice(0, 5).map(h => `- ${h.text}`).join('\n')}

差別化ポイント（競合にない独自性）:
${competitorHeadingsData.kciUnique?.slice(0, 3).map(h => `- ${h.text}`).join('\n') || '- 独自の視点・体験談を追加'}
`;
                }
            }

            // 地域キーワードの場合の追加情報
            let regionalInfo = '';
            const prefectures = ['北海道', '青森', '岩手', '宮城', '秋田', '山形', '福島', '茨城', '栃木', '群馬', '埼玉', '千葉', '東京', '神奈川', '新潟', '富山', '石川', '福井', '山梨', '長野', '岐阜', '静岡', '愛知', '三重', '滋賀', '京都', '大阪', '兵庫', '奈良', '和歌山', '鳥取', '島根', '岡山', '広島', '山口', '徳島', '香川', '愛媛', '高知', '福岡', '佐賀', '長崎', '熊本', '大分', '宮崎', '鹿児島', '沖縄'];
            const majorCities = ['札幌', '仙台', '横浜', '川崎', '名古屋', '京都市', '神戸', '福岡市', '北九州', '堺', '新潟市', '浜松', '熊本市', '相模原', '岡山市', '静岡市', '船橋', '鹿児島市', '川口', '八王子'];
            let detectedRegion = null;
            for (const pref of prefectures) {
                if (mainKw.includes(pref)) {
                    detectedRegion = pref;
                    break;
                }
            }
            if (!detectedRegion) {
                for (const city of majorCities) {
                    if (mainKw.includes(city)) {
                        detectedRegion = city;
                        break;
                    }
                }
            }
            if (detectedRegion) {
                regionalInfo = `
【地域キーワード検出】
この記事は「${detectedRegion}」をターゲットとした地域特化記事です。

★重複コンテンツ回避のため、以下の独自情報を必ず含めてください★
- ${detectedRegion}での受講場所・アクセス情報
- ${detectedRegion}周辺の教習所比較（3〜5箇所）
- ${detectedRegion}特有の需要（地域の主要産業に関連付け）
- ${detectedRegion}からの受講者の声・体験談
- ${detectedRegion}での出張講習の有無

【SEOポイント】
- タイトルに「${detectedRegion}」を含める
- H2見出しに最低1回「${detectedRegion}」を含める
- 地域名+サービス名の組み合わせをメタディスクリプションに含める
`;
            }

            // A/B/C層分析と差別化戦略
            let layerStrategy = '';
            const clusterLayers = { A: 0, B: 0, C: 0 };
            cluster.keywords.forEach(kw => {
                if (kw.contentType) clusterLayers[kw.contentType]++;
            });
            const dominantLayer = Object.entries(clusterLayers).sort((a, b) => b[1] - a[1])[0]?.[0] || 'A';

            if (dominantLayer === 'A') {
                layerStrategy = `
═══════════════════════════════════════
【コンテンツ差別化戦略：A層（制度解説系）】
═══════════════════════════════════════
このキーワードは競合（SAT等）も多くカバーしている基礎情報領域です。
同じ情報を書いても埋もれるため、以下の差別化が必須：

■ 必須の差別化要素（全て含める）
□ 法令条文の正確な引用
  例：「労働安全衛生法第60条に基づき〜」「安衛則第36条により〜」
□ 具体的な数字の明記
  × 「費用は様々」→ ○ 「8,000円〜15,000円」
  × 「数時間」→ ○ 「6時間（学科4h+実技2h）」
□ 現場視点の補足
  「現場では○○が問題になりがち」「実務上は△△に注意」
□ よくある失敗例・注意点
  「○○を忘れて再受講になるケースが多い」

■ 競合との差を生む一言
- 「ただし、○○の場合は例外で〜」（例外ケースの言及）
- 「現場監督によると〜」（一次情報風の表現）
- 「よくある誤解ですが〜」（読者の思い込みを正す）
`;
            } else if (dominantLayer === 'B') {
                layerStrategy = `
═══════════════════════════════════════
【コンテンツ差別化戦略：B層（業種特化系）】
═══════════════════════════════════════
このキーワードは業種特化の切り口です。
競合（SAT等）にない差別化ポイントになります。

■ 必須の差別化要素（全て含める）
□ 業種特有の用語・状況を使用
  「建設現場では〜」「製造ラインでは〜」「倉庫作業では〜」
□ 業種別の具体的シーン描写
  「足場の組立作業中に〜」「フォークリフト荷役作業で〜」
□ 業種ならではの事例・ケーススタディ
  「A建設会社では○○の方法で〜」
□ 業界団体・専門機関への言及
  「建設業労働災害防止協会によると〜」

■ 業種別カスタマイズ例
- 建設業：「現場入場前の新規入場者教育として〜」
- 製造業：「ISO45001の観点から〜」「5S活動と連携して〜」
- 運送業：「点呼時の確認事項として〜」「運行管理者と連携し〜」
`;
            } else {
                layerStrategy = `
═══════════════════════════════════════
【コンテンツ差別化戦略：C層（体験・事例系）】
═══════════════════════════════════════
このキーワードは一次情報で最大の差別化が可能な領域です。
AIでは絶対に書けない「リアルな体験」が武器になります。

■ 必須の差別化要素（全て含める）
□ 一人称の体験談
  「私が受講したときは〜」「実際に受けてみて分かったのは〜」
□ 受講者の生の声・感想
  「他の受講者からは○○という声が多かった」
□ 具体的な講習の様子
  「教室は○○人程度」「講師は○○について詳しく説明」
□ 予想外だったこと・意外な発見
  「思っていたより○○だった」「事前に知っておきたかったのは〜」

■ リアリティを出す表現
- 「正直なところ〜」「ぶっちゃけ〜」（本音感）
- 「○○時○○分に終わった」（具体的な時間）
- 「隣の席の人は○○業界の方で〜」（エピソード）
- [画像：○○の写真] の指示を多めに入れる
`;
            }

            // 記事タイプ別の文字数目安
            const wordCountGuide = {
                pillar: { total: '5000〜8000', h2: '800〜1200', h3: '300〜500' },
                howto: { total: '3000〜5000', h2: '600〜1000', h3: '200〜400' },
                comparison: { total: '4000〜6000', h2: '700〜1000', h3: '250〜450' },
                faq: { total: '2500〜4000', h2: '500〜800', h3: '150〜300' },
                case: { total: '2000〜3500', h2: '500〜700', h3: '200〜350' },
                glossary: { total: '2000〜3000', h2: '400〜600', h3: '150〜250' },
                checklist: { total: '1500〜2500', h2: '300〜500', h3: '100〜200' },
                news: { total: '1500〜2500', h2: '400〜600', h3: '150〜250' }
            };
            const wc = wordCountGuide[articleType] || wordCountGuide.pillar;

            const prompt = `あなたは建設業の安全教育分野で10年以上の執筆経験を持つSEOコンテンツスペシャリストです。

【ミッション】
検索順位1位を獲得し、読者に「この記事だけで完全に理解できた」と思わせる、業界最高水準の記事を作成してください。

【品質基準】
- 競合上位10記事を凌駕する情報量と深さ
- 読者が保存・ブックマークしたくなる実用的価値
- 専門家が監修したと感じられる正確性と信頼性
- AIコンテンツとは一線を画す独自性と人間味

以下の情報に基づいて執筆してください。

【ターゲットキーワード】
メインKW：${mainKw}
関連KW（自然に含める）：${cluster.keywords.slice(1, 8).map(k => k.keyword).join('、') || 'なし'}

【記事タイプ】
${typeInstruction}

【記事構成】
${outline}

【参照すべき一次情報（必ずリンクを記事内に含める）】
${sources.map(s => `- ${s.title}: ${s.url}`).join('\n')}
${dataInfo}
${competitorInfo}
${regionalInfo}
${layerStrategy}

═══════════════════════════════════════
【高品質コンテンツ要件】★重要★
═══════════════════════════════════════

■ 冒頭（リード文）の黄金構成
1. 結論ファースト：読者の疑問に3行以内で回答
2. 記事の価値提示：「この記事を読めば○○がわかります」
3. 信頼性の担保：「○○の専門家が解説」「最新データに基づき」
4. 読了時間の目安：「5分で理解できる」など

■ 本文の品質基準
【深さ】
- 表面的な説明で終わらない。「なぜそうなのか」「具体的にどうするか」まで掘り下げる
- 一般論 → 具体例 → 例外ケース の3層構造で説明
- 「○○の場合は△△」と条件分岐を明示

【具体性】
- 抽象的な表現を避け、数字・固有名詞・具体例を使う
  × 「費用は様々です」 → ○ 「費用は8,000円〜15,000円が相場です」
  × 「多くの人が」 → ○ 「建設業従事者の約80%が」
- 「例えば」「具体的には」を多用し、イメージしやすく

【実用性】
- 読んだ後に読者が「次に何をすべきか」が明確になる
- チェックリスト・手順リスト・比較表など、保存して使えるコンテンツを含める
- 「明日からできる」「今すぐ確認できる」アクションを提示

【独自性】
- 他サイトのコピペ・リライトではなく、独自の視点を入れる
- 「現場ではこうです」「実際によくある質問として」など経験ベースの情報
- 「意外と知られていないが」「よくある誤解として」など付加価値

■ セクションごとの構成ルール
【H2セクション】
- 冒頭1〜2文でそのセクションの結論を述べる
- 本論で詳細を展開
- 末尾に「ポイント」「注意点」をまとめる

【H3セクション】
- 1つのH3で1つのトピックに絞る
- 箇条書き・表・図解指示を積極的に使う
- 長文の段落は避け、読みやすさを重視

■ 読者エンゲージメント要素
- 問いかけ：「○○で悩んでいませんか？」「○○を知っていますか？」
- 共感：「実は多くの方が同じ疑問を持っています」
- 驚き：「実は○○なのです」「意外にも○○」
- 安心：「心配ありません」「初心者でも大丈夫です」

═══════════════════════════════════════
【深堀り・差別化コンテンツ設計】★超重要★
═══════════════════════════════════════

■ 競合と差別化する「フック」を必ず入れる
各H2セクションに最低1つ、以下のいずれかを含める：

1. 意外な事実・統計
   「実は○○の○○%が△△している」「意外にも○○より□□の方が多い」

2. 現場のリアルな声
   「現場監督からよく聞くのは〜」「受講者の多くが驚くのは〜」

3. よくある失敗・落とし穴
   「○○しがちですが、実は△△です」「ここで失敗する人が多い」

4. プロだけが知るコツ
   「ベテラン講師が教える〜」「効率的に学ぶなら〜」

5. 比較・対比
   「Aの場合は○○、Bの場合は△△」「○○と△△の決定的な違い」

■ 「なぜ？」を3回深掘りする
表面的な説明で終わらせない：
× 「${mainKw}は法律で義務付けられています」
○ 「${mainKw}は法律で義務付けられています。
   → なぜ？ 過去に○○な事故が多発したため
   → どのくらい深刻？ 毎年○○件の死亡事故が発生
   → だから何をすべき？ 具体的に○○を学ぶ必要がある」

■ 読者タイプ別のセクションを追加
以下の3タイプ全員に価値を提供：

【初心者向け】
- 「そもそも○○とは？」の基礎解説
- 専門用語の説明
- 「5分でわかる○○」的なまとめ

【経験者向け】
- 「知っているつもりで意外と知らない○○」
- 最新の法改正・トレンド
- より効率的な方法・裏技

【意思決定者向け（企業担当者）】
- コスト比較・費用対効果
- 導入事例・他社の取り組み
- リスク管理の観点

■ ストーリー・事例を必ず含める
抽象的な説明だけでなく、具体的なストーリーを入れる：

【良い例】
「建設会社A社では、${mainKw}を全社員に受講させた結果、
事故発生率が前年比30%減少しました。特に効果があったのは〜」

【使えるストーリーパターン】
- ビフォーアフター：「受講前は○○だったが、受講後は△△になった」
- 失敗から学ぶ：「○○を怠った結果、△△という事故が起きた」
- 成功事例：「○○を徹底した結果、□□を達成できた」

■ 数字・データで説得力を出す
必ず具体的な数字を含める：

- 「毎年○○件の事故が発生」
- 「受講者の○○%が△△と回答」
- 「○○日で修了、費用は○○円〜」
- 「○○時間の講習で□□が身につく」

■ 読者の「次の疑問」を先回りする
各セクションの最後に、読者が次に知りたいことへの導線を作る：

「○○についてはわかりました。では次に気になるのは『△△』ではないでしょうか？
次のセクションで詳しく解説します。」

■ 記事タイプ別の差別化ポイント
この記事は「${typeInstruction}」です。

【ピラー記事なら】→ 網羅性と体系的な構成で「辞書」のような価値を
【ハウツーなら】→ 実際に行動できるステップバイステップで「マニュアル」のような価値を
【FAQなら】→ 検索されやすい質問形式で「相談窓口」のような価値を
【事例なら】→ リアルな体験談で「先輩の話」のような価値を
【比較なら】→ 判断材料を提供して「アドバイザー」のような価値を

■ ビジュアル指示（必須）
以下の箇所に [画像：○○] [図解：○○] [表：○○] と明記：
- 複雑な手順 → フロー図
- 比較情報 → 比較表
- 数値データ → グラフ
- 概念説明 → イラスト・図解

═══════════════════════════════════════
【画像生成指示】★必須★
═══════════════════════════════════════

■ 記事内に最低5箇所の画像挿入ポイントを指定すること

■ 各画像について以下の形式で出力：

【画像1】アイキャッチ画像
- 挿入位置：記事冒頭
- 画像の目的：記事の内容を一目で伝える
- 推奨サイズ：1200×630px（OGP対応）
- 生成プロンプト：
「○○○○（具体的な画像生成プロンプトを日本語と英語で記載）」

【画像2】○○セクション用
- 挿入位置：H2「○○」の直下
- 画像の目的：○○を視覚的に説明
- 推奨タイプ：図解 / イラスト / 写真風 / インフォグラフィック
- 生成プロンプト：
「○○○○」

■ 画像生成プロンプトの書き方ルール：
1. 具体的に：「作業員」→「ヘルメットと安全帯を着用した建設作業員」
2. 構図を指定：「正面から」「俯瞰で」「クローズアップ」
3. スタイルを指定：「フラットデザイン」「写真風」「ビジネスイラスト」「インフォグラフィック」
4. 色調を指定：「青と白を基調」「明るく清潔感のある」
5. 日本語と英語の両方で出力（AI画像生成ツール用）

■ 推奨する画像タイプ：
- アイキャッチ：テーマを象徴するビジュアル
- 手順説明：ステップを示すフロー図
- 比較：表やチャート形式のインフォグラフィック
- 概念説明：シンプルな図解イラスト
- CTA付近：行動を促すビジュアル

■ 出力形式の例：
---
【画像3】受講手順フロー図
- 挿入位置：H2「受講の流れ」セクション冒頭
- 画像の目的：5ステップの受講手順を視覚化
- 推奨タイプ：インフォグラフィック（フロー図）
- 推奨サイズ：800×600px
- 生成プロンプト（日本語）：
「5つのステップを示すフロー図、ビジネス向けフラットデザイン、青と白を基調、矢印で流れを表現、各ステップにアイコン付き、清潔感のある明るいデザイン」
- 生成プロンプト（英語）：
「A 5-step flowchart infographic, flat design style for business, blue and white color scheme, arrows showing progression, icons for each step, clean and professional look」
---

═══════════════════════════════════════
【文字数の目安】
═══════════════════════════════════════
- 記事全体：${wc.total}文字
- H2セクションごと：${wc.h2}文字
- H3セクションごと：${wc.h3}文字
- リード文（冒頭）：200〜300文字
- まとめ：300〜500文字

═══════════════════════════════════════
【AI検索対応SEO（SGE/Perplexity最適化）】
═══════════════════════════════════════
1. 冒頭で結論を明示（検索意図への直接回答）
   例：「${mainKw}は○○です。受講時間は○時間、費用は○円〜です。」

2. FAQ形式のセクションを含める
   - 「よくある質問」セクションを設け、Q&A形式で3〜5問回答
   - 質問は実際の検索クエリを意識（「〜とは」「〜の違い」「〜の費用」等）

3. 箇条書き・表を活用
   - 重要情報は箇条書きでまとめる（AIが抽出しやすい）
   - 比較情報は表形式で整理

4. 数値・固有名詞を明確に
   - 「約○○円」ではなく「○○円〜○○円」と具体的に
   - 法令名、機関名は正式名称で記載

5. 引用元を明示
   - 「○○省によると〜」「○○法第○条では〜」と出典を示す

═══════════════════════════════════════
【E-E-A-T強化ポイント】
═══════════════════════════════════════
- 経験（Experience）：「現場では〜」「実際に受講した方の声では〜」
- 専門性（Expertise）：法令条文、カリキュラム詳細、正確な数字
- 権威性（Authority）：公式機関へのリンク、監修者情報の示唆
- 信頼性（Trust）：最新情報の日付、情報源の明記

═══════════════════════════════════════
【AI記事との差別化】
═══════════════════════════════════════
- 「よくある失敗例と対策」セクションを含める
- 「現場でよく聞かれる質問」に回答
- 「○○の場合はどうする？」という例外ケースに言及
- 画像を入れる場所を指示：[画像：○○の図解]

═══════════════════════════════════════
【プロ向けSEO戦略】
═══════════════════════════════════════

■ キーワード配置戦略
- メインKW「${mainKw}」をタイトル・H1・リード文・最初のH2に必ず含める
- 共起語・関連語を各セクションに自然に分散配置
- KW密度は本文の1.5〜2.5%を目安（詰め込みすぎない）

■ 検索意図完全対応
- Know意図：「〜とは」「〜の意味」→定義・概要を冒頭で明確に
- Do意図：「〜方法」「〜手順」→ステップバイステップで実行可能に
- Buy意図：「〜おすすめ」「〜比較」→判断材料と具体的な選択肢を提示

■ 内部リンク設計（記事内に挿入指示）
- 関連記事への自然な誘導を3〜5箇所に設置
- [内部リンク推奨：○○に関する詳細記事]と指示を入れる
- パンくずリスト構造を意識した階層関係

■ スニペット最適化（強調スニペット狙い）
- 「${mainKw}とは」の定義を50〜60文字で簡潔に（検索結果表示用）
- リスト形式のまとめを含める（箇条書き3〜7項目）
- 表形式の比較・一覧を1つ以上含める

■ スキーママークアップ対応
- FAQ形式のQ&Aを含める（FAQスキーマ対応）
- 手順記事の場合はHowToスキーマを意識した構成
- パンくず・記事情報のメタデータを意識

■ コンテンツ鮮度シグナル
- 「${new Date().getFullYear()}年最新」「${new Date().getMonth() + 1}月更新」など時期を明記
- 法改正・制度変更があれば最新情報を反映
- [更新予定：○○が変更された場合に更新]と将来の更新ポイントを示唆

■ UX・滞在時間向上
- 目次を設置（クリックで該当箇所にジャンプ）
- 各セクション冒頭に「このセクションでわかること」を1行で
- 視覚的な休憩ポイント：3〜4段落ごとに図解・表・箇条書き

■ 被リンク獲得を意識した構成
- 「○○の一覧表」「○○チェックリスト」など引用されやすいコンテンツ
- 独自調査・統計データがあれば強調
- インフォグラフィック化できる箇所を[図解推奨]と明記

■ CTR最適化（検索結果クリック率向上）
- メタディスクリプション案を記事末尾に提示（120〜140文字）
- タイトルに数字・ベネフィット・緊急性を含める
- 「保存版」「完全ガイド」などのパワーワードを適宜使用

【出力形式】
- Markdown形式
- H2（##）、H3（###）を使用
- 重要ポイントは**太字**で強調
- リスト・表を適宜使用
- 記事末尾に「この記事のまとめ」を箇条書きで3〜5点

═══════════════════════════════════════
【最終品質チェックリスト】
═══════════════════════════════════════
記事完成前に以下を確認：
□ 冒頭3行で読者の疑問に回答しているか
□ 各セクションに具体的な数字・事例が含まれているか
□ 「○○とは」の定義が50〜60文字で簡潔に書かれているか
□ 比較表・チェックリストなど保存価値のあるコンテンツがあるか
□ 内部リンク挿入箇所が明記されているか
□ CTAの挿入箇所が適切に配置されているか
□ 「よくある失敗」「注意点」など読者が知りたい情報があるか
□ 記事を読んだ後の「次のアクション」が明確か
□ メタディスクリプション案（120〜140文字）が記載されているか

【画像関連チェック】
□ 画像挿入ポイントが5箇所以上指定されているか
□ アイキャッチ画像の生成プロンプトがあるか
□ 各画像に日本語・英語の生成プロンプトがあるか
□ 画像のサイズ・タイプが明記されているか

よろしくお願いします。`;

            // モーダルを更新
            document.getElementById('ai-modal-title').textContent = `${aiConfig.name}に送るプロンプト`;
            document.getElementById('ai-modal-description').textContent = `以下のプロンプトをコピーして${aiConfig.name}に貼り付けてください`;
            document.getElementById('ai-prompt').value = prompt;
            document.getElementById('ai-link').href = aiConfig.url;
            document.getElementById('ai-link').textContent = `${aiConfig.name}を開く`;
            document.getElementById('ai-modal').classList.remove('hidden');
            } catch (error) {
                console.error('copyForAI error:', error);
                alert('エラーが発生しました: ' + error.message);
            }
        }

        function closeAIModal() {
            document.getElementById('ai-modal').classList.add('hidden');
        }

        function copyAIPrompt() {
            const textarea = document.getElementById('ai-prompt');
            copyToClipboard(textarea.value, 'プロンプトをコピーしました');
        }

        // 後方互換性のため古い関数名も維持
        function copyForClaude() { copyForAI(); }
        function closeClaudeModal() { closeAIModal(); }
        function copyClaudePrompt() { copyAIPrompt(); }

        // ========== 構成案コピー ==========
        function copyOutline() {
            const outline = document.getElementById('article-outline').textContent;
            const titles = Array.from(document.getElementById('title-suggestions').querySelectorAll('.font-medium')).map(el => el.textContent).join('\n');
            const sources = Array.from(document.getElementById('primary-sources').querySelectorAll('a')).map(el => el.textContent.trim() + ': ' + el.href).join('\n');

            const text = `【記事構成案】\n${outline}\n\n【タイトル案】\n${titles}\n\n【参照すべき一次情報】\n${sources}`;
            copyToClipboard(text, '構成案をコピーしました');
        }

        // ========== 汎用コピー関数 ==========
        function copyToClipboard(text, message) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => alert(message)).catch(() => fallbackCopy(text, message));
            } else {
                fallbackCopy(text, message);
            }
        }

        function fallbackCopy(text, message) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert(message);
            } catch (e) {
                alert('コピーに失敗しました');
            }
            document.body.removeChild(textarea);
        }

        // ========== CSV出力 ==========
        function exportCSV() {
            if (keywords.length === 0) { alert('データがありません'); return; }
            const data = keywords.map(kw => {
                const sources = getPrimarySources(kw.keyword);
                return {
                    キーワード: kw.keyword,
                    グループ: kw.cluster,
                    推定ボリューム: kw.volume,
                    検索意図: kw.intent,
                    CV期待度: kw.cvExpect,
                    一次情報URL: sources[0]?.url || ''
                };
            });
            const csv = Papa.unparse(data);
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'keyword-analysis.csv';
            a.click();
        }

        // ========== データ保存 ==========
        function saveData() {
            try {
                const data = { keywords, clusters, savedAt: new Date().toISOString() };
                localStorage.setItem('seo-keyword-tool-v4', JSON.stringify(data));
                alert('データを保存しました');
            } catch (e) {
                alert('保存に失敗しました');
            }
        }

        // ========== プロ向けタブ切り替え ==========
        function showProTab(tabName) {
            // 全タブを非表示
            document.querySelectorAll('.pro-tab-content').forEach(el => el.classList.add('hidden'));
            // 全ボタンをリセット
            document.querySelectorAll('.pro-tab-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'bg-indigo-100', 'text-indigo-700', 'bg-indigo-100', 'text-indigo-700', 'bg-slate-100', 'text-slate-700', 'bg-indigo-100', 'text-indigo-700');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });

            // 選択したタブを表示
            document.getElementById(`pro-tab-${tabName}`).classList.remove('hidden');

            // ボタンのスタイルを変更
            const btn = document.querySelector(`.pro-tab-btn[data-tab="${tabName}"]`);
            btn.classList.remove('bg-gray-100', 'text-gray-600');

            const colorMap = {
                'eeat': ['bg-indigo-100', 'text-indigo-700'],
                'cta': ['bg-indigo-100', 'text-indigo-700'],
                'links': ['bg-indigo-100', 'text-indigo-700'],
                'schema': ['bg-slate-100', 'text-slate-700'],
                'diff': ['bg-indigo-100', 'text-indigo-700']
            };
            btn.classList.add(...colorMap[tabName]);
        }

        // ========== 記事構成タブ切り替え ==========
        function showOutlineTab(tabName) {
            // 全タブコンテンツを非表示
            document.querySelectorAll('.outline-tab-content').forEach(el => el.classList.add('hidden'));

            // 全ボタンをリセット
            document.querySelectorAll('.outline-tab-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-100', 'text-indigo-700');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });

            // 選択したタブを表示
            if (tabName === 'basic') {
                document.getElementById('article-outline-basic').classList.remove('hidden');
            } else if (tabName === 'integrated') {
                document.getElementById('article-outline-integrated-container').classList.remove('hidden');
            }

            // ボタンのスタイルを変更
            const btn = document.querySelector(`.outline-tab-btn[data-tab="${tabName}"]`);
            btn.classList.remove('bg-gray-100', 'text-gray-600');
            btn.classList.add('bg-indigo-100', 'text-indigo-700');
        }

        // ========== 競合分析機能 ==========
        let currentCompetitorKeyword = '';
        let competitorData = [];
        let uploadedCompetitorData = { semrush: null, ahrefs: null };
        let uploadedSerpData = { semrush: null, ahrefs: null, manual: null };
        let currentCompetitorMode = 'site'; // 'site' or 'serp'

        // 競合CSV アップロード初期化
        function initCompetitorUpload() {
            // Semrush用
            const semrushDropzone = document.getElementById('semrush-dropzone');
            const semrushInput = document.getElementById('semrush-file-input');
            if (semrushDropzone && semrushInput) {
                semrushDropzone.addEventListener('click', () => semrushInput.click());
                semrushDropzone.addEventListener('dragover', (e) => { e.preventDefault(); semrushDropzone.classList.add('bg-orange-100'); });
                semrushDropzone.addEventListener('dragleave', () => semrushDropzone.classList.remove('bg-orange-100'));
                semrushDropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    semrushDropzone.classList.remove('bg-orange-100');
                    if (e.dataTransfer.files.length > 0) handleCompetitorCSV(e.dataTransfer.files[0], 'semrush');
                });
                semrushInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) handleCompetitorCSV(e.target.files[0], 'semrush');
                });
            }

            // Ahrefs用
            const ahrefsDropzone = document.getElementById('ahrefs-dropzone');
            const ahrefsInput = document.getElementById('ahrefs-file-input');
            if (ahrefsDropzone && ahrefsInput) {
                ahrefsDropzone.addEventListener('click', () => ahrefsInput.click());
                ahrefsDropzone.addEventListener('dragover', (e) => { e.preventDefault(); ahrefsDropzone.classList.add('bg-blue-100'); });
                ahrefsDropzone.addEventListener('dragleave', () => ahrefsDropzone.classList.remove('bg-blue-100'));
                ahrefsDropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    ahrefsDropzone.classList.remove('bg-blue-100');
                    if (e.dataTransfer.files.length > 0) handleCompetitorCSV(e.dataTransfer.files[0], 'ahrefs');
                });
                ahrefsInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) handleCompetitorCSV(e.target.files[0], 'ahrefs');
                });
            }

            // SERP用（Semrush）
            const semrushSerpDropzone = document.getElementById('semrush-serp-dropzone');
            const semrushSerpInput = document.getElementById('semrush-serp-file-input');
            if (semrushSerpDropzone && semrushSerpInput) {
                semrushSerpDropzone.addEventListener('click', () => semrushSerpInput.click());
                semrushSerpDropzone.addEventListener('dragover', (e) => { e.preventDefault(); semrushSerpDropzone.classList.add('bg-purple-100'); });
                semrushSerpDropzone.addEventListener('dragleave', () => semrushSerpDropzone.classList.remove('bg-purple-100'));
                semrushSerpDropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    semrushSerpDropzone.classList.remove('bg-purple-100');
                    if (e.dataTransfer.files.length > 0) handleSerpCSV(e.dataTransfer.files[0], 'semrush');
                });
                semrushSerpInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) handleSerpCSV(e.target.files[0], 'semrush');
                });
            }

            // SERP用（Ahrefs）
            const ahrefsSerpDropzone = document.getElementById('ahrefs-serp-dropzone');
            const ahrefsSerpInput = document.getElementById('ahrefs-serp-file-input');
            if (ahrefsSerpDropzone && ahrefsSerpInput) {
                ahrefsSerpDropzone.addEventListener('click', () => ahrefsSerpInput.click());
                ahrefsSerpDropzone.addEventListener('dragover', (e) => { e.preventDefault(); ahrefsSerpDropzone.classList.add('bg-teal-100'); });
                ahrefsSerpDropzone.addEventListener('dragleave', () => ahrefsSerpDropzone.classList.remove('bg-teal-100'));
                ahrefsSerpDropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    ahrefsSerpDropzone.classList.remove('bg-teal-100');
                    if (e.dataTransfer.files.length > 0) handleSerpCSV(e.dataTransfer.files[0], 'ahrefs');
                });
                ahrefsSerpInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) handleSerpCSV(e.target.files[0], 'ahrefs');
                });
            }
        }

        // 競合分析モード切り替え
        function switchCompetitorMode(mode) {
            currentCompetitorMode = mode;
            const siteMode = document.getElementById('comp-site-mode');
            const serpMode = document.getElementById('comp-serp-mode');
            const siteTab = document.getElementById('comp-mode-site');
            const serpTab = document.getElementById('comp-mode-serp');

            if (mode === 'site') {
                siteMode.classList.remove('hidden');
                serpMode.classList.add('hidden');
                siteTab.classList.add('border-b-2', 'border-indigo-500', 'text-indigo-600');
                siteTab.classList.remove('text-gray-500');
                serpTab.classList.remove('border-b-2', 'border-indigo-500', 'text-indigo-600');
                serpTab.classList.add('text-gray-500');
            } else {
                siteMode.classList.add('hidden');
                serpMode.classList.remove('hidden');
                serpTab.classList.add('border-b-2', 'border-indigo-500', 'text-indigo-600');
                serpTab.classList.remove('text-gray-500');
                siteTab.classList.remove('border-b-2', 'border-indigo-500', 'text-indigo-600');
                siteTab.classList.add('text-gray-500');
            }
        }

        // SERP CSVファイル処理
        function handleSerpCSV(file, source) {
            const statusEl = document.getElementById(`${source}-serp-file-status`);

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const data = results.data;
                    const serpResults = extractSerpData(data, source);

                    uploadedSerpData[source] = serpResults;

                    // ステータス表示
                    if (statusEl) {
                        statusEl.classList.remove('hidden');
                        statusEl.innerHTML = `<span class="material-symbols-outlined icon-sm text-green-600">check_circle</span> ${file.name} - ${serpResults.length}件の検索結果を読み込みました`;
                    }

                    // プレビュー更新
                    updateSerpPreview();
                },
                error: function(error) {
                    if (statusEl) {
                        statusEl.classList.remove('hidden');
                        statusEl.innerHTML = `<span class="material-symbols-outlined icon-sm text-red-600">error</span> 読み込みエラー: ${error.message}`;
                    }
                }
            });
        }

        // SERP CSVからデータを抽出
        function extractSerpData(data, source) {
            const results = [];
            data.forEach((row, index) => {
                let position = index + 1;
                let url = '';
                let title = '';

                // Semrush形式
                if (source === 'semrush') {
                    position = parseInt(row['Position'] || row['#'] || row['Rank'] || position);
                    url = row['URL'] || row['Page URL'] || row['Domain'] || '';
                    title = row['Title'] || row['Page Title'] || row['Meta Title'] || '';
                }
                // Ahrefs形式
                else if (source === 'ahrefs') {
                    position = parseInt(row['#'] || row['Position'] || row['Rank'] || position);
                    url = row['URL'] || row['Target URL'] || '';
                    title = row['Title'] || row['Page title'] || '';
                }

                if (url && position <= 20) {
                    results.push({ position, url, title });
                }
            });

            // 順位でソート
            return results.sort((a, b) => a.position - b.position).slice(0, 20);
        }

        // SERPデータプレビュー更新
        function updateSerpPreview() {
            const previewContainer = document.getElementById('serp-data-preview');
            const previewContent = document.getElementById('serp-preview-content');

            if (!previewContainer || !previewContent) return;

            // 手動入力のURLも取得
            const manualUrls = document.getElementById('serp-urls-manual')?.value || '';
            if (manualUrls.trim()) {
                const urls = manualUrls.split('\n').filter(u => u.trim()).slice(0, 20);
                uploadedSerpData.manual = urls.map((url, i) => ({
                    position: i + 1,
                    url: url.trim(),
                    title: ''
                }));
            }

            const semrush = uploadedSerpData.semrush;
            const ahrefs = uploadedSerpData.ahrefs;
            const manual = uploadedSerpData.manual;

            // データがなければ非表示
            if ((!semrush || semrush.length === 0) && (!ahrefs || ahrefs.length === 0) && (!manual || manual.length === 0)) {
                previewContainer.classList.add('hidden');
                return;
            }

            // 優先順位: semrush > ahrefs > manual
            const displayData = semrush && semrush.length > 0 ? semrush :
                               ahrefs && ahrefs.length > 0 ? ahrefs : manual;

            let html = '<table class="w-full text-xs"><thead><tr class="border-b"><th class="py-1 text-left w-12">順位</th><th class="py-1 text-left">URL</th><th class="py-1 text-left">タイトル</th></tr></thead><tbody>';
            displayData.forEach(item => {
                const shortUrl = item.url.length > 50 ? item.url.substring(0, 50) + '...' : item.url;
                const shortTitle = item.title ? (item.title.length > 30 ? item.title.substring(0, 30) + '...' : item.title) : '-';
                html += `<tr class="border-b border-indigo-100"><td class="py-1 font-bold">${item.position}</td><td class="py-1 text-indigo-500">${shortUrl}</td><td class="py-1">${shortTitle}</td></tr>`;
            });
            html += '</tbody></table>';

            previewContent.innerHTML = html;
            previewContainer.classList.remove('hidden');
        }

        // 競合CSVファイル処理
        function handleCompetitorCSV(file, source) {
            const statusEl = document.getElementById(`${source}-file-status`);

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const data = results.data;
                    let headings = [];
                    let sites = [];

                    if (source === 'semrush') {
                        // Semrush CSVフォーマット解析
                        // 一般的なカラム: URL, Title, H1, H2, etc. または Position, URL, Title
                        headings = extractHeadingsFromSemrush(data);
                    } else if (source === 'ahrefs') {
                        // Ahrefs CSVフォーマット解析
                        headings = extractHeadingsFromAhrefs(data);
                    }

                    uploadedCompetitorData[source] = { headings, sites, raw: data };

                    // ステータス表示
                    if (statusEl) {
                        statusEl.classList.remove('hidden');
                        statusEl.innerHTML = `<span class="material-symbols-outlined icon-sm text-green-600">check_circle</span> ${file.name} - ${headings.length}件の見出しを読み込みました`;
                    }

                    // プレビュー更新
                    updateCompetitorPreview();
                },
                error: function(error) {
                    if (statusEl) {
                        statusEl.classList.remove('hidden');
                        statusEl.innerHTML = `<span class="material-symbols-outlined icon-sm text-red-600">error</span> 読み込みエラー: ${error.message}`;
                    }
                }
            });
        }

        // Semrush CSVから見出しを抽出
        function extractHeadingsFromSemrush(data) {
            const headings = [];
            data.forEach(row => {
                // よくあるSemrushのカラム名をチェック
                const possibleHeadingColumns = ['H1', 'H2', 'H3', 'Title', 'Heading', '見出し', 'Page Title'];
                possibleHeadingColumns.forEach(col => {
                    if (row[col] && row[col].trim()) {
                        headings.push(row[col].trim());
                    }
                });
                // URLからサイト情報も取得
                if (row['URL'] || row['Page URL']) {
                    const url = row['URL'] || row['Page URL'];
                    try {
                        const domain = new URL(url).hostname;
                        if (!headings.includes(domain)) {
                            // サイト情報として保存
                        }
                    } catch(e) {}
                }
            });
            return [...new Set(headings)]; // 重複除去
        }

        // Ahrefs CSVから見出しを抽出
        function extractHeadingsFromAhrefs(data) {
            const headings = [];
            data.forEach(row => {
                // Ahrefsのカラム名をチェック
                const possibleHeadingColumns = ['Title', 'H1', 'H2', 'Content', 'Anchor', '見出し'];
                possibleHeadingColumns.forEach(col => {
                    if (row[col] && row[col].trim()) {
                        headings.push(row[col].trim());
                    }
                });
            });
            return [...new Set(headings)]; // 重複除去
        }

        // 競合データプレビュー更新
        function updateCompetitorPreview() {
            const previewContainer = document.getElementById('competitor-data-preview');
            const previewContent = document.getElementById('competitor-preview-content');

            if (!previewContainer || !previewContent) return;

            const semrush = uploadedCompetitorData.semrush;
            const ahrefs = uploadedCompetitorData.ahrefs;

            if (!semrush && !ahrefs) {
                previewContainer.classList.add('hidden');
                return;
            }

            let html = '';
            if (semrush && semrush.headings.length > 0) {
                html += `<div class="mb-2"><strong class="text-orange-600">Semrush:</strong> ${semrush.headings.slice(0, 5).join(', ')}${semrush.headings.length > 5 ? '...' : ''}</div>`;
            }
            if (ahrefs && ahrefs.headings.length > 0) {
                html += `<div><strong class="text-blue-600">Ahrefs:</strong> ${ahrefs.headings.slice(0, 5).join(', ')}${ahrefs.headings.length > 5 ? '...' : ''}</div>`;
            }

            previewContent.innerHTML = html;
            previewContainer.classList.remove('hidden');
        }

        // 競合分析タブへ遷移
        function goToCompetitorAnalysis(keyword) {
            currentCompetitorKeyword = keyword || '';

            // 入力をクリア
            for (let i = 1; i <= 3; i++) {
                const titleInput = document.getElementById(`comp-${i}-title`);
                const headingsInput = document.getElementById(`comp-${i}-headings`);
                if (titleInput) titleInput.value = '';
                if (headingsInput) headingsInput.value = '';
            }
            document.getElementById('competitor-analysis-result').classList.add('hidden');

            // 競合分析タブに切り替え
            showArticleMainTab('competitor');
        }

        // 競合分析をスキップ（構成作成タブへ）
        function skipCompetitorAnalysis() {
            showArticleMainTab('design');
        }

        // 競合見出し分析データ
        let competitorHeadingsData = {
            sites: [],
            mustHave: [],
            diffHeadings: [],
            kciUnique: [],
            recommended: []
        };

        // 見出し分析実行
        function analyzeCompetitorHeadings() {
            const sites = [];

            // SERPモードの場合
            if (currentCompetitorMode === 'serp') {
                // 手動入力URLを更新
                const manualUrls = document.getElementById('serp-urls-manual')?.value || '';
                if (manualUrls.trim()) {
                    const urls = manualUrls.split('\n').filter(u => u.trim()).slice(0, 20);
                    uploadedSerpData.manual = urls.map((url, i) => ({
                        position: i + 1,
                        url: url.trim(),
                        title: ''
                    }));
                }

                // SERP データを取得
                const serpData = uploadedSerpData.semrush && uploadedSerpData.semrush.length > 0 ? uploadedSerpData.semrush :
                                uploadedSerpData.ahrefs && uploadedSerpData.ahrefs.length > 0 ? uploadedSerpData.ahrefs :
                                uploadedSerpData.manual;

                if (!serpData || serpData.length === 0) {
                    alert('SERP CSVをアップロードするか、手動でURLを入力してください');
                    return;
                }

                // SERPデータからサイト情報を生成
                serpData.forEach(item => {
                    sites.push({
                        rank: item.position,
                        title: item.title || `${item.position}位: ${getDomainFromUrl(item.url)}`,
                        url: item.url,
                        headings: [item.title].filter(t => t) // タイトルを見出しとして使用
                    });
                });

                competitorHeadingsData.sites = sites;
                competitorHeadingsData.isSerpMode = true;
                competitorHeadingsData.serpUrls = serpData;

                // SERPデータから記事生成用のデータを生成
                const serpAnalysisForArticle = generateSerpDataForArticle(serpData);
                competitorHeadingsData.mustHave = serpAnalysisForArticle.mustHave;
                competitorHeadingsData.kciUnique = serpAnalysisForArticle.kciUnique;
                competitorHeadingsData.recommended = serpAnalysisForArticle.recommended;
                competitorHeadingsData.diffHeadings = serpAnalysisForArticle.diffHeadings;

                // SERP分析結果を表示
                renderSerpAnalysis(serpData);
                document.getElementById('competitor-analysis-result').classList.remove('hidden');
                return;
            }

            // 通常の競合サイト分析モード
            // 1. アップロードされたCSVデータをチェック
            if (uploadedCompetitorData.semrush && uploadedCompetitorData.semrush.headings.length > 0) {
                const headings = uploadedCompetitorData.semrush.headings.map(h => normalizeHeading(h));
                sites.push({ rank: 1, title: 'Semrushデータ', headings });
            }
            if (uploadedCompetitorData.ahrefs && uploadedCompetitorData.ahrefs.headings.length > 0) {
                const headings = uploadedCompetitorData.ahrefs.headings.map(h => normalizeHeading(h));
                sites.push({ rank: sites.length + 1, title: 'Ahrefsデータ', headings });
            }

            // 2. 手動入力データもチェック
            for (let i = 1; i <= 3; i++) {
                const title = document.getElementById(`comp-${i}-title`)?.value.trim() || '';
                const headingsText = document.getElementById(`comp-${i}-headings`)?.value.trim() || '';

                if (headingsText) {
                    const headings = headingsText.split('\n')
                        .map(h => h.trim())
                        .filter(h => h && !h.startsWith('例：'))
                        .map(h => normalizeHeading(h));
                    sites.push({ rank: sites.length + 1, title: title || `手動入力${i}`, headings });
                }
            }

            if (sites.length === 0) {
                alert('CSVファイルをアップロードするか、手動で見出しを入力してください');
                return;
            }

            competitorHeadingsData.sites = sites;
            competitorHeadingsData.isSerpMode = false;

            // 見出し分析
            analyzeHeadings(sites);

            // 結果表示
            renderHeadingAnalysis();
            document.getElementById('competitor-analysis-result').classList.remove('hidden');
        }

        // URLからドメインを取得
        function getDomainFromUrl(url) {
            try {
                return new URL(url).hostname.replace('www.', '');
            } catch(e) {
                return url;
            }
        }

        // SERP分析結果の描画
        function renderSerpAnalysis(serpData) {
            const mustHaveEl = document.getElementById('must-have-headings');
            const diffEl = document.getElementById('diff-headings');
            const kciUniqueEl = document.getElementById('kci-unique-headings');
            const recommendedEl = document.getElementById('recommended-structure');
            const comparisonEl = document.getElementById('comparison-table');

            // 上位サイトの傾向分析
            const domains = serpData.map(item => getDomainFromUrl(item.url));
            const domainTypes = analyzeDomainTypes(domains);

            // 必須見出しエリア → SERP概要
            if (mustHaveEl) {
                let html = `<div class="text-sm mb-2"><strong>検索上位${serpData.length}サイトの概要</strong></div>`;
                html += '<div class="space-y-1">';
                serpData.slice(0, 10).forEach(item => {
                    const domain = getDomainFromUrl(item.url);
                    html += `<div class="flex items-center gap-2 text-xs">
                        <span class="w-6 h-6 flex items-center justify-center bg-indigo-600 text-white rounded-full font-bold text-xs">${item.position}</span>
                        <a href="${item.url}" target="_blank" class="text-indigo-600 hover:underline truncate flex-1">${domain}</a>
                        <span class="text-gray-500 truncate max-w-[200px]">${item.title || '-'}</span>
                    </div>`;
                });
                html += '</div>';
                mustHaveEl.innerHTML = html;
            }

            // 差別化ポイント → サイトタイプ分析
            if (diffEl) {
                let html = '<div class="text-sm mb-2"><strong>上位サイトの種類</strong></div>';
                html += '<div class="space-y-1 text-xs">';
                if (domainTypes.official > 0) html += `<div>官公庁・公式サイト: <strong class="text-amber-700">${domainTypes.official}件</strong></div>`;
                if (domainTypes.corporate > 0) html += `<div>企業サイト: <strong class="text-amber-700">${domainTypes.corporate}件</strong></div>`;
                if (domainTypes.media > 0) html += `<div>メディア・ポータル: <strong class="text-amber-700">${domainTypes.media}件</strong></div>`;
                if (domainTypes.other > 0) html += `<div>その他: <strong class="text-amber-700">${domainTypes.other}件</strong></div>`;
                html += '</div>';
                html += '<div class="mt-2 p-2 bg-amber-100 rounded text-xs">';
                html += '<strong>差別化のヒント:</strong> ';
                if (domainTypes.official > 3) {
                    html += '官公庁サイトが多いため、「わかりやすさ」「実践的な情報」で差別化';
                } else if (domainTypes.media > 3) {
                    html += 'メディアサイトが多いため、「専門性」「実務経験」で差別化';
                } else {
                    html += '競合企業と差別化するため、自社の強みを前面に出す構成を検討';
                }
                html += '</div>';
                diffEl.innerHTML = html;
            }

            // KCI独自の強み提案
            if (kciUniqueEl) {
                const settings = getSiteSettings();
                let html = '<div class="space-y-1 text-xs">';
                html += `<div class="p-2 bg-green-100 rounded"><strong>推奨アプローチ：</strong></div>`;
                html += '<ul class="list-disc list-inside space-y-1 mt-2">';
                html += '<li>上位サイトにない<strong>独自の切り口</strong>を追加</li>';
                html += '<li>実務経験に基づく<strong>具体的なアドバイス</strong></li>';
                if (settings.features.length > 0) {
                    html += `<li>${settings.name}の強み: <strong>${settings.features.slice(0, 3).join('、')}</strong></li>`;
                }
                html += '<li><strong>FAQ形式</strong>で検索意図に直接回答</li>';
                html += '</ul>';
                html += '</div>';
                kciUniqueEl.innerHTML = html;
            }

            // 推奨構成
            if (recommendedEl) {
                let html = '<div class="text-xs space-y-1">';
                html += '<div class="p-2 bg-slate-100 rounded mb-2"><strong>上位表示を狙うための構成案</strong></div>';
                html += '<ol class="list-decimal list-inside space-y-1">';
                html += '<li>導入（キーワードの定義・結論ファースト）</li>';
                html += '<li>基本情報（上位サイトが共通して扱うトピック）</li>';
                html += '<li>実践的な内容（手順・方法・選び方）</li>';
                html += '<li>差別化コンテンツ（自社独自の強み）</li>';
                html += '<li>FAQ（よくある質問への回答）</li>';
                html += '<li>まとめ・CTA</li>';
                html += '</ol>';
                html += '</div>';
                recommendedEl.innerHTML = html;
            }

            // 比較表 → SERP分析ヒートマップ
            if (comparisonEl) {
                // タイトルからキーワードを抽出して頻度分析
                const titleKeywords = {};
                const topicPatterns = [
                    { pattern: /とは|基礎|基本|入門|概要/, topic: '基本・定義' },
                    { pattern: /方法|やり方|手順|流れ|ステップ/, topic: '方法・手順' },
                    { pattern: /比較|違い|おすすめ|選び方|ランキング/, topic: '比較・選び方' },
                    { pattern: /費用|料金|価格|相場|コスト/, topic: '費用・料金' },
                    { pattern: /資格|免許|取得|合格/, topic: '資格・免許' },
                    { pattern: /期間|日数|時間|何日/, topic: '期間・時間' },
                    { pattern: /申込|申請|手続き|届出/, topic: '申込・手続き' },
                    { pattern: /メリット|デメリット|注意|ポイント/, topic: 'メリット・注意点' },
                    { pattern: /オンライン|web|eラーニング|通信/, topic: 'オンライン' },
                    { pattern: /講習|教育|研修|セミナー/, topic: '講習・教育' }
                ];

                // 各サイトがどのトピックをカバーしているか分析
                const siteToCoverage = {};
                serpData.forEach(item => {
                    const title = item.title || '';
                    siteToCoverage[item.position] = [];
                    topicPatterns.forEach(({ pattern, topic }) => {
                        if (pattern.test(title)) {
                            siteToCoverage[item.position].push(topic);
                            titleKeywords[topic] = (titleKeywords[topic] || 0) + 1;
                        }
                    });
                });

                // トピックをカバレッジ順でソート
                const sortedTopics = Object.entries(titleKeywords)
                    .sort((a, b) => b[1] - a[1])
                    .map(([topic]) => topic);

                let html = `
                    <div class="mb-4 p-3 bg-gradient-to-r from-indigo-50 to-slate-50 rounded-lg">
                        <h4 class="font-semibold text-gray-700 mb-2">タイトルキーワード ヒートマップ</h4>
                        <div class="flex gap-4 text-xs flex-wrap">
                            <span class="flex items-center gap-1"><span class="w-4 h-4 rounded heatmap-high"></span> 高頻出（50%以上）</span>
                            <span class="flex items-center gap-1"><span class="w-4 h-4 rounded heatmap-mid"></span> 中頻出（25-50%）</span>
                            <span class="flex items-center gap-1"><span class="w-4 h-4 rounded heatmap-low"></span> 低頻出（25%未満）</span>
                            <span class="flex items-center gap-1"><span class="w-4 h-4 rounded heatmap-none"></span> なし</span>
                        </div>
                    </div>
                `;

                // トピック別カバレッジテーブル
                if (sortedTopics.length > 0) {
                    html += '<div class="mb-4"><h5 class="font-semibold text-sm text-gray-700 mb-2">トピック別カバレッジ</h5>';
                    html += '<table class="w-full text-xs border-collapse">';
                    html += '<thead><tr class="bg-gray-100"><th class="border p-2 text-left">トピック</th><th class="border p-2 text-center">出現率</th>';
                    // 上位10サイトのみヘッダー表示
                    for (let i = 1; i <= Math.min(10, serpData.length); i++) {
                        html += `<th class="border p-1 text-center w-8">${i}位</th>`;
                    }
                    html += '</tr></thead><tbody>';

                    sortedTopics.forEach(topic => {
                        const count = titleKeywords[topic];
                        const percent = Math.round((count / serpData.length) * 100);
                        let heatClass = 'heatmap-none';
                        if (percent >= 50) heatClass = 'heatmap-high';
                        else if (percent >= 25) heatClass = 'heatmap-mid';
                        else if (percent > 0) heatClass = 'heatmap-low';

                        html += `<tr><td class="border p-2 font-medium">${topic}</td>`;
                        html += `<td class="border p-2 text-center heatmap-cell ${heatClass}">${percent}%</td>`;

                        for (let i = 1; i <= Math.min(10, serpData.length); i++) {
                            const hasTopic = siteToCoverage[i]?.includes(topic);
                            html += `<td class="border p-1 text-center">${hasTopic ? '<span class="text-indigo-600">●</span>' : '<span class="text-gray-300">−</span>'}</td>`;
                        }
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                }

                // サイトタイプ分布グラフ
                const total = serpData.length;
                html += `
                    <div class="mb-4">
                        <h5 class="font-semibold text-sm text-gray-700 mb-2">サイトタイプ分布</h5>
                        <div class="flex h-6 rounded-lg overflow-hidden">
                            ${domainTypes.official > 0 ? `<div class="bg-red-500 flex items-center justify-center text-white text-xs" style="width:${(domainTypes.official/total)*100}%">${domainTypes.official}</div>` : ''}
                            ${domainTypes.corporate > 0 ? `<div class="bg-blue-500 flex items-center justify-center text-white text-xs" style="width:${(domainTypes.corporate/total)*100}%">${domainTypes.corporate}</div>` : ''}
                            ${domainTypes.media > 0 ? `<div class="bg-green-500 flex items-center justify-center text-white text-xs" style="width:${(domainTypes.media/total)*100}%">${domainTypes.media}</div>` : ''}
                            ${domainTypes.other > 0 ? `<div class="bg-gray-400 flex items-center justify-center text-white text-xs" style="width:${(domainTypes.other/total)*100}%">${domainTypes.other}</div>` : ''}
                        </div>
                        <div class="flex gap-4 text-xs mt-1">
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-red-500"></span> 官公庁</span>
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-blue-500"></span> 企業</span>
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-green-500"></span> メディア</span>
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-gray-400"></span> その他</span>
                        </div>
                    </div>
                `;

                // 詳細一覧テーブル
                html += '<details class="mt-4"><summary class="text-sm text-gray-600 cursor-pointer hover:text-indigo-600">全サイト一覧を表示</summary>';
                html += '<table class="w-full text-xs border-collapse mt-2">';
                html += '<thead><tr class="bg-gray-100"><th class="p-2 text-left border">順位</th><th class="p-2 text-left border">ドメイン</th><th class="p-2 text-left border">タイトル</th><th class="p-2 text-left border">タイプ</th></tr></thead>';
                html += '<tbody>';
                serpData.forEach(item => {
                    const domain = getDomainFromUrl(item.url);
                    const bgColor = item.position <= 3 ? 'bg-yellow-50' : item.position <= 10 ? 'bg-blue-50' : '';
                    const type = getDomainType(domain);
                    html += `<tr class="${bgColor}">
                        <td class="p-2 border font-bold">${item.position}</td>
                        <td class="p-2 border"><a href="${item.url}" target="_blank" class="text-indigo-600 hover:underline">${domain}</a></td>
                        <td class="p-2 border">${item.title || '-'}</td>
                        <td class="p-2 border text-center"><span class="px-1.5 py-0.5 rounded text-white text-xs ${type.class}">${type.label}</span></td>
                    </tr>`;
                });
                html += '</tbody></table></details>';

                comparisonEl.innerHTML = html;
            }
        }

        // ドメインタイプを取得
        function getDomainType(domain) {
            const d = domain.toLowerCase();
            const officialPatterns = ['.go.jp', '.lg.jp', '.ac.jp', '.ed.jp'];
            const mediaPatterns = ['wikipedia', 'yahoo', 'goo.ne.jp', 'note.com', 'zenn.dev', 'qiita', 'hatena'];

            if (officialPatterns.some(p => d.includes(p))) {
                return { label: '官公庁', class: 'bg-red-500' };
            } else if (mediaPatterns.some(p => d.includes(p))) {
                return { label: 'メディア', class: 'bg-green-500' };
            } else {
                return { label: '企業', class: 'bg-blue-500' };
            }
        }

        // ドメインタイプの分析
        function analyzeDomainTypes(domains) {
            const types = { official: 0, corporate: 0, media: 0, other: 0 };
            const officialPatterns = ['.go.jp', '.lg.jp', '.ac.jp', '.ed.jp', 'mhlw.go.jp', 'mlit.go.jp'];
            const mediaPatterns = ['wikipedia', 'yahoo', 'goo.ne.jp', 'note.com', 'zenn.dev', 'qiita', 'hatena'];

            domains.forEach(domain => {
                const d = domain.toLowerCase();
                if (officialPatterns.some(p => d.includes(p))) {
                    types.official++;
                } else if (mediaPatterns.some(p => d.includes(p))) {
                    types.media++;
                } else if (d.includes('.co.jp') || d.includes('.com') || d.includes('.jp')) {
                    types.corporate++;
                } else {
                    types.other++;
                }
            });

            return types;
        }

        // SERPデータから記事生成用データを生成
        function generateSerpDataForArticle(serpData) {
            const domains = serpData.map(item => getDomainFromUrl(item.url));
            const domainTypes = analyzeDomainTypes(domains);
            const settings = getSiteSettings();

            // タイトルから共通キーワードを抽出
            const titleWords = {};
            serpData.forEach(item => {
                if (item.title) {
                    // 日本語の単語を抽出（簡易的な形態素解析的処理）
                    const words = item.title
                        .replace(/[【】「」『』（）\[\]｜|・、。！？\d]/g, ' ')
                        .split(/\s+/)
                        .filter(w => w.length >= 2);
                    words.forEach(w => {
                        titleWords[w] = (titleWords[w] || 0) + 1;
                    });
                }
            });

            // 頻出キーワード（3回以上出現）から必須トピックを生成
            const frequentWords = Object.entries(titleWords)
                .filter(([word, count]) => count >= 3)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            // mustHave: 上位サイトで共通して使われているトピック
            const mustHave = frequentWords.map(([word, count]) => ({
                text: `${word}に関する情報`,
                count: count,
                sites: Array.from({length: count}, (_, i) => i + 1)
            }));

            // 上位3サイトのタイトルパターン分析
            const topTitles = serpData.slice(0, 5).map(item => item.title).filter(t => t);
            if (topTitles.length > 0) {
                // 上位サイトが扱っているトピックを追加
                const topicPatterns = [
                    { pattern: /とは|基礎|基本|入門/, topic: '基本・定義の解説' },
                    { pattern: /方法|やり方|手順|流れ/, topic: '具体的な方法・手順' },
                    { pattern: /比較|違い|おすすめ|選び方/, topic: '比較・選び方ガイド' },
                    { pattern: /費用|料金|価格|相場/, topic: '費用・料金情報' },
                    { pattern: /資格|免許|取得/, topic: '資格・免許情報' },
                    { pattern: /期間|日数|時間/, topic: '期間・時間の目安' },
                    { pattern: /申込|申請|手続き/, topic: '申込・手続き方法' }
                ];

                topicPatterns.forEach(({ pattern, topic }) => {
                    const matchCount = topTitles.filter(t => pattern.test(t)).length;
                    if (matchCount >= 2 && !mustHave.find(h => h.text.includes(topic))) {
                        mustHave.push({
                            text: topic,
                            count: matchCount,
                            sites: Array.from({length: matchCount}, (_, i) => i + 1)
                        });
                    }
                });
            }

            // kciUnique: 差別化のための独自コンテンツ提案
            const kciUnique = [];

            // ドメインタイプに基づく差別化提案
            if (domainTypes.official > 3) {
                kciUnique.push({ text: '実務者目線のわかりやすい解説', category: '差別化' });
                kciUnique.push({ text: '具体的な事例・体験談', category: '差別化' });
            }
            if (domainTypes.media > 3) {
                kciUnique.push({ text: '専門家による正確な情報', category: '専門性' });
                kciUnique.push({ text: '最新の法令・制度情報', category: '専門性' });
            }

            // サイト設定の強みを追加
            if (settings.features && settings.features.length > 0) {
                settings.features.slice(0, 2).forEach(feature => {
                    kciUnique.push({ text: `${feature}の詳細説明`, category: '自社強み' });
                });
            }

            // 共通の差別化ポイント
            kciUnique.push({ text: 'よくある質問（FAQ）セクション', category: 'ユーザビリティ' });
            kciUnique.push({ text: '次のステップ・アクションガイド', category: 'CV導線' });

            // diffHeadings: 差別化見出し候補
            const diffHeadings = [
                { text: '上位サイトにない独自の視点', site: 0 },
                { text: '実務経験に基づくアドバイス', site: 0 },
                { text: '最新情報・アップデート', site: 0 }
            ];

            // recommended: 推奨構成
            const recommended = [
                { text: '導入・結論ファースト（検索意図への直接回答）', level: 'h2' },
                { text: '基本情報（定義・概要）', level: 'h2' }
            ];

            // mustHaveから主要トピックを追加
            mustHave.slice(0, 3).forEach(h => {
                recommended.push({ text: h.text, level: 'h2' });
            });

            recommended.push({ text: settings.name + 'の特徴・強み', level: 'h2' });
            recommended.push({ text: 'よくある質問（FAQ）', level: 'h2' });
            recommended.push({ text: 'まとめ・次のアクション', level: 'h2' });

            return { mustHave, kciUnique, diffHeadings, recommended };
        }

        // 見出しの正規化（前処理）
        function normalizeHeading(heading) {
            return heading
                .replace(/^[#\-•◆■□●○▶︎▷→・\d\.]+\s*/, '') // 記号・番号除去
                .replace(/\s+/g, ' ')
                .trim();
        }

        // 見出し分析ロジック
        function analyzeHeadings(sites) {
            const allHeadings = [];
            const headingCount = {};

            // 全見出しをカウント
            sites.forEach(site => {
                site.headings.forEach(h => {
                    const key = getHeadingKey(h);
                    if (!headingCount[key]) {
                        headingCount[key] = { original: h, count: 0, sites: [] };
                    }
                    headingCount[key].count++;
                    headingCount[key].sites.push(site.rank);
                });
            });

            // 必須見出し（2サイト以上で共通）
            competitorHeadingsData.mustHave = Object.values(headingCount)
                .filter(h => h.count >= 2)
                .sort((a, b) => b.count - a.count)
                .map(h => ({ text: h.original, count: h.count, sites: h.sites }));

            // 差別化見出し（1サイトのみ）
            competitorHeadingsData.diffHeadings = Object.values(headingCount)
                .filter(h => h.count === 1)
                .map(h => ({ text: h.original, site: h.sites[0] }));

            // KCI独自の強み提案
            competitorHeadingsData.kciUnique = generateKCIUniqueHeadings(headingCount);

            // 推奨構成を生成
            competitorHeadingsData.recommended = generateRecommendedStructure();
        }

        // 見出しのキー生成（類似見出しをグルーピング）
        function getHeadingKey(heading) {
            const h = heading.toLowerCase();

            // 類似パターンをグルーピング
            const patterns = [
                { keywords: ['とは', '定義', '概要', '基本'], key: '基本・定義' },
                { keywords: ['対象', '誰', '受講者', '必要な人'], key: '対象者' },
                { keywords: ['内容', 'カリキュラム', '科目', '学ぶ'], key: 'カリキュラム' },
                { keywords: ['時間', '期間', '日数', '何時間'], key: '受講時間' },
                { keywords: ['費用', '料金', '価格', '値段', '金額'], key: '費用' },
                { keywords: ['方法', '受け方', '申込', '申し込み', 'どこで'], key: '受講方法' },
                { keywords: ['オンライン', 'web', 'ウェブ', 'eラーニング'], key: 'オンライン' },
                { keywords: ['有効期限', '更新', '再教育', '何年'], key: '有効期限・更新' },
                { keywords: ['違い', '比較', 'との差'], key: '違い・比較' },
                { keywords: ['メリット', '利点', '良い点'], key: 'メリット' },
                { keywords: ['注意', 'デメリット', '気をつける'], key: '注意点' },
                { keywords: ['よくある質問', 'faq', 'q&a', '質問'], key: 'FAQ' },
                { keywords: ['まとめ', '結論', '最後に'], key: 'まとめ' },
                { keywords: ['法令', '法律', '根拠', '義務'], key: '法的根拠' },
                { keywords: ['罰則', '違反', 'ペナルティ'], key: '罰則' },
                { keywords: ['実務', '現場', '実際', '体験'], key: '実務・現場' }
            ];

            for (const p of patterns) {
                if (p.keywords.some(kw => h.includes(kw))) {
                    return p.key;
                }
            }
            return heading; // マッチしなければそのまま
        }

        // KCI独自の強み提案生成
        function generateKCIUniqueHeadings(existingHeadings) {
            const kciStrengths = [
                { text: 'オンライン受講のメリット（場所・時間を選ばない）', category: 'オンライン強み' },
                { text: '最短で修了証を取得する方法', category: 'スピード' },
                { text: '受講者の声・体験談', category: 'E-E-A-T' },
                { text: '他社との料金比較表', category: '差別化' },
                { text: '申込から修了証発行までの流れ（図解）', category: 'わかりやすさ' },
                { text: 'スマホ・タブレットでの受講方法', category: '利便性' },
                { text: '法人・団体向け割引について', category: '法人訴求' },
                { text: '修了証のサンプル・発行日数', category: '信頼性' },
                { text: '24時間いつでも受講可能', category: '利便性' },
                { text: 'よくある失敗例と対策', category: '実用性' }
            ];

            // 既存見出しにないものを抽出
            const existingKeys = new Set(Object.keys(existingHeadings));
            return kciStrengths.filter(s => {
                const key = getHeadingKey(s.text);
                return !existingKeys.has(key);
            });
        }

        // 推奨見出し構成を生成
        function generateRecommendedStructure() {
            const structure = [];

            // 1. 必須見出しを追加（優先順位順）
            const mustHaveOrder = ['基本・定義', '対象者', 'カリキュラム', '受講時間', '費用', '受講方法', '法的根拠'];
            mustHaveOrder.forEach(key => {
                const found = competitorHeadingsData.mustHave.find(h => getHeadingKey(h.text) === key);
                if (found) {
                    structure.push({ text: found.text, type: 'must', reason: `${found.count}サイト共通` });
                }
            });

            // 残りの必須見出しも追加
            competitorHeadingsData.mustHave.forEach(h => {
                if (!structure.find(s => getHeadingKey(s.text) === getHeadingKey(h.text))) {
                    structure.push({ text: h.text, type: 'must', reason: `${h.count}サイト共通` });
                }
            });

            // 2. KCI独自の強み（差別化ポイント）
            competitorHeadingsData.kciUnique.slice(0, 3).forEach(h => {
                structure.push({ text: h.text, type: 'unique', reason: '競合にない独自コンテンツ' });
            });

            // 3. まとめ・CTA
            structure.push({ text: 'まとめ：今すぐ受講を申し込む', type: 'cta', reason: 'CV獲得' });

            return structure;
        }

        // 競合分析から記事構成用の見出しを取得
        function getCompetitorHeadingsForOutline() {
            if (!competitorHeadingsData.mustHave || competitorHeadingsData.mustHave.length === 0) {
                return [];
            }
            // 必須見出しとKCI独自を組み合わせ
            const headings = [];
            competitorHeadingsData.mustHave.forEach(h => {
                headings.push({ text: h.text, type: 'must', count: h.count });
            });
            if (competitorHeadingsData.kciUnique) {
                competitorHeadingsData.kciUnique.slice(0, 3).forEach(h => {
                    headings.push({ text: h.text, type: 'unique', category: h.category });
                });
            }
            return headings;
        }

        // 競合トピックを記事構成に追加
        function appendCompetitorTopics(outline, competitorHeadings, eduName) {
            if (competitorHeadings.length === 0) return outline;

            let additionalSection = `

---
【競合分析に基づく追加推奨見出し】
以下の見出しは競合サイトの分析から推奨されるトピックです：

`;
            competitorHeadings.forEach(h => {
                if (h.type === 'must') {
                    additionalSection += `## ${h.text}（競合${h.count}サイト共通）\n※このトピックは検索意図に直結します\n\n`;
                } else if (h.type === 'unique') {
                    additionalSection += `## ${h.text}【差別化ポイント】\n※競合にない独自コンテンツで差別化\n\n`;
                }
            });

            return outline + additionalSection;
        }

        // 見出し分析結果をレンダリング
        function renderHeadingAnalysis() {
            // 必須見出し
            const mustHaveHtml = competitorHeadingsData.mustHave.map(h => `
                <div class="flex items-center gap-2 p-2 bg-indigo-50 rounded-lg border border-indigo-200">
                    <span class="text-indigo-600 font-bold">${h.count}/${competitorHeadingsData.sites.length}</span>
                    <span class="flex-1 text-gray-800">${h.text}</span>
                    <span class="text-xs text-gray-500">${h.sites.map(s => s + '位').join(', ')}</span>
                </div>
            `).join('');
            document.getElementById('must-have-headings').innerHTML = mustHaveHtml || '<p class="text-gray-500 text-sm">共通見出しなし</p>';

            // 差別化見出し
            const diffHtml = competitorHeadingsData.diffHeadings.slice(0, 8).map(h => `
                <div class="flex items-center gap-2 p-2 bg-indigo-50 rounded-lg border border-indigo-200">
                    <span class="text-indigo-600 text-sm">${h.site}位のみ</span>
                    <span class="flex-1 text-gray-800">${h.text}</span>
                </div>
            `).join('');
            document.getElementById('diff-headings').innerHTML = diffHtml || '<p class="text-gray-500 text-sm">差別化見出しなし</p>';

            // KCI独自
            const kciHtml = competitorHeadingsData.kciUnique.map(h => `
                <div class="flex items-center gap-2 p-2 bg-white rounded-lg border border-indigo-200">
                    <span class="material-symbols-outlined text-indigo-600">star</span>
                    <span class="flex-1 text-gray-800">${h.text}</span>
                    <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded">${h.category}</span>
                </div>
            `).join('');
            document.getElementById('kci-unique-headings').innerHTML = kciHtml;

            // 推奨構成
            const recommendedHtml = competitorHeadingsData.recommended.map((h, i) => {
                const typeColors = {
                    must: 'border-indigo-400 bg-indigo-50',
                    unique: 'border-indigo-300 bg-indigo-50',
                    cta: 'border-slate-300 bg-slate-50'
                };
                const typeLabels = {
                    must: '<span class="material-symbols-outlined icon-sm">priority_high</span> 必須',
                    unique: '<span class="material-symbols-outlined icon-sm">star</span> 差別化',
                    cta: '<span class="material-symbols-outlined icon-sm">ads_click</span> CTA'
                };
                return `
                    <div class="flex items-center gap-2 p-2 rounded-lg border ${typeColors[h.type]}">
                        <span class="text-gray-500 font-mono text-sm w-6">${i + 1}.</span>
                        <span class="flex-1 font-medium text-gray-800">${h.text}</span>
                        <span class="text-xs text-gray-500">${typeLabels[h.type]}</span>
                    </div>
                `;
            }).join('');
            const recommendedEl = document.getElementById('recommended-structure');
            if (recommendedEl) recommendedEl.innerHTML = recommendedHtml;

            // 比較表（要素が存在する場合のみ）
            const comparisonEl = document.getElementById('comparison-table');
            if (comparisonEl) renderComparisonTable();
        }

        // 競合比較表をレンダリング（v4: ヒートマップ対応）
        function renderComparisonTable() {
            if (competitorHeadingsData.sites.length === 0) return;

            const siteCount = competitorHeadingsData.sites.length;

            // カバレッジサマリーを計算
            const topicCoverage = {};
            competitorHeadingsData.sites.forEach(site => {
                site.headings.forEach(h => {
                    const key = getHeadingKey(h);
                    if (!topicCoverage[key]) topicCoverage[key] = 0;
                    topicCoverage[key]++;
                });
            });

            let tableHtml = `
                <div class="mb-4 p-3 bg-gradient-to-r from-indigo-50 to-slate-50 rounded-lg">
                    <h4 class="font-semibold text-gray-700 mb-2">カバレッジヒートマップ</h4>
                    <div class="flex gap-4 text-xs">
                        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded heatmap-high"></span> 全サイト共通</span>
                        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded heatmap-mid"></span> 一部で使用</span>
                        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded heatmap-low"></span> 1サイトのみ</span>
                        <span class="flex items-center gap-1"><span class="w-4 h-4 rounded heatmap-none"></span> 未使用</span>
                    </div>
                </div>
            `;

            tableHtml += '<table class="w-full text-sm border-collapse">';
            tableHtml += '<thead><tr class="bg-gray-100">';
            tableHtml += '<th class="border p-2 text-left">見出しトピック</th>';
            tableHtml += '<th class="border p-2 text-center">カバレッジ</th>';
            competitorHeadingsData.sites.forEach(site => {
                tableHtml += `<th class="border p-2 text-center">${site.rank}位</th>`;
            });
            tableHtml += '<th class="border p-2 text-center bg-indigo-100">KCI推奨</th>';
            tableHtml += '</tr></thead><tbody>';

            // 全トピックを収集
            const allTopics = new Set();
            competitorHeadingsData.sites.forEach(site => {
                site.headings.forEach(h => allTopics.add(getHeadingKey(h)));
            });
            competitorHeadingsData.kciUnique.forEach(h => allTopics.add(getHeadingKey(h.text)));

            // カバレッジ順でソート
            const sortedTopics = Array.from(allTopics).sort((a, b) => (topicCoverage[b] || 0) - (topicCoverage[a] || 0));

            sortedTopics.forEach(topic => {
                const coverage = topicCoverage[topic] || 0;
                const coveragePercent = Math.round((coverage / siteCount) * 100);

                // ヒートマップクラス
                let heatClass = 'heatmap-none';
                if (coverage === siteCount) heatClass = 'heatmap-high';
                else if (coverage >= siteCount / 2) heatClass = 'heatmap-mid';
                else if (coverage > 0) heatClass = 'heatmap-low';

                tableHtml += '<tr class="hover:bg-gray-50">';
                tableHtml += `<td class="border p-2 font-medium">${topic}</td>`;
                tableHtml += `<td class="border p-2 text-center heatmap-cell ${heatClass}">${coveragePercent}%</td>`;

                competitorHeadingsData.sites.forEach(site => {
                    const has = site.headings.some(h => getHeadingKey(h) === topic);
                    tableHtml += `<td class="border p-2 text-center">${has ? '<span class="material-symbols-outlined text-indigo-600 icon-sm">check_circle</span>' : '<span class="text-gray-300">−</span>'}</td>`;
                });

                // KCI推奨
                const kciHas = competitorHeadingsData.recommended.some(h => getHeadingKey(h.text) === topic);
                tableHtml += `<td class="border p-2 text-center bg-indigo-50">${kciHas ? '<span class="material-symbols-outlined text-indigo-600 icon-sm">star</span> 推奨' : '<span class="text-gray-300">−</span>'}</td>`;
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';

            // 差別化提案を追加
            const uncoveredByAll = sortedTopics.filter(t => (topicCoverage[t] || 0) < siteCount);
            if (uncoveredByAll.length > 0) {
                tableHtml += `
                    <div class="mt-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <h4 class="font-semibold text-indigo-700 mb-2">差別化チャンス</h4>
                        <p class="text-xs text-indigo-600 mb-2">以下のトピックは競合全員がカバーしていません。追加すれば差別化できます：</p>
                        <div class="flex flex-wrap gap-2">
                            ${uncoveredByAll.slice(0, 5).map(t => `<span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs">${t}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            document.getElementById('comparison-table').innerHTML = tableHtml;
        }

        // 推奨構成をコピー
        function copyRecommendedStructure() {
            const keyword = currentCompetitorKeyword || '対象キーワード';
            let text = `# ${keyword} 記事構成案\n\n`;
            competitorHeadingsData.recommended.forEach((h, i) => {
                text += `## ${h.text}\n`;
            });
            text += `\n---\n生成日: ${new Date().toLocaleDateString('ja-JP')}\nKCI教育センター SEOツール`;

            navigator.clipboard.writeText(text).then(() => {
                alert('構成をコピーしました！');
            });
        }

        // 競合分析タブ切り替え
        function showCompetitorTab(tab) {
            // タブボタンのスタイル更新
            document.querySelectorAll('.competitor-tab-btn').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.className = 'competitor-tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-indigo-100 text-indigo-700';
                } else {
                    btn.className = 'competitor-tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200';
                }
            });

            // タブコンテンツの表示切り替え
            document.querySelectorAll('.competitor-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            const targetTab = document.getElementById(`competitor-tab-${tab}`);
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
        }

        // 競合分析結果を保存
        function saveCompetitorAnalysis() {
            // localStorageに保存
            localStorage.setItem('competitor-analysis-result', JSON.stringify(competitorHeadingsData));

            // 構成作成タブに切り替え
            showArticleMainTab('design');

            alert('競合分析の結果を保存しました。「記事構成を生成」ボタンで構成を作成してください。');
        }

        // 記事設計に反映（旧関数 - 互換性のため残す）
        function applyToArticleDesign() {
            applyAndSwitchToDesign();
        }

        // ========== v4: エクスポート機能 ==========
        function openExportModal() {
            if (keywords.length === 0) { alert('データがありません'); return; }
            document.getElementById('export-modal').classList.remove('hidden');
        }
        function closeExportModal() {
            document.getElementById('export-modal').classList.add('hidden');
        }

        // Excel出力（SheetJS使用）
        function exportExcel() {
            if (keywords.length === 0) { alert('データがありません'); return; }

            // キーワードシート
            const kwData = keywords.map(kw => ({
                キーワード: kw.keyword,
                グループ: kw.cluster,
                検索ボリューム: kw.volume,
                検索意図: kw.intent,
                CV期待度: kw.cvExpect + '%'
            }));

            // クラスターシート
            const clData = clusters.map(c => ({
                グループ名: c.name,
                優先度: c.priority,
                キーワード数: c.keywords.length,
                CV期待度: c.cvExpect + '%',
                主要KW: c.keywords.slice(0, 3).map(k => k.keyword).join(', ')
            }));

            // 優先度TOP20シート
            const top20 = keywords.slice(0, 20).map((kw, i) => ({
                順位: i + 1,
                キーワード: kw.keyword,
                グループ: kw.cluster,
                ボリューム: kw.volume,
                CV期待度: kw.cvExpect + '%'
            }));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(kwData), 'キーワード一覧');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(clData), 'クラスター');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(top20), '優先度TOP20');

            XLSX.writeFile(wb, 'keyword-analysis.xlsx');
            closeExportModal();
            alert('Excelファイルをダウンロードしました');
        }

        // JSON出力
        function exportJSON() {
            if (keywords.length === 0) { alert('データがありません'); return; }

            const data = {
                version: 'v4',
                exportedAt: new Date().toISOString(),
                keywords: keywords,
                clusters: clusters,
                competitorAnalysis: competitorHeadingsData
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'keyword-analysis-backup.json';
            a.click();
            closeExportModal();
            alert('JSONファイルをダウンロードしました（インポートで復元可能）');
        }

        // マークダウン出力
        function exportMarkdown() {
            if (clusters.length === 0) { alert('データがありません'); return; }

            let md = `# SEOキーワード分析レポート\n\n`;
            md += `生成日: ${new Date().toLocaleDateString('ja-JP')}\n\n`;
            md += `## サマリー\n`;
            md += `- 総キーワード数: ${keywords.length}\n`;
            md += `- クラスター数: ${clusters.length}\n`;
            md += `- 高優先グループ: ${clusters.filter(c => c.priority >= 4).length}\n\n`;

            md += `## クラスター一覧\n\n`;
            clusters.forEach(c => {
                md += `### ${c.name}（優先度${c.priority}）\n`;
                md += `- キーワード数: ${c.keywords.length}\n`;
                md += `- CV期待度: ${c.cvExpect}%\n`;
                md += `- 主要キーワード:\n`;
                c.keywords.slice(0, 5).forEach(kw => {
                    md += `  - ${kw.keyword} (Vol: ${kw.volume})\n`;
                });
                md += `\n`;
            });

            md += `## 優先度TOP20\n\n`;
            md += `| 順位 | キーワード | ボリューム | CV期待度 |\n`;
            md += `|------|-----------|-----------|----------|\n`;
            keywords.slice(0, 20).forEach((kw, i) => {
                md += `| ${i + 1} | ${kw.keyword} | ${kw.volume} | ${kw.cvExpect}% |\n`;
            });

            const blob = new Blob([md], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'keyword-analysis-report.md';
            a.click();
            closeExportModal();
            alert('マークダウンファイルをダウンロードしました');
        }

        // ========== v4: インポート機能 ==========
        function openImportModal() {
            document.getElementById('import-modal').classList.remove('hidden');
            initImportDropzone();
        }
        function closeImportModal() {
            document.getElementById('import-modal').classList.add('hidden');
        }

        function initImportDropzone() {
            const dropzone = document.getElementById('import-dropzone');
            const fileInput = document.getElementById('import-file-input');
            if (!dropzone || !fileInput) return;

            dropzone.onclick = () => fileInput.click();
            fileInput.onchange = (e) => {
                if (e.target.files.length > 0) handleImportFile(e.target.files[0]);
            };
            dropzone.ondragover = (e) => { e.preventDefault(); dropzone.classList.add('border-indigo-500'); };
            dropzone.ondragleave = (e) => { e.preventDefault(); dropzone.classList.remove('border-indigo-500'); };
            dropzone.ondrop = (e) => {
                e.preventDefault();
                dropzone.classList.remove('border-indigo-500');
                if (e.dataTransfer.files.length > 0) handleImportFile(e.dataTransfer.files[0]);
            };
        }

        function handleImportFile(file) {
            if (!file.name.endsWith('.json')) {
                alert('JSONファイルを選択してください');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.keywords && data.clusters) {
                        keywords = data.keywords;
                        clusters = data.clusters;
                        if (data.competitorAnalysis) {
                            competitorHeadingsData = data.competitorAnalysis;
                        }
                        renderAnalysisResult();
                        goToStep(2);
                        closeImportModal();
                        alert(`インポート完了: ${keywords.length}キーワード, ${clusters.length}クラスター`);
                    } else {
                        alert('無効なファイル形式です');
                    }
                } catch (err) {
                    alert('ファイルの読み込みに失敗しました: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // ========== v4: クラスター編集機能 ==========
        let editingClusters = [];

        function openClusterEditModal() {
            if (clusters.length === 0) { alert('データがありません'); return; }
            editingClusters = JSON.parse(JSON.stringify(clusters)); // ディープコピー
            renderClusterEditUI();
            document.getElementById('cluster-edit-modal').classList.remove('hidden');
        }

        function closeClusterEditModal() {
            document.getElementById('cluster-edit-modal').classList.add('hidden');
        }

        function renderClusterEditUI() {
            const container = document.getElementById('cluster-edit-container');
            container.innerHTML = editingClusters.map((c, cIdx) => `
                <div class="border-2 rounded-xl p-3 cluster-drop-zone" data-cluster-idx="${cIdx}" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, ${cIdx})">
                    <div class="flex justify-between items-center mb-2">
                        <input type="text" class="font-semibold text-gray-800 bg-transparent border-b border-transparent hover:border-gray-300 focus:border-indigo-500 outline-none" value="${c.name}" onchange="updateClusterName(${cIdx}, this.value)">
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded">${c.keywords.length}件</span>
                    </div>
                    <div class="space-y-1 max-h-48 overflow-y-auto">
                        ${c.keywords.map((kw, kwIdx) => `
                            <div class="draggable-kw bg-gray-50 px-2 py-1 rounded text-sm flex justify-between items-center" draggable="true" ondragstart="handleDragStart(event, ${cIdx}, ${kwIdx})">
                                <span class="truncate">${kw.keyword}</span>
                                <span class="text-xs text-gray-400">${kw.volume}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        let draggedItem = null;

        function handleDragStart(e, clusterIdx, keywordIdx) {
            draggedItem = { clusterIdx, keywordIdx };
            e.target.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e, targetClusterIdx) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (!draggedItem || draggedItem.clusterIdx === targetClusterIdx) return;

            // キーワードを移動
            const kw = editingClusters[draggedItem.clusterIdx].keywords.splice(draggedItem.keywordIdx, 1)[0];
            kw.cluster = editingClusters[targetClusterIdx].name;
            editingClusters[targetClusterIdx].keywords.push(kw);

            draggedItem = null;
            renderClusterEditUI();
        }

        function updateClusterName(idx, newName) {
            const oldName = editingClusters[idx].name;
            editingClusters[idx].name = newName;
            editingClusters[idx].keywords.forEach(kw => {
                if (kw.cluster === oldName) kw.cluster = newName;
            });
        }

        function addCustomCluster() {
            const name = prompt('新しいクラスター名を入力:');
            if (name && name.trim()) {
                editingClusters.push({
                    name: name.trim(),
                    keywords: [],
                    priority: 3,
                    cvExpect: 50
                });
                renderClusterEditUI();
            }
        }

        function saveClusterEdits() {
            // 空のクラスターを削除
            editingClusters = editingClusters.filter(c => c.keywords.length > 0);

            // グローバル変数を更新
            clusters = editingClusters;
            keywords = [];
            clusters.forEach(c => {
                c.keywords.forEach(kw => keywords.push(kw));
            });

            // 再ソート
            keywords.sort((a, b) => {
                const scoreA = a.cvExpect * Math.log10(a.volume + 1);
                const scoreB = b.cvExpect * Math.log10(b.volume + 1);
                return scoreB - scoreA;
            });

            renderAnalysisResult();
            closeClusterEditModal();
            alert('クラスター編集を保存しました');
        }

        // ========== 記事アイデアメモ機能 ==========
        let articleIdeas = [];

        function toggleArticleIdeasPanel() {
            const panel = document.getElementById('ideas-panel-content');
            panel.classList.toggle('hidden');
        }

        function loadArticleIdeas() {
            try {
                const saved = localStorage.getItem('seo-article-ideas');
                if (saved) {
                    articleIdeas = JSON.parse(saved);
                }
            } catch (e) {
                articleIdeas = [];
            }
            renderArticleIdeas();
        }

        function saveArticleIdeas() {
            localStorage.setItem('seo-article-ideas', JSON.stringify(articleIdeas));
            updateIdeasBadge();
        }

        function updateIdeasBadge() {
            const badge = document.getElementById('ideas-count-badge');
            if (articleIdeas.length > 0) {
                badge.textContent = articleIdeas.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function addArticleIdea(ideaText) {
            const input = document.getElementById('new-idea-input');
            const text = ideaText || input?.value?.trim();

            if (!text) return;

            // 重複チェック
            if (articleIdeas.some(idea => idea.text === text)) {
                alert('すでに登録されています');
                return;
            }

            articleIdeas.push({
                id: Date.now(),
                text: text,
                createdAt: new Date().toISOString(),
                status: 'pending' // pending, in_progress, done
            });

            if (input) input.value = '';
            saveArticleIdeas();
            renderArticleIdeas();
        }

        // 記事結果画面から派生記事アイデアを追加
        function addRelatedIdea() {
            const input = document.getElementById('related-idea-input');
            if (input && input.value.trim()) {
                addArticleIdea(input.value.trim());
                input.value = '';
                // パネルを開いて追加されたことを視覚的に確認
                const panel = document.getElementById('article-ideas-panel');
                if (panel && panel.classList.contains('hidden')) {
                    toggleArticleIdeasPanel();
                }
            }
        }

        function removeArticleIdea(id) {
            articleIdeas = articleIdeas.filter(idea => idea.id !== id);
            saveArticleIdeas();
            renderArticleIdeas();
        }

        function startArticleFromIdea(id) {
            const idea = articleIdeas.find(i => i.id === id);
            if (!idea) return;

            // ステータスを更新
            idea.status = 'in_progress';
            saveArticleIdeas();
            renderArticleIdeas();

            // Step 3に移動してキーワードをセット
            goToStep(3);

            // メインキーワード入力欄にセット
            const mainKwInput = document.getElementById('main-keyword');
            if (mainKwInput) {
                mainKwInput.value = idea.text;
            }

            // パネルを閉じる
            document.getElementById('ideas-panel-content').classList.add('hidden');

            // フォーカスを当てる
            setTimeout(() => {
                mainKwInput?.focus();
                alert(`「${idea.text}」で記事構成を作成します。\n記事タイプを選択して「記事構成を生成」をクリックしてください。`);
            }, 300);
        }

        function markIdeaAsDone(id) {
            const idea = articleIdeas.find(i => i.id === id);
            if (idea) {
                idea.status = 'done';
                saveArticleIdeas();
                renderArticleIdeas();
            }
        }

        function renderArticleIdeas() {
            const container = document.getElementById('ideas-list');
            if (!container) return;

            if (articleIdeas.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">アイデアがありません</p>';
                updateIdeasBadge();
                return;
            }

            // ステータス別にソート（pending > in_progress > done）
            const sortedIdeas = [...articleIdeas].sort((a, b) => {
                const order = { pending: 0, in_progress: 1, done: 2 };
                return order[a.status] - order[b.status];
            });

            container.innerHTML = sortedIdeas.map(idea => {
                const statusClass = {
                    pending: 'bg-gray-100 border-gray-200',
                    in_progress: 'bg-yellow-50 border-yellow-300',
                    done: 'bg-green-50 border-green-200 opacity-60'
                }[idea.status];

                const statusIcon = {
                    pending: '<span class="material-symbols-outlined icon-sm text-gray-400">schedule</span>',
                    in_progress: '<span class="material-symbols-outlined icon-sm text-yellow-600">edit_note</span>',
                    done: '<span class="material-symbols-outlined icon-sm text-green-600">check_circle</span>'
                }[idea.status];

                return `
                    <div class="p-2 rounded-lg border ${statusClass} group">
                        <div class="flex items-start gap-2">
                            ${statusIcon}
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-800 truncate cursor-pointer hover:text-indigo-600"
                                   onclick="startArticleFromIdea(${idea.id})"
                                   title="クリックで記事作成を開始">
                                    ${idea.text}
                                </p>
                                <p class="text-xs text-gray-400">${new Date(idea.createdAt).toLocaleDateString('ja-JP')}</p>
                            </div>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                ${idea.status !== 'done' ? `
                                    <button onclick="markIdeaAsDone(${idea.id})" class="text-green-500 hover:text-green-700" title="完了">
                                        <span class="material-symbols-outlined icon-sm">check</span>
                                    </button>
                                ` : ''}
                                <button onclick="removeArticleIdea(${idea.id})" class="text-red-400 hover:text-red-600" title="削除">
                                    <span class="material-symbols-outlined icon-sm">delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateIdeasBadge();
        }

        // AI出力からアイデアを抽出して追加する機能
        function extractAndSuggestIdeas(text) {
            // 関連キーワードや派生記事を検出するパターン
            const patterns = [
                /関連[：:]\s*「?([^」\n]+)」?/g,
                /派生記事[：:]\s*「?([^」\n]+)」?/g,
                /おすすめ記事[：:]\s*「?([^」\n]+)」?/g,
                /「([^」]+)」(?:について|とは|の[取得方法|やり方|違い])/g
            ];

            const suggestions = [];
            patterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    if (match[1] && match[1].length > 3 && match[1].length < 50) {
                        suggestions.push(match[1].trim());
                    }
                }
            });

            return [...new Set(suggestions)];
        }

        // ========== 改善メモ機能 ==========
        let improvementMemos = [];
        let currentImprovementCategory = 'その他';

        function toggleImprovementMemo() {
            const panel = document.getElementById('improvement-panel-content');
            panel.classList.toggle('hidden');
        }

        function setImprovementCategory(cat) {
            currentImprovementCategory = cat;
            document.querySelectorAll('.improvement-cat-btn').forEach(btn => {
                btn.classList.remove('bg-amber-500', 'text-white');
                btn.classList.add('bg-gray-100');
                if (btn.dataset.cat === cat) {
                    btn.classList.remove('bg-gray-100');
                    btn.classList.add('bg-amber-500', 'text-white');
                }
            });
        }

        function addImprovementMemo() {
            const input = document.getElementById('improvement-input');
            const text = input.value.trim();
            if (!text) return;

            const memo = {
                id: Date.now(),
                text: text,
                category: currentImprovementCategory,
                date: new Date().toLocaleString('ja-JP'),
                resolved: false
            };
            improvementMemos.unshift(memo);
            input.value = '';
            saveImprovementMemos();
            renderImprovementMemos();
        }

        function removeImprovementMemo(id) {
            improvementMemos = improvementMemos.filter(m => m.id !== id);
            saveImprovementMemos();
            renderImprovementMemos();
        }

        function toggleMemoResolved(id) {
            const memo = improvementMemos.find(m => m.id === id);
            if (memo) {
                memo.resolved = !memo.resolved;
                saveImprovementMemos();
                renderImprovementMemos();
            }
        }

        function saveImprovementMemos() {
            localStorage.setItem('seo-tool-improvement-memos', JSON.stringify(improvementMemos));
        }

        function loadImprovementMemos() {
            try {
                const saved = localStorage.getItem('seo-tool-improvement-memos');
                if (saved) {
                    improvementMemos = JSON.parse(saved);
                    renderImprovementMemos();
                }
            } catch (e) {}
        }

        function renderImprovementMemos() {
            const list = document.getElementById('improvement-list');
            const badge = document.getElementById('improvement-count-badge');
            const unresolvedCount = improvementMemos.filter(m => !m.resolved).length;

            if (unresolvedCount > 0) {
                badge.textContent = unresolvedCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            if (improvementMemos.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">メモがありません</p>';
                return;
            }

            const catColors = { 'UI': 'blue', '機能': 'green', 'バグ': 'red', 'その他': 'gray' };
            list.innerHTML = improvementMemos.map(memo => {
                const color = catColors[memo.category] || 'gray';
                return `
                    <div class="p-2 rounded-lg border ${memo.resolved ? 'bg-gray-50 opacity-60' : 'bg-white'} text-sm">
                        <div class="flex justify-between items-start gap-2">
                            <div class="flex-1">
                                <span class="inline-block px-1.5 py-0.5 text-xs rounded bg-${color}-100 text-${color}-700 mb-1">${memo.category}</span>
                                <p class="${memo.resolved ? 'line-through text-gray-400' : 'text-gray-700'}">${memo.text}</p>
                                <p class="text-xs text-gray-400 mt-1">${memo.date}</p>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="toggleMemoResolved(${memo.id})" class="text-${memo.resolved ? 'gray' : 'green'}-500 hover:text-${memo.resolved ? 'gray' : 'green'}-700" title="${memo.resolved ? '未解決に戻す' : '解決済みにする'}">
                                    <span class="material-symbols-outlined icon-sm">${memo.resolved ? 'undo' : 'check_circle'}</span>
                                </button>
                                <button onclick="removeImprovementMemo(${memo.id})" class="text-red-400 hover:text-red-600" title="削除">
                                    <span class="material-symbols-outlined icon-sm">delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function exportImprovementMemos() {
            if (improvementMemos.length === 0) {
                alert('エクスポートするメモがありません');
                return;
            }
            const text = improvementMemos.map(m =>
                `[${m.category}] ${m.resolved ? '(解決済)' : ''} ${m.text}\n  日時: ${m.date}`
            ).join('\n\n');
            copyToClipboard(text, '改善メモをコピーしました');
        }

        // ========== 法令コードチェック機能 ==========
        function runLegalCodeCheck() {
            const outline = document.getElementById('article-outline').textContent;
            if (!outline || outline.trim() === '' || outline.includes('クラスターを選択')) {
                alert('チェックする記事構成がありません。先に記事構成を生成してください。');
                return;
            }

            const cluster = clusters[selectedClusterIndex];
            const mainKw = cluster?.keywords[0]?.keyword || '';
            const results = {
                errors: [],      // 重大な誤り（修正必須）
                warnings: [],    // 注意（確認推奨）
                suggestions: [], // 提案（あると良い）
                passed: [],      // チェックOK
                legalRefs: []    // 引用すべき法令情報
            };

            // 教育種別を特定
            const eduKeyPatterns = [
                { patterns: ['フルハーネス'], key: 'フルハーネス' },
                { patterns: ['足場'], key: '足場' },
                { patterns: ['職長', '安全衛生責任者', '安責'], key: '職長・安全衛生責任者' },
                { patterns: ['職長教育'], key: '職長教育' },
                { patterns: ['酸欠', '酸素欠乏'], key: '酸欠' },
                { patterns: ['粉じん', '粉塵'], key: '粉じん' },
                { patterns: ['低圧電気', '低圧'], key: '低圧電気' },
                { patterns: ['石綿', 'アスベスト'], key: '石綿' },
                { patterns: ['丸のこ', '丸鋸'], key: '丸のこ' },
                { patterns: ['グラインダー', '研削'], key: 'グラインダー' },
                { patterns: ['振動工具'], key: '振動工具' },
                { patterns: ['玉掛け'], key: '玉掛け' },
                { patterns: ['フォークリフト'], key: 'フォークリフト' },
                { patterns: ['高所作業車'], key: '高所作業車' }
            ];

            let detectedEduKey = null;
            for (const ep of eduKeyPatterns) {
                if (ep.patterns.some(p => mainKw.includes(p))) {
                    detectedEduKey = ep.key;
                    break;
                }
            }

            // 特別教育のチェック
            if (detectedEduKey && LEGAL_REFERENCE.specialEducations[detectedEduKey]) {
                const edu = LEGAL_REFERENCE.specialEducations[detectedEduKey];

                // 講習時間のチェック
                const hoursMatch = outline.match(/(\d+(?:\.\d+)?)\s*時間/g);
                if (hoursMatch) {
                    hoursMatch.forEach(match => {
                        const hours = parseFloat(match);
                        if (hours > 0 && hours < 20) {
                            if (hours !== edu.totalHours && Math.abs(hours - edu.totalHours) > 0.5) {
                                if (hours < edu.totalHours) {
                                    results.warnings.push({
                                        type: '講習時間',
                                        message: `「${match}」→ ${edu.shortName}の法定時間は${edu.totalHours}時間です`,
                                        correct: `${edu.totalHours}時間`,
                                        law: edu.law
                                    });
                                }
                            } else {
                                results.passed.push(`講習時間 ${edu.totalHours}時間 が正しく記載されています`);
                            }
                        }
                    });
                }

                // 法令の引用チェック
                if (!outline.includes(edu.law) && !outline.includes('安衛則') && !outline.includes('安衛法')) {
                    results.suggestions.push({
                        type: '法令引用',
                        message: `根拠法令「${edu.law}」の引用を追加すると信頼性が向上します`,
                        law: edu.law
                    });
                } else {
                    results.passed.push('法令の引用が含まれています');
                }

                // 罰則の記載チェック
                if (outline.includes('罰則') || outline.includes('罰金') || outline.includes('懲役')) {
                    results.passed.push('罰則に関する記載があります');
                } else {
                    results.suggestions.push({
                        type: '罰則情報',
                        message: `罰則情報を追加すると説得力が増します：「${edu.penalty}」`,
                        law: '安衛法第119条'
                    });
                }

                // よくある誤解のチェック
                if (edu.commonMistakes) {
                    results.legalRefs.push({
                        title: 'よくある誤解（記事で言及推奨）',
                        items: edu.commonMistakes
                    });
                }

                // 実技の記載チェック
                if (edu.practicalRequired) {
                    if (!outline.includes('実技') && !outline.includes('対面')) {
                        results.warnings.push({
                            type: '実技情報',
                            message: `${edu.shortName}は実技が必須です。実技に関する記載を追加してください`,
                            correct: edu.practicalNote,
                            law: edu.law
                        });
                    } else {
                        results.passed.push('実技に関する記載があります');
                    }
                }

                // 対象者の記載チェック
                if (edu.targetPerson && !outline.includes('対象')) {
                    results.suggestions.push({
                        type: '対象者',
                        message: `対象者を明記すると読者に親切です：「${edu.targetPerson}」`
                    });
                }

                // 法令リファレンス情報を追加
                results.legalRefs.push({
                    title: `${edu.shortName} - 正確な法令情報`,
                    items: [
                        `正式名称：${edu.officialName}`,
                        `根拠法令：${edu.law}`,
                        `講習時間：${edu.totalHours}時間`,
                        `対象者：${edu.targetPerson}`,
                        `有効期限：${edu.validityPeriod}`,
                        `オンライン受講：${edu.onlineAvailable ? '学科は可能' : '不可'}`,
                        `実技：${edu.practicalRequired ? edu.practicalNote : '不要'}`
                    ]
                });
            }

            // 職長教育のチェック
            if (detectedEduKey && LEGAL_REFERENCE.foremanEducation[detectedEduKey]) {
                const edu = LEGAL_REFERENCE.foremanEducation[detectedEduKey];

                const hoursMatch = outline.match(/(\d+)\s*時間/g);
                if (hoursMatch) {
                    hoursMatch.forEach(match => {
                        const hours = parseInt(match);
                        if (hours === 12 || hours === 14) {
                            if (detectedEduKey === '職長・安全衛生責任者' && hours === 12) {
                                results.warnings.push({
                                    type: '講習時間',
                                    message: '建設業の職長・安全衛生責任者教育は14時間です（12時間は製造業等）',
                                    correct: '14時間',
                                    law: edu.law
                                });
                            } else {
                                results.passed.push('講習時間が正しく記載されています');
                            }
                        }
                    });
                }

                results.legalRefs.push({
                    title: `${edu.officialName} - 法令情報`,
                    items: [
                        `根拠法令：${edu.law}`,
                        `講習時間：${edu.totalHours}時間`,
                        `対象者：${edu.targetPerson}`,
                        `対象業種：${edu.targetIndustry || '全業種'}`,
                        `罰則：${edu.penalty}`
                    ]
                });
            }

            // 一般的なチェック
            // 有効期限に関する誤情報チェック
            if (outline.includes('有効期限') && (outline.includes('3年') || outline.includes('5年') || outline.includes('更新'))) {
                if (!outline.includes('有効期限なし') && !outline.includes('有効期限はありません')) {
                    results.warnings.push({
                        type: '有効期限',
                        message: '特別教育・職長教育に法定の有効期限はありません。「概ね5年ごとの再教育を推奨」が正確です',
                        correct: '法令上の有効期限なし（厚労省は概ね5年ごとの能力向上教育を推奨）',
                        law: '安衛法第60条の2'
                    });
                }
            }

            // 結果を表示
            showCodeCheckResults(results, detectedEduKey);
        }

        function showCodeCheckResults(results, eduKey) {
            const totalChecks = results.errors.length + results.warnings.length + results.suggestions.length + results.passed.length;
            const passRate = totalChecks > 0 ? Math.round((results.passed.length / totalChecks) * 100) : 0;

            let html = `
                <div class="p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-lg">法令コードチェック結果</h3>
                        <span class="text-sm ${passRate >= 80 ? 'text-green-600' : passRate >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                            適合率: ${passRate}%
                        </span>
                    </div>
                    ${eduKey ? `<p class="text-sm text-gray-600 mb-4">検出した教育種別: <strong>${eduKey}</strong></p>` : ''}
            `;

            // エラー（重大）
            if (results.errors.length > 0) {
                html += `
                    <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                        <h4 class="font-bold text-red-700 flex items-center gap-1 mb-2">
                            <span class="material-symbols-outlined icon-sm">error</span> 修正必須 (${results.errors.length}件)
                        </h4>
                        <ul class="text-sm text-red-800 space-y-2">
                            ${results.errors.map(e => `
                                <li>
                                    <strong>[${e.type}]</strong> ${e.message}
                                    ${e.correct ? `<br><span class="text-green-700">→ 正: ${e.correct}</span>` : ''}
                                    ${e.law ? `<br><span class="text-gray-500 text-xs">根拠: ${e.law}</span>` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            // 警告
            if (results.warnings.length > 0) {
                html += `
                    <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <h4 class="font-bold text-yellow-700 flex items-center gap-1 mb-2">
                            <span class="material-symbols-outlined icon-sm">warning</span> 確認推奨 (${results.warnings.length}件)
                        </h4>
                        <ul class="text-sm text-yellow-800 space-y-2">
                            ${results.warnings.map(w => `
                                <li>
                                    <strong>[${w.type}]</strong> ${w.message}
                                    ${w.correct ? `<br><span class="text-green-700">→ 正: ${w.correct}</span>` : ''}
                                    ${w.law ? `<br><span class="text-gray-500 text-xs">根拠: ${w.law}</span>` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            // 提案
            if (results.suggestions.length > 0) {
                html += `
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-bold text-blue-700 flex items-center gap-1 mb-2">
                            <span class="material-symbols-outlined icon-sm">lightbulb</span> 改善提案 (${results.suggestions.length}件)
                        </h4>
                        <ul class="text-sm text-blue-800 space-y-2">
                            ${results.suggestions.map(s => `
                                <li>
                                    <strong>[${s.type}]</strong> ${s.message}
                                    ${s.law ? `<br><span class="text-gray-500 text-xs">根拠: ${s.law}</span>` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            // OK項目
            if (results.passed.length > 0) {
                html += `
                    <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <h4 class="font-bold text-green-700 flex items-center gap-1 mb-2">
                            <span class="material-symbols-outlined icon-sm">check_circle</span> チェックOK (${results.passed.length}件)
                        </h4>
                        <ul class="text-sm text-green-700 space-y-1">
                            ${results.passed.map(p => `<li>✓ ${p}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // 法令リファレンス
            if (results.legalRefs.length > 0) {
                html += `
                    <div class="mt-6 border-t pt-4">
                        <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-1">
                            <span class="material-symbols-outlined icon-sm">gavel</span> 法令リファレンス
                        </h4>
                        ${results.legalRefs.map(ref => `
                            <details class="mb-3 bg-slate-50 rounded-lg">
                                <summary class="p-3 cursor-pointer font-medium text-slate-700 hover:bg-slate-100">${ref.title}</summary>
                                <ul class="p-3 pt-0 text-sm text-slate-600 space-y-1">
                                    ${ref.items.map(item => `<li>• ${item}</li>`).join('')}
                                </ul>
                            </details>
                        `).join('')}
                    </div>
                `;
            }

            // e-Gov法令検索リンク
            html += `
                <div class="mt-4 p-3 bg-gray-50 rounded-lg text-sm">
                    <p class="font-medium text-gray-700 mb-2">参照リンク</p>
                    <ul class="space-y-1">
                        <li><a href="https://elaws.e-gov.go.jp/document?lawid=347AC0000000057" target="_blank" class="text-indigo-600 hover:underline">→ 労働安全衛生法（e-Gov）</a></li>
                        <li><a href="https://elaws.e-gov.go.jp/document?lawid=347M50002000032" target="_blank" class="text-indigo-600 hover:underline">→ 労働安全衛生規則（e-Gov）</a></li>
                        <li><a href="https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/roudoukijun/anzen/index.html" target="_blank" class="text-indigo-600 hover:underline">→ 厚生労働省 安全衛生関係</a></li>
                    </ul>
                </div>
            `;

            html += '</div>';

            // モーダルで表示
            const modal = document.createElement('div');
            modal.id = 'code-check-modal';
            modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                        <h2 class="font-bold flex items-center gap-2">
                            <span class="material-symbols-outlined">policy</span> 法令コードチェック
                        </h2>
                        <button onclick="closeCodeCheckModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        ${html}
                    </div>
                    <div class="p-4 border-t bg-gray-50">
                        <button onclick="closeCodeCheckModal()" class="w-full bg-gray-200 hover:bg-gray-300 py-2 rounded-lg">閉じる</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeCodeCheckModal() {
            const modal = document.getElementById('code-check-modal');
            if (modal) modal.remove();
        }

        // ========== 記事構成の保存・履歴機能 ==========
        let savedStructures = [];

        function saveArticleStructure() {
            const outline = document.getElementById('article-outline').textContent;
            if (!outline || outline.trim() === '' || outline.includes('クラスターを選択')) {
                alert('保存する記事構成がありません。先に記事構成を生成してください。');
                return;
            }

            const cluster = clusters[selectedClusterIndex];
            const mainKw = cluster?.keywords[0]?.keyword || cluster?.name || '不明';
            const articleTypeEl = document.querySelector('input[name="article-type"]:checked');
            const articleType = articleTypeEl ? articleTypeEl.value : 'unknown';
            const articleTypeNames = {
                pillar: '網羅記事', howto: 'ハウツー', comparison: '比較', faq: 'FAQ',
                case: '事例', glossary: '用語解説', checklist: 'チェックリスト', news: 'ニュース'
            };

            const structure = {
                id: Date.now(),
                keyword: mainKw,
                articleType: articleType,
                articleTypeName: articleTypeNames[articleType] || articleType,
                outline: outline,
                integratedOutline: document.getElementById('article-outline-integrated')?.innerHTML || '',
                titles: Array.from(document.querySelectorAll('#title-suggestions .font-medium')).map(el => el.textContent),
                date: new Date().toLocaleString('ja-JP'),
                clusterKeywords: cluster?.keywords?.slice(0, 10).map(k => k.keyword) || []
            };

            savedStructures.unshift(structure);
            // 最大20件まで保存
            if (savedStructures.length > 20) {
                savedStructures = savedStructures.slice(0, 20);
            }
            saveSavedStructures();
            updateSavedStructuresCount();
            alert(`「${mainKw}」の記事構成を保存しました`);
        }

        function saveSavedStructures() {
            localStorage.setItem('seo-tool-saved-structures', JSON.stringify(savedStructures));
        }

        function loadSavedStructures() {
            try {
                const saved = localStorage.getItem('seo-tool-saved-structures');
                if (saved) {
                    savedStructures = JSON.parse(saved);
                    updateSavedStructuresCount();
                }
            } catch (e) {}
        }

        function updateSavedStructuresCount() {
            const countEl = document.getElementById('saved-structures-count');
            if (countEl) {
                countEl.textContent = savedStructures.length;
            }
        }

        function openSavedStructures() {
            renderSavedStructuresList();
            document.getElementById('saved-structures-modal').classList.remove('hidden');
        }

        function closeSavedStructures() {
            document.getElementById('saved-structures-modal').classList.add('hidden');
        }

        function renderSavedStructuresList() {
            const list = document.getElementById('saved-structures-list');
            if (savedStructures.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 py-8">保存された構成がありません</p>';
                return;
            }

            list.innerHTML = savedStructures.map(s => `
                <div class="border rounded-xl p-4 hover:border-indigo-300 transition-colors">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-gray-800">${s.keyword}</h3>
                            <div class="flex gap-2 mt-1">
                                <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded">${s.articleTypeName}</span>
                                <span class="text-xs text-gray-400">${s.date}</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="viewSavedStructure(${s.id})" class="text-indigo-500 hover:text-indigo-700 text-sm flex items-center gap-1">
                                <span class="material-symbols-outlined icon-sm">visibility</span> 表示
                            </button>
                            <button onclick="restoreSavedStructure(${s.id})" class="text-emerald-500 hover:text-emerald-700 text-sm flex items-center gap-1">
                                <span class="material-symbols-outlined icon-sm">restore</span> 復元
                            </button>
                            <button onclick="deleteSavedStructure(${s.id})" class="text-red-400 hover:text-red-600 text-sm flex items-center gap-1">
                                <span class="material-symbols-outlined icon-sm">delete</span>
                            </button>
                        </div>
                    </div>
                    ${s.titles && s.titles.length > 0 ? `
                        <div class="text-sm text-gray-600 mt-2">
                            <span class="font-medium">タイトル案:</span> ${s.titles[0]}
                        </div>
                    ` : ''}
                    ${s.clusterKeywords && s.clusterKeywords.length > 0 ? `
                        <div class="flex flex-wrap gap-1 mt-2">
                            ${s.clusterKeywords.slice(0, 5).map(kw => `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">${kw}</span>`).join('')}
                            ${s.clusterKeywords.length > 5 ? `<span class="text-xs text-gray-400">+${s.clusterKeywords.length - 5}</span>` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function viewSavedStructure(id) {
            const structure = savedStructures.find(s => s.id === id);
            if (!structure) return;

            // 新しいウィンドウで構成を表示
            const newWindow = window.open('', '_blank', 'width=800,height=600');
            newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${structure.keyword} - 記事構成</title>
                    <style>
                        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                        h1 { font-size: 1.5em; border-bottom: 2px solid #4f46e5; padding-bottom: 10px; }
                        .meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
                        .titles { background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                        .titles h2 { margin-top: 0; font-size: 1em; color: #0369a1; }
                        .outline { background: #f8fafc; padding: 15px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; font-size: 0.85em; }
                    </style>
                </head>
                <body>
                    <h1>${structure.keyword}</h1>
                    <div class="meta">
                        <span>記事タイプ: ${structure.articleTypeName}</span> |
                        <span>保存日時: ${structure.date}</span>
                    </div>
                    ${structure.titles && structure.titles.length > 0 ? `
                        <div class="titles">
                            <h2>タイトル案</h2>
                            <ul>${structure.titles.map(t => `<li>${t}</li>`).join('')}</ul>
                        </div>
                    ` : ''}
                    <h2>記事構成</h2>
                    <div class="outline">${structure.outline}</div>
                </body>
                </html>
            `);
            newWindow.document.close();
        }

        function restoreSavedStructure(id) {
            const structure = savedStructures.find(s => s.id === id);
            if (!structure) return;

            if (confirm(`「${structure.keyword}」の構成を復元しますか？\n現在の構成は上書きされます。`)) {
                document.getElementById('article-outline').textContent = structure.outline;
                if (structure.integratedOutline) {
                    document.getElementById('article-outline-integrated').innerHTML = structure.integratedOutline;
                }
                closeSavedStructures();
                alert('構成を復元しました');
            }
        }

        function deleteSavedStructure(id) {
            if (confirm('この構成を削除しますか？')) {
                savedStructures = savedStructures.filter(s => s.id !== id);
                saveSavedStructures();
                updateSavedStructuresCount();
                renderSavedStructuresList();
            }
        }

        function clearAllSavedStructures() {
            if (savedStructures.length === 0) {
                alert('削除する構成がありません');
                return;
            }
            if (confirm(`保存された${savedStructures.length}件の構成を全て削除しますか？\nこの操作は取り消せません。`)) {
                savedStructures = [];
                saveSavedStructures();
                updateSavedStructuresCount();
                renderSavedStructuresList();
            }
        }

        // ========== 初期化 ==========
        window.onload = function() {
            // 記事構成生成ボタンのイベントリスナー
            const generateBtn = document.getElementById('generate-article-btn');
            if (generateBtn) {
                generateBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    generateArticleDesign();
                });
            }

            // 記事アイデアメモの初期化
            loadArticleIdeas();

            // 改善メモの初期化
            loadImprovementMemos();

            // 保存した記事構成の初期化
            loadSavedStructures();

            // 改善メモ入力欄のEnterキー対応
            const improvementInput = document.getElementById('improvement-input');
            if (improvementInput) {
                improvementInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addImprovementMemo();
                    }
                });
            }

            // アイデア入力欄のEnterキー対応
            const ideaInput = document.getElementById('new-idea-input');
            if (ideaInput) {
                ideaInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addArticleIdea();
                    }
                });
            }

            // 派生記事アイデア入力欄のEnterキー対応（イベント委譲）
            document.addEventListener('keypress', function(e) {
                if (e.target.id === 'related-idea-input' && e.key === 'Enter') {
                    e.preventDefault();
                    addRelatedIdea();
                }
            });

            try {
                const saved = localStorage.getItem('seo-keyword-tool-v4');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.keywords && data.keywords.length > 0) {
                        if (confirm(`前回のデータ（${data.keywords.length}キーワード）を復元しますか？`)) {
                            keywords = data.keywords;
                            clusters = data.clusters;
                            renderAnalysisResult();
                            goToStep(2);
                        }
                    }
                }
            } catch (e) {}
        };
    </script>
</body>
</html>
